---
phase: 04-guardrails-export
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - apps/web/lib/apikey.ts
  - apps/web/lib/api.ts
  - apps/web/components/ratelimit/UsageCounter.tsx
  - apps/web/components/ratelimit/ApiKeyModal.tsx
  - apps/web/components/ratelimit/CachedIndicator.tsx
  - apps/web/app/app/page.tsx
  - apps/web/components/landing/HeroSection.tsx
  - packages/shared-types/src/index.ts
autonomous: true
requirements:
  - RATE-01

must_haves:
  truths:
    - "Authenticated user sees persistent usage counter showing 'N of M generations used today'"
    - "When rate limit is hit, modal appears prompting user to enter their own OpenAI API key"
    - "User's API key stored in localStorage only, sent via X-OpenAI-Key header per request"
    - "When user has their own API key set, rate limit is bypassed (unlimited generations)"
    - "429 response from backend shows toast with retry time instead of blank error"
    - "Cached results show 'Cached -- scraped N min ago' indicator with refresh button"
    - "Force refresh bypasses cache but counts against rate limit"
  artifacts:
    - path: "apps/web/lib/apikey.ts"
      provides: "localStorage CRUD for user OpenAI API key"
      exports: ["getUserApiKey", "setUserApiKey", "clearUserApiKey"]
    - path: "apps/web/components/ratelimit/UsageCounter.tsx"
      provides: "Persistent usage counter component"
      min_lines: 20
    - path: "apps/web/components/ratelimit/ApiKeyModal.tsx"
      provides: "Modal for BYOK when rate limit hit"
      min_lines: 40
    - path: "apps/web/components/ratelimit/CachedIndicator.tsx"
      provides: "Cache hit indicator with refresh button"
      min_lines: 15
  key_links:
    - from: "apps/web/app/app/page.tsx"
      to: "apps/web/components/ratelimit/UsageCounter.tsx"
      via: "Rendered persistently in app layout, fetches /api/usage"
      pattern: "UsageCounter"
    - from: "apps/web/app/app/page.tsx"
      to: "apps/web/components/ratelimit/ApiKeyModal.tsx"
      via: "Shown when 429 error caught in handleSubmit"
      pattern: "ApiKeyModal"
    - from: "apps/web/lib/api.ts"
      to: "apps/web/lib/apikey.ts"
      via: "getUserApiKey() called to attach X-OpenAI-Key header"
      pattern: "getUserApiKey"
---

<objective>
Frontend rate limiting UX: usage counter, API key modal (BYOK), 429 toast handling, cached result indicator, and refresh button.

Purpose: Give users visibility into their remaining daily generations (CONTEXT.md: "persistent usage counter always visible"), provide a conversion-moment API key modal when they hit their limit, handle 429 responses gracefully in the UI, and show cache transparency with refresh option.

Output: UsageCounter, ApiKeyModal, CachedIndicator components wired into AppPage and HeroSection.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-guardrails-export/04-RESEARCH.md
@.planning/phases/04-guardrails-export/04-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts from Plan 01 output + existing codebase. -->

From Plan 01 — GET /api/usage response:
```json
{"used": 2, "limit": 3, "reset": 1709078400}
```

From Plan 01 — 429 response from /api/generate:
```json
{
  "error": "rate_limited",
  "retry_after": 3600,
  "message": "Daily limit reached"
}
// Headers: Retry-After: 3600

From Plan 01 — GenerateMeta (updated):
```json
{
  "session_id": "uuid",
  "token_count": 1234,
  "source_type": "url",
  "processing_ms": 4500,
  "cache_hit": true,
  "cache_age_seconds": 1380
}
```

From apps/web/lib/api.ts:
```typescript
export class GraphAPIError extends Error {
  constructor(public readonly status: number, public readonly detail: APIError) {}
  get isScrapeFailure(): boolean
}

export async function generateGraph(
  input: string,
  signal: AbortSignal,
  getToken?: (() => Promise<string | null>) | null,
): Promise<GenerateResponse>
```

From apps/web/app/app/page.tsx:
```typescript
// State: status, graph, selectedNodeId, inputCollapsed, lastInput
// handleSubmit(input, isUrl) — calls generateGraph, handles errors
// handleCancel — aborts controller
// handleExpand — resets to idle
```

From packages/shared-types/src/index.ts:
```typescript
export interface GenerateMeta {
  session_id: string
  token_count: number
  source_type: "url" | "text"
  processing_ms: number
  cache_hit: boolean            // Added in Plan 01
  cache_age_seconds: number | null  // Added in Plan 01
}
export interface GenerateResponse {
  graph: VCGraph
  meta: GenerateMeta
}
export interface APIError {
  error: string
  message: string
}
```

From apps/web/components/landing/HeroSection.tsx:
```typescript
// Uses fetch('/api/generate') directly (not generateGraph from lib/api.ts)
// Trial gate: isTrialUsed() / markTrialUsed()
// States: input, isLoading, graph, error, showTrialModal, trialBlocked
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: BYOK localStorage module + ApiKeyModal + UsageCounter + CachedIndicator components</name>
  <files>
    apps/web/lib/apikey.ts
    apps/web/components/ratelimit/UsageCounter.tsx
    apps/web/components/ratelimit/ApiKeyModal.tsx
    apps/web/components/ratelimit/CachedIndicator.tsx
  </files>
  <action>
    **1. Create BYOK localStorage module (apps/web/lib/apikey.ts):**
    ```typescript
    const APIKEY_STORAGE_KEY = 'graphvc_openai_api_key'

    export function getUserApiKey(): string | null {
      if (typeof window === 'undefined') return null
      return localStorage.getItem(APIKEY_STORAGE_KEY)
    }

    export function setUserApiKey(key: string): void {
      localStorage.setItem(APIKEY_STORAGE_KEY, key)
    }

    export function clearUserApiKey(): void {
      localStorage.removeItem(APIKEY_STORAGE_KEY)
    }
    ```
    SSR-safe with `typeof window === 'undefined'` guard (established pattern from lib/trial.ts).

    **2. Create UsageCounter component (apps/web/components/ratelimit/UsageCounter.tsx):**
    - `'use client'` component.
    - Fetches `GET /api/usage` on mount and after each successful generation (parent passes a `refreshKey` counter).
    - Accepts props: `getToken: () => Promise<string | null>`, `refreshKey?: number`.
    - Displays: "N of M generations used today" (CONTEXT.md locked decision).
    - When user has API key set (check `getUserApiKey()`), show "Unlimited (using your API key)" with a small "clear" link.
    - Styling: small, subtle text — `text-xs text-gray-500` — positioned by parent.
    - Handle loading/error states gracefully (show nothing while loading, show counter once loaded).
    - Include "Resets at midnight UTC" tooltip or subtle note.

    **3. Create ApiKeyModal component (apps/web/components/ratelimit/ApiKeyModal.tsx):**
    - `'use client'` component.
    - Props: `onDismiss: () => void`, `onKeySet: () => void`.
    - Full-screen overlay (same pattern as TrialModal in components/auth/TrialModal.tsx).
    - Content: "You've used all your free generations today" heading, input field for OpenAI API key, "Save Key" button, "Cancel" link.
    - CONTEXT.md: "API key modal should appear when the user hits their limit -- not as a settings page. It's a conversion moment."
    - On save: validate key format starts with "sk-" (basic client-side sanity check), call `setUserApiKey(key)`, call `onKeySet()`.
    - Security note: small text below input explaining "Your key is stored only in your browser and never sent to our servers for storage."
    - Option to clear key: if key already set, show "Current key: sk-...xxxx" with "Remove" button that calls `clearUserApiKey()`.
    - Styling: dark modal matching app theme — `bg-gray-900 border border-gray-700 rounded-2xl`.

    **4. Create CachedIndicator component (apps/web/components/ratelimit/CachedIndicator.tsx):**
    - `'use client'` component.
    - Props: `cacheAgeSeconds: number | null`, `onRefresh: () => void`.
    - Only renders when `cacheAgeSeconds` is not null.
    - Displays: "Cached -- scraped N min ago" (CONTEXT.md locked decision).
    - Format: if < 60 seconds, show "Cached -- scraped just now". If >= 60, show minutes (rounded).
    - Includes a refresh/reload icon button that calls `onRefresh()`.
    - Styling: small inline badge — `text-xs text-amber-400/80 bg-amber-900/20 border border-amber-800/30 rounded-full px-2 py-0.5`.
  </action>
  <verify>
    <automated>cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - apikey.ts exports getUserApiKey, setUserApiKey, clearUserApiKey with SSR guard
    - UsageCounter fetches /api/usage and displays "N of M generations used today"
    - UsageCounter shows "Unlimited" when user has BYOK key set
    - ApiKeyModal validates sk- prefix, stores in localStorage, never persists server-side
    - CachedIndicator shows cache age with refresh button
    - All components use dark theme styling consistent with app
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire 429 handling, BYOK header, usage counter, cached indicator into AppPage and HeroSection</name>
  <files>
    apps/web/lib/api.ts
    apps/web/app/app/page.tsx
    apps/web/components/landing/HeroSection.tsx
    packages/shared-types/src/index.ts
  </files>
  <action>
    **1. Update api.ts to handle 429 and send BYOK header (apps/web/lib/api.ts):**

    Import: `import { getUserApiKey } from '@/lib/apikey'`

    In `generateGraph()`, add the BYOK header:
    ```typescript
    const userKey = getUserApiKey()
    const response = await fetch('/api/generate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
        ...(userKey ? { 'X-OpenAI-Key': userKey } : {}),
      },
      body: JSON.stringify({ input }),
      signal,
    })
    ```

    Add `force_refresh` support — add optional parameter to `generateGraph`:
    ```typescript
    export async function generateGraph(
      input: string,
      signal: AbortSignal,
      getToken?: (() => Promise<string | null>) | null,
      options?: { forceRefresh?: boolean },
    ): Promise<GenerateResponse> {
    ```
    Update body: `JSON.stringify({ input, force_refresh: options?.forceRefresh ?? false })`

    Add specific 429 handling before the generic error path:
    ```typescript
    if (response.status === 429) {
      const retryAfter = response.headers.get('Retry-After')
      let detail: APIError
      try { detail = await response.json() } catch { detail = { error: 'rate_limited', message: 'Daily limit reached' } }
      throw new GraphAPIError(429, {
        ...detail,
        retry_after: retryAfter ? parseInt(retryAfter) : undefined,
      } as APIError & { retry_after?: number })
    }
    ```

    Add `isRateLimited` getter to `GraphAPIError`:
    ```typescript
    get isRateLimited(): boolean {
      return this.status === 429
    }
    ```

    **2. Wire into AppPage (apps/web/app/app/page.tsx):**

    Add imports:
    ```typescript
    import UsageCounter from '@/components/ratelimit/UsageCounter'
    import ApiKeyModal from '@/components/ratelimit/ApiKeyModal'
    import CachedIndicator from '@/components/ratelimit/CachedIndicator'
    ```

    Add state:
    ```typescript
    const [showApiKeyModal, setShowApiKeyModal] = useState(false)
    const [usageRefreshKey, setUsageRefreshKey] = useState(0)
    const [lastMeta, setLastMeta] = useState<GenerateMeta | null>(null)
    ```

    Import `GenerateMeta` from `@graphvc/shared-types`.

    In `handleSubmit` success branch, after `setGraph(data.graph)`:
    ```typescript
    setLastMeta(data.meta)
    setUsageRefreshKey(k => k + 1)  // Trigger usage counter refresh
    ```

    In `handleSubmit` error branch, add 429 handling:
    ```typescript
    if (err instanceof GraphAPIError) {
      if (err.isRateLimited) {
        // CONTEXT.md: modal appears prompting user to enter their own OpenAI API key
        setShowApiKeyModal(true)
        toast.error('Daily generation limit reached')
      } else if (err.isScrapeFailure) {
        toast.error("Couldn't read that URL — try pasting the text instead")
      } else {
        toast.error(err.message ?? 'Something went wrong')
      }
    }
    ```

    Add handleForceRefresh callback:
    ```typescript
    const handleForceRefresh = useCallback(async () => {
      if (!lastInput) return
      handleSubmit(lastInput.value, lastInput.isUrl)  // Will need to pass forceRefresh option
    }, [lastInput, handleSubmit])
    ```

    Actually, to pass `forceRefresh`, update `handleSubmit` to accept an optional options parameter or create a separate handler. Simplest: add a `forceRefreshRef` that handleForceRefresh sets before calling handleSubmit. Or cleaner: modify handleSubmit to accept `options?: { forceRefresh?: boolean }` and pass it through to generateGraph.

    Add ApiKeyModal handler:
    ```typescript
    function handleApiKeySet() {
      setShowApiKeyModal(false)
      setUsageRefreshKey(k => k + 1)
      toast.success('API key saved — you now have unlimited generations')
    }
    ```

    **Render UsageCounter** — positioned below the InputCard, always visible:
    ```tsx
    <UsageCounter getToken={getToken} refreshKey={usageRefreshKey} />
    ```

    **Render CachedIndicator** — in the success state, above or next to the graph:
    ```tsx
    {lastMeta?.cache_hit && (
      <CachedIndicator
        cacheAgeSeconds={lastMeta.cache_age_seconds}
        onRefresh={handleForceRefresh}
      />
    )}
    ```

    **Render ApiKeyModal** — conditionally:
    ```tsx
    {showApiKeyModal && (
      <ApiKeyModal
        onDismiss={() => setShowApiKeyModal(false)}
        onKeySet={handleApiKeySet}
      />
    )}
    ```

    In `handleExpand` (reset), also clear `setLastMeta(null)`.

    **3. Update HeroSection 429 handling (apps/web/components/landing/HeroSection.tsx):**

    The HeroSection uses direct `fetch('/api/generate')` (not the `generateGraph` helper). In its `handleTry` function:

    Add 429 check after `if (!res.ok)`:
    ```typescript
    if (res.status === 429) {
      // Anonymous user hit rate limit — same as trial used, show sign-up modal
      setShowTrialModal(true)
      return
    }
    ```

    This is appropriate because anonymous users on the landing page have a 1/day limit. When they hit it, showing the sign-up modal is the correct conversion path (they already have a trial modal for the localStorage-based check, this adds the server-side 429 check as a backup).

    **4. Verify shared-types already has cache_hit and cache_age_seconds:**
    Plan 01 Task 2 adds these to the backend schema. Verify `packages/shared-types/src/index.ts` `GenerateMeta` interface includes them. If not already added by Plan 01, add them:
    ```typescript
    export interface GenerateMeta {
      session_id: string
      token_count: number
      source_type: "url" | "text"
      processing_ms: number
      cache_hit: boolean
      cache_age_seconds: number | null
    }
    ```
  </action>
  <verify>
    <automated>cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - api.ts sends X-OpenAI-Key header when BYOK key is set
    - api.ts supports force_refresh option in generateGraph
    - api.ts handles 429 with GraphAPIError.isRateLimited getter
    - AppPage shows UsageCounter persistently
    - AppPage shows ApiKeyModal on 429 error
    - AppPage shows CachedIndicator with refresh button when cache_hit is true
    - AppPage refreshes usage counter after each generation
    - HeroSection handles 429 by showing sign-up trial modal
    - shared-types GenerateMeta includes cache_hit and cache_age_seconds
    - All TypeScript compiles clean
  </done>
</task>

</tasks>

<verification>
1. `cd apps/web && npx tsc --noEmit` — zero TypeScript errors
2. `pnpm turbo typecheck` — monorepo-wide typecheck passes
3. grep -r "X-OpenAI-Key" apps/web/lib/api.ts — header is conditionally attached
4. grep -r "getUserApiKey" apps/web/lib/api.ts — BYOK integration present
5. grep -r "UsageCounter" apps/web/app/app/page.tsx — counter is rendered
6. grep -r "ApiKeyModal" apps/web/app/app/page.tsx — modal is wired to 429
7. grep -r "CachedIndicator" apps/web/app/app/page.tsx — cache indicator wired
</verification>

<success_criteria>
- UsageCounter visible showing "N of M generations used today", refreshes after each generation
- ApiKeyModal appears on 429, stores key in localStorage, key sent as X-OpenAI-Key header
- BYOK users see "Unlimited" in usage counter, bypass rate limit
- 429 error shows toast "Daily generation limit reached" + opens modal
- Cached results show "Cached -- scraped N min ago" with refresh button
- Force refresh sends force_refresh: true to API, bypasses cache
- HeroSection handles 429 by showing trial/sign-up modal
- No user API key logged or persisted server-side
</success_criteria>

<output>
After completion, create `.planning/phases/04-guardrails-export/04-03-SUMMARY.md`
</output>
