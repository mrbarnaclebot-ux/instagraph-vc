---
phase: 01-backend-foundation
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/components/input/InputCard.tsx
  - apps/web/components/landing/HeroSection.tsx
  - apps/web/lib/api.ts
autonomous: true
gap_closure: true
requirements: [AI-04, FE-05]

must_haves:
  truths:
    - "Text tab shows live character counter (e.g. 76/200) and submit button is disabled when text < 200 chars"
    - "Landing page textarea shows live character counter and submit is disabled when text < 200 chars"
    - "When backend returns 503, user sees friendly message about service warming up instead of 'HTTP 503'"
  artifacts:
    - path: "apps/web/components/input/InputCard.tsx"
      provides: "Client-side 200-char minimum validation with live counter on text tab"
      contains: "MIN_TEXT_LENGTH"
    - path: "apps/web/components/landing/HeroSection.tsx"
      provides: "Client-side 200-char minimum validation with live counter on landing textarea"
      contains: "MIN_TEXT_LENGTH"
    - path: "apps/web/lib/api.ts"
      provides: "Friendly 503 error message for Render cold starts"
      contains: "warming up"
  key_links:
    - from: "apps/web/components/input/InputCard.tsx"
      to: "submit button disabled state"
      via: "textInput.length < MIN_TEXT_LENGTH when mode is text"
      pattern: "disabled.*MIN_TEXT_LENGTH"
    - from: "apps/web/components/landing/HeroSection.tsx"
      to: "submit button disabled state"
      via: "input.length < MIN_TEXT_LENGTH"
      pattern: "disabled.*MIN_TEXT_LENGTH"
    - from: "apps/web/lib/api.ts"
      to: "GraphAPIError message"
      via: "503 status check in error parsing"
      pattern: "503.*warming"
---

<objective>
Close 2 UAT gaps from Phase 01 user acceptance testing:

1. **Gap 1 (Test 3 - API error 400):** Users submit short text (<200 chars) because the frontend has no client-side length validation. Backend correctly rejects with 400, but UX should prevent the submission entirely.

2. **Gap 2 (Test 4 - API error 503):** Render free-tier cold starts return 503 before FastAPI boots. Frontend shows unhelpful "HTTP 503". Additionally, client-side validation would prevent short text from ever hitting the sleeping backend.

Purpose: Both gaps share the same root fix (client-side min-length validation) plus a targeted 503 error message improvement.
Output: Updated InputCard.tsx, HeroSection.tsx, and api.ts with validation and friendly error handling.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/debug/api-400-graph-generation.md
@.planning/debug/short-text-503-error.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From apps/web/components/input/InputCard.tsx:
```typescript
interface InputCardProps {
  collapsed: boolean
  disabled: boolean
  onSubmit: (input: string, isUrl: boolean) => void
  onExpand: () => void
}
// State: mode ('url' | 'text'), urlInput, textInput
// Submit guard: !currentInput.trim() || disabled
// URL tab: <input type="url">
// Text tab: <textarea rows={5}>
// Submit button: disabled={disabled || !currentInput.trim()}
```

From apps/web/components/landing/HeroSection.tsx:
```typescript
// State: input (string), isLoading, graph, error, showTrialModal, trialBlocked
// Submit guard: !input.trim() || isLoading || trialBlocked
// Single textarea (rows={4}) for URL or text
// Submit button: disabled={!input.trim() || isLoading || trialBlocked}
// Error display: red box below form, not toast
```

From apps/web/lib/api.ts:
```typescript
export class GraphAPIError extends Error {
  constructor(public readonly status: number, public readonly detail: APIError)
  get isScrapeFailure(): boolean
}
// Error parsing (lines 43-50):
//   let detail: APIError = { error: 'unknown_error', message: `HTTP ${response.status}` }
//   try { detail = await response.json() } catch { /* non-JSON body */ }
//   throw new GraphAPIError(response.status, detail)
```

From packages/shared-types/src/index.ts:
```typescript
export interface APIError {
  error: string
  message: string
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add client-side 200-char minimum validation with character counter to InputCard and HeroSection</name>
  <files>
    apps/web/components/input/InputCard.tsx
    apps/web/components/landing/HeroSection.tsx
  </files>
  <action>
**InputCard.tsx changes:**

1. Add a constant `const MIN_TEXT_LENGTH = 200` at the top of the file (below imports).

2. Compute a derived value for whether text-mode submission is blocked by length:
   ```typescript
   const textTooShort = mode === 'text' && textInput.trim().length < MIN_TEXT_LENGTH
   ```

3. Update the submit button's `disabled` prop to include the length check:
   ```typescript
   disabled={disabled || !currentInput.trim() || textTooShort}
   ```

4. Add a character counter below the textarea (inside the `<Tabs.Content value="text">` block, after the `<textarea>`). Style it as a small helper text:
   ```tsx
   <div className="mt-1.5 flex justify-between text-xs">
     <span className={textInput.trim().length >= MIN_TEXT_LENGTH ? 'text-gray-500' : 'text-amber-500'}>
       {textInput.trim().length < MIN_TEXT_LENGTH
         ? `${MIN_TEXT_LENGTH - textInput.trim().length} more characters needed`
         : 'Ready to generate'}
     </span>
     <span className="text-gray-600">
       {textInput.trim().length}/{MIN_TEXT_LENGTH}
     </span>
   </div>
   ```

5. Do NOT add any validation to the URL tab -- URLs bypass the backend text length check and have their own content-yield validation in scrape_url().

**HeroSection.tsx changes:**

1. Add `const MIN_TEXT_LENGTH = 200` at the top (below imports).

2. Detect if the input looks like a URL (starts with "http://" or "https://"). URLs should bypass the min-length validation since the backend treats them differently:
   ```typescript
   const looksLikeUrl = input.trim().startsWith('http://') || input.trim().startsWith('https://')
   const textTooShort = !looksLikeUrl && input.trim().length < MIN_TEXT_LENGTH && input.trim().length > 0
   ```

3. Update the submit button's `disabled` prop:
   ```typescript
   disabled={!input.trim() || isLoading || trialBlocked || textTooShort}
   ```

4. Add a character counter below the textarea (after the closing `</div>` of the `<div className="relative">` wrapper), only shown when the input is non-empty and not a URL:
   ```tsx
   {input.trim().length > 0 && !looksLikeUrl && (
     <div className="flex justify-between text-xs">
       <span className={input.trim().length >= MIN_TEXT_LENGTH ? 'text-gray-500' : 'text-amber-400/80'}>
         {input.trim().length < MIN_TEXT_LENGTH
           ? `${MIN_TEXT_LENGTH - input.trim().length} more characters needed`
           : 'Ready to generate'}
       </span>
       <span className="text-gray-600">
         {input.trim().length}/{MIN_TEXT_LENGTH}
       </span>
     </div>
   )}
   ```

5. Place this counter inside the `<form>` element, between the textarea wrapper div and the submit button.
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && pnpm --filter web exec tsc --noEmit</automated>
  </verify>
  <done>
    - InputCard text tab shows "{N} more characters needed" counter below textarea when text < 200 chars
    - InputCard submit button is disabled when in text mode with < 200 chars
    - InputCard URL tab has NO character counter or length validation
    - HeroSection textarea shows character counter when non-empty text (not URL) is entered
    - HeroSection submit button is disabled when text < 200 chars (but not for URLs)
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add friendly 503 error message for Render cold starts in api.ts and HeroSection</name>
  <files>
    apps/web/lib/api.ts
    apps/web/components/landing/HeroSection.tsx
  </files>
  <action>
**api.ts changes:**

1. In the error handling block (lines 43-50), after the try/catch that attempts to parse JSON from the error response, add a 503-specific friendly message. Replace the default detail construction with:
   ```typescript
   let detail: APIError = { error: 'unknown_error', message: `HTTP ${response.status}` }
   try {
     detail = await response.json()
   } catch {
     // non-JSON error body — keep default
   }
   // Friendly message for 503 (Render free-tier cold start returns HTML, not JSON)
   if (response.status === 503 && detail.message === 'HTTP 503') {
     detail = {
       error: 'service_unavailable',
       message: 'Service is warming up — please wait a moment and try again',
     }
   }
   throw new GraphAPIError(response.status, detail)
   ```

   The condition `detail.message === 'HTTP 503'` ensures we only override the generic fallback message, not a real 503 from the application (which would have parsed as JSON with a proper message like "OpenAI service error").

**HeroSection.tsx changes:**

1. In the `handleTry` catch block for `!res.ok` (lines 55-58), add a 503-specific message. Update:
   ```typescript
   if (!res.ok) {
     const data = await res.json().catch(() => ({}))
     if (res.status === 503 && !data.message) {
       setError('Service is warming up — please wait a moment and try again.')
     } else {
       setError(data.message ?? 'Something went wrong. Try again.')
     }
     return
   }
   ```

   This handles the HeroSection's direct fetch (which does not use the api.ts client) separately.
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && pnpm --filter web exec tsc --noEmit</automated>
  </verify>
  <done>
    - api.ts converts generic "HTTP 503" into "Service is warming up -- please wait a moment and try again"
    - api.ts preserves real 503 messages from application code (e.g., OpenAI failures)
    - HeroSection shows friendly warming-up message on 503 instead of generic error
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter web exec tsc --noEmit` passes with zero errors
2. Grep confirms MIN_TEXT_LENGTH appears in both InputCard.tsx and HeroSection.tsx
3. Grep confirms "warming up" appears in both api.ts and HeroSection.tsx
4. No changes to URL-mode validation in InputCard (URL tab unaffected)
</verification>

<success_criteria>
- Text inputs shorter than 200 characters cannot be submitted from either /app or the landing page
- Character counter guides users toward the minimum length
- 503 errors from Render cold starts show a friendly "warming up" message
- URL inputs are unaffected by the min-length validation
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-06-SUMMARY.md`
</output>
