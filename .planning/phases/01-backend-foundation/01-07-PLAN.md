---
phase: 01-backend-foundation
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/tests/test_scraper.py
  - apps/api/tests/test_generate.py
autonomous: true
gap_closure: true
requirements: [INFRA-01, INFRA-02, SEC-01, SEC-02, SEC-03, SEC-04, AI-01, AI-02, AI-03, AI-04]

must_haves:
  truths:
    - "All 29 automated tests pass green (0 failures)"
    - "test_returns_extracted_text verifies scrape_url returns extracted text for a valid HTML page"
    - "test_uses_allow_redirects_false verifies requests.get is called with allow_redirects=False"
    - "test_generate_url_input_scrapes_and_extracts verifies end-to-end URL input returns a graph with source_type url"
  artifacts:
    - path: "apps/api/tests/test_scraper.py"
      provides: "Fixed MagicMock response objects with Content-Type header for TestScrapeUrl"
      contains: "Content-Type"
    - path: "apps/api/tests/test_generate.py"
      provides: "Fixed MagicMock response object with Content-Type header for URL input test"
      contains: "Content-Type"
  key_links:
    - from: "apps/api/tests/test_scraper.py"
      to: "apps/api/app/scraper/scraper.py"
      via: "mock_response.headers must simulate Content-Type header for content-type guard on lines 78-79"
      pattern: "Content-Type.*text/html"
    - from: "apps/api/tests/test_generate.py"
      to: "apps/api/app/scraper/scraper.py"
      via: "mock_requests_get response must also include Content-Type header"
      pattern: "Content-Type.*text/html"
---

<objective>
Close 1 verification gap from VERIFICATION.md re-verification (2026-02-27): 3 test regressions caused by a post-plan content-type guard added to scraper.py without updating test mocks.

Purpose: The content-type guard (scraper.py lines 76-83) is a correct robustness enhancement that rejects non-HTML responses before BeautifulSoup parsing. However, the MagicMock response objects in 3 tests do not set a Content-Type header, so `response.headers.get("Content-Type", "")` returns a MagicMock instead of a string containing "text/html", causing the guard to fire incorrectly. Additionally, `test_rejects_low_content_page` passes by coincidence (same exception type) but its mock should also be fixed for correctness.

Output: All 29 tests pass. 4 test mocks updated with realistic Content-Type headers.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-foundation/01-VERIFICATION.md

<interfaces>
<!-- Key code the executor needs to understand the fix. -->

From apps/api/app/scraper/scraper.py (lines 76-83 -- the content-type guard causing failures):
```python
content_type = response.headers.get("Content-Type", "")
if "text/html" not in content_type and "text/plain" not in content_type:
    raise HTTPException(status_code=400, detail={
        "error": "scrape_failed",
        "message": "Couldn't read that URL â€” try pasting the text instead",
    })
```

From apps/api/tests/test_scraper.py (current failing mock pattern -- no Content-Type):
```python
mock_response = MagicMock()
mock_response.is_redirect = False
mock_response.text = "<html>..."
mock_response.raise_for_status.return_value = None
# MISSING: mock_response.headers is a MagicMock, so
# response.headers.get("Content-Type", "") returns a MagicMock, not "text/html"
```

Fix pattern (set headers as a real dict so .get() works naturally):
```python
mock_response.headers = {"Content-Type": "text/html; charset=utf-8"}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Content-Type headers on MagicMock response objects in test_scraper.py and test_generate.py</name>
  <files>
    apps/api/tests/test_scraper.py
    apps/api/tests/test_generate.py
  </files>
  <action>
**test_scraper.py -- 3 test methods need mock headers added:**

1. `test_returns_extracted_text` (line 44 area): After `mock_response = MagicMock()`, add:
   ```python
   mock_response.headers = {"Content-Type": "text/html; charset=utf-8"}
   ```
   Place it immediately after `mock_response.is_redirect = False` for consistency.

2. `test_rejects_low_content_page` (line 59 area): Same fix. This test currently passes by coincidence -- the content-type guard fires before the low-content check, but both raise HTTPException(400, "scrape_failed"). The test assertions still match, but the test is not actually testing the low-content detection path. Adding the Content-Type header makes the test correctly exercise the MIN_CONTENT_CHARS < 500 check instead of the content-type guard.
   ```python
   mock_response.headers = {"Content-Type": "text/html; charset=utf-8"}
   ```

3. `test_uses_allow_redirects_false` (line 73 area): Same fix.
   ```python
   mock_response.headers = {"Content-Type": "text/html; charset=utf-8"}
   ```

Note: `test_timeout_returns_503` does NOT need this fix because `requests.Timeout` is raised before the response object is used.

**test_generate.py -- 1 test method needs mock headers added:**

4. `test_generate_url_input_scrapes_and_extracts` (line 145 area): After `mock_response = MagicMock()`, add:
   ```python
   mock_response.headers = {"Content-Type": "text/html; charset=utf-8"}
   ```
   Place it immediately after `mock_response.is_redirect = False`.

**Why `headers = {"Content-Type": ...}` instead of `mock_response.headers.get.return_value`:**
Setting `headers` to a real dict means `.get("Content-Type", "")` works via dict's native `.get()` method, which is more realistic and won't break if the code switches to bracket access `response.headers["Content-Type"]` in the future.
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/api" && uv run python -m pytest tests/test_scraper.py tests/test_generate.py -v</automated>
  </verify>
  <done>
    - All 13 tests in test_scraper.py and test_generate.py pass (0 failures)
    - The 3 previously failing tests now pass: test_returns_extracted_text, test_uses_allow_redirects_false, test_generate_url_input_scrapes_and_extracts
    - test_rejects_low_content_page correctly exercises the MIN_CONTENT_CHARS path (not the content-type guard)
    - Full suite: `uv run python -m pytest` shows 29/29 passed
  </done>
</task>

</tasks>

<verification>
1. `uv run python -m pytest tests/ -v` from `apps/api/` shows 29 passed, 0 failed
2. Grep confirms `Content-Type` appears in all 4 mock setups: test_returns_extracted_text, test_rejects_low_content_page, test_uses_allow_redirects_false, test_generate_url_input_scrapes_and_extracts
3. No other test files modified -- only the 2 files with stale mocks
</verification>

<success_criteria>
- 29/29 automated tests pass green with zero failures
- The 3 regression tests from VERIFICATION.md are resolved
- test_rejects_low_content_page exercises the correct code path (content-yield check, not content-type guard)
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-07-SUMMARY.md`
</output>
