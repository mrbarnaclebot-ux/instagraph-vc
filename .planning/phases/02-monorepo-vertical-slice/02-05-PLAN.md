---
phase: 02-monorepo-vertical-slice
plan: 05
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/deploy-preview.yml
  - .github/workflows/deploy-production.yml
autonomous: true
requirements: [INFRA-03]

user_setup:
  - service: vercel
    why: "Frontend deployment — preview on PR, production on main merge"
    env_vars:
      - name: VERCEL_TOKEN
        source: "Vercel Dashboard → Settings → Tokens → Create Token"
      - name: VERCEL_ORG_ID
        source: "Run `vercel link` in apps/web — outputs .vercel/project.json with orgId"
      - name: VERCEL_PROJECT_ID
        source: "Run `vercel link` in apps/web — outputs .vercel/project.json with projectId"
    dashboard_config:
      - task: "Set Root Directory to apps/web"
        location: "Vercel Dashboard → Project Settings → General → Root Directory"
      - task: "Set Ignored Build Step command"
        location: "Vercel Dashboard → Project Settings → Git → Ignored Build Step: npx turbo-ignore --fallback=HEAD^1"
  - service: railway
    why: "Backend deployment — deploys to Railway on merge to main"
    env_vars:
      - name: RAILWAY_TOKEN
        source: "Railway Dashboard → Account Settings → Tokens → New Token"
    dashboard_config:
      - task: "Create Railway project and link to apps/api service"
        location: "Railway Dashboard → New Project → Deploy from GitHub → select instagraph-vc"

must_haves:
  truths:
    - "Every PR triggers the CI workflow running typecheck, lint, and Python tests"
    - "Every PR triggers a Vercel preview deployment"
    - "Merge to main triggers Railway backend deployment"
    - "GitHub Actions workflows are syntactically valid YAML"
    - "Python tests in CI use uv (not pip install requirements.txt)"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI pipeline: pnpm typecheck, lint, and Python pytest on every PR and push to main"
      min_lines: 40
    - path: ".github/workflows/deploy-preview.yml"
      provides: "Vercel preview deployment on every PR"
      min_lines: 30
    - path: ".github/workflows/deploy-production.yml"
      provides: "Railway production deployment on merge to main"
      min_lines: 20
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "apps/api"
      via: "working-directory: apps/api for uv run pytest"
      pattern: "working-directory.*apps/api"
    - from: ".github/workflows/ci.yml"
      to: "turbo"
      via: "pnpm turbo run typecheck lint"
      pattern: "turbo run typecheck"
    - from: ".github/workflows/deploy-preview.yml"
      to: "VERCEL_TOKEN"
      via: "secrets.VERCEL_TOKEN"
      pattern: "secrets\\.VERCEL_TOKEN"
    - from: ".github/workflows/deploy-production.yml"
      to: "RAILWAY_TOKEN"
      via: "secrets.RAILWAY_TOKEN"
      pattern: "secrets\\.RAILWAY_TOKEN"
---

<objective>
Create three GitHub Actions workflows: CI (typecheck + lint + pytest on every PR), Vercel preview deploy (PR), and Railway production deploy (main merge).

Purpose: INFRA-03 requires CI/CD. This is the automation backbone that lets the solo developer merge with confidence and get automatic deployments.
Output: Three .github/workflows/ YAML files wiring up Turborepo CI and Vercel/Railway deploy pipelines.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-monorepo-vertical-slice/02-RESEARCH.md
@.planning/phases/02-monorepo-vertical-slice/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: .github/workflows/ci.yml — typecheck, lint, and Python tests on every PR</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
Check if .github/workflows/ directory already exists. If not, create it.

Create `.github/workflows/ci.yml`.

Key requirements:
- Runs on every push to main AND every pull_request
- Uses pnpm 9 (matches root package.json packageManager field)
- Uses Node 20 (LTS, compatible with Next.js 15)
- Runs `pnpm turbo run typecheck lint` for frontend CI
- Runs `uv run pytest tests/ -x` in apps/api for Python tests
- Uses `astral-sh/setup-uv@v3` action to install uv (the official GitHub Action for uv — avoids `pip install uv` bootstrap complexity)
- `fetch-depth: 2` for Turborepo change detection

Open questions from RESEARCH.md:
- Python test runner: use `astral-sh/setup-uv@v3` (official, cleaner than `pip install uv`)
- The `pnpm install --frozen-lockfile` flag should be used in CI to ensure deterministic installs

```yaml
name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ci:
    name: Typecheck, Lint, Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck and lint (Turborepo)
        run: pnpm turbo run typecheck lint

      - name: Setup uv (Python)
        uses: astral-sh/setup-uv@v3
        with:
          working-directory: apps/api

      - name: Run Python tests
        working-directory: apps/api
        run: uv run pytest tests/ -x --tb=short
```
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))" && echo "ci.yml YAML valid" && cat .github/workflows/ci.yml | grep -q "uv run pytest" && echo "pytest OK" && cat .github/workflows/ci.yml | grep -q "turbo run typecheck" && echo "turbo typecheck OK"</automated>
    <manual>Confirm: YAML is valid; pnpm 9; Node 20; astral-sh/setup-uv action used; uv run pytest in apps/api working-directory; fetch-depth: 2</manual>
  </verify>
  <done>.github/workflows/ci.yml is valid YAML that runs on push/PR; installs pnpm 9 + Node 20; runs pnpm turbo run typecheck lint; uses astral-sh/setup-uv@v3 and runs uv run pytest tests/ -x in apps/api</done>
</task>

<task type="auto">
  <name>Task 2: deploy-preview.yml + deploy-production.yml — Vercel preview and Railway production deploys</name>
  <files>
    .github/workflows/deploy-preview.yml
    .github/workflows/deploy-production.yml
  </files>
  <action>
Create `.github/workflows/deploy-preview.yml` for Vercel preview on every PR.

The Vercel deployment uses the Vercel CLI approach (not the GitHub App integration) because the GitHub App doesn't give fine-grained monorepo control. Steps: install vercel CLI globally → vercel pull (fetches project settings) → vercel build → vercel deploy --prebuilt.

IMPORTANT: `working-directory: apps/web` for vercel commands (Vercel needs to run in the Next.js app directory).

Required GitHub secrets: VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID
(These must be added to GitHub repo → Settings → Secrets and variables → Actions by the user — see user_setup frontmatter)

```yaml
name: Deploy Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    name: Deploy to Vercel Preview
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Vercel CLI
        run: pnpm add -g vercel

      - name: Pull Vercel environment info
        working-directory: apps/web
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build project
        working-directory: apps/web
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel
        working-directory: apps/web
        run: vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
```

Create `.github/workflows/deploy-production.yml` for Railway production on merge to main.

Railway CLI deploy: install @railway/cli globally → railway up --service=api (deploys the FastAPI service from apps/api).

Note on Railway timeout risk (STATE.md blocker): The Railway Hobby tier has a 30s request timeout; GPT-4o generation can exceed this. This is a known risk documented in STATE.md. The CI/CD workflow cannot fix this — it requires upgrading to Railway Pro. Add a comment in the workflow to surface this.

```yaml
name: Deploy Production

on:
  push:
    branches: [main]

jobs:
  deploy-railway:
    name: Deploy API to Railway
    runs-on: ubuntu-latest
    # NOTE: Railway Hobby tier has 30s request timeout.
    # GPT-4o + Neo4j can take 15-35s — upgrade to Railway Pro if generation times out in production.
    # See: .planning/STATE.md Blockers/Concerns
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        working-directory: apps/api
        run: railway up --service=api
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
```
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy-preview.yml'))" && echo "deploy-preview.yml YAML valid" && python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy-production.yml'))" && echo "deploy-production.yml YAML valid" && cat .github/workflows/deploy-preview.yml | grep -q "VERCEL_TOKEN" && echo "VERCEL_TOKEN OK" && cat .github/workflows/deploy-production.yml | grep -q "RAILWAY_TOKEN" && echo "RAILWAY_TOKEN OK"</automated>
    <manual>Confirm: both YAML files valid; deploy-preview uses vercel pull/build/deploy in apps/web working-directory; deploy-production uses railway up --service=api; secrets referenced correctly</manual>
  </verify>
  <done>.github/workflows/deploy-preview.yml deploys Vercel preview on PR using Vercel CLI with VERCEL_TOKEN/ORG_ID/PROJECT_ID secrets; .github/workflows/deploy-production.yml deploys Railway on main push with RAILWAY_TOKEN secret; both are valid YAML</done>
</task>

</tasks>

<verification>
1. `python3 -c "import yaml; [yaml.safe_load(open(f)) for f in ['.github/workflows/ci.yml', '.github/workflows/deploy-preview.yml', '.github/workflows/deploy-production.yml']]; print('All YAML valid')"` — all 3 valid
2. `cat .github/workflows/ci.yml | grep "astral-sh/setup-uv"` — official uv action used
3. `cat .github/workflows/deploy-preview.yml | grep "working-directory.*apps/web"` — Vercel commands scoped to apps/web
4. `cat .github/workflows/deploy-production.yml | grep "railway up"` — Railway deploy present
</verification>

<success_criteria>
- All 3 workflow files are syntactically valid YAML
- ci.yml: runs on push/PR; pnpm 9; turbo typecheck lint; uv run pytest in apps/api; fetch-depth 2
- deploy-preview.yml: triggers on PR; Vercel CLI pull/build/deploy in apps/web; uses VERCEL_TOKEN/ORG_ID/PROJECT_ID secrets
- deploy-production.yml: triggers on main push; railway up --service=api; uses RAILWAY_TOKEN
- user_setup frontmatter documents all required secrets and dashboard config steps
</success_criteria>

<output>
After completion, create `.planning/phases/02-monorepo-vertical-slice/02-05-SUMMARY.md`
</output>
