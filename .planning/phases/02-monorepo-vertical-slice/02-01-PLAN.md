---
phase: 02-monorepo-vertical-slice
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pnpm-workspace.yaml
  - turbo.json
  - package.json
  - packages/shared-types/package.json
  - packages/shared-types/src/index.ts
  - apps/web/package.json
  - apps/web/next.config.ts
  - apps/web/tsconfig.json
  - apps/web/app/layout.tsx
  - apps/web/app/page.tsx
  - docker-compose.yml
autonomous: true
requirements: [INFRA-03]

must_haves:
  truths:
    - "Running `pnpm install` from repo root resolves all workspace packages including @graphvc/shared-types"
    - "Running `pnpm dev` from repo root starts both Next.js (port 3000) and FastAPI (port 8000) via turbo"
    - "`@graphvc/shared-types` exports GraphNode, GraphEdge, VCGraph, GenerateResponse types that match apps/api/app/generate/schemas.py"
    - "Visiting http://localhost:3000 resolves (no 404/build error)"
    - "A request to http://localhost:3000/api/generate is rewritten to http://localhost:8000/api/generate"
  artifacts:
    - path: "pnpm-workspace.yaml"
      provides: "pnpm workspace definition covering apps/* and packages/*"
      contains: "packages:"
    - path: "turbo.json"
      provides: "Turborepo task pipeline (build, dev, typecheck, lint, test)"
      contains: "tasks"
    - path: "packages/shared-types/src/index.ts"
      provides: "Shared TypeScript types mirroring FastAPI schemas"
      exports: ["GraphNode", "GraphEdge", "VCGraph", "GenerateResponse", "EntityType", "RelationshipType"]
    - path: "apps/web/next.config.ts"
      provides: "Next.js config with API rewrites and transpilePackages"
      contains: "rewrites"
    - path: "apps/web/app/layout.tsx"
      provides: "Root layout with Tailwind and dark background"
      min_lines: 15
  key_links:
    - from: "apps/web/package.json"
      to: "packages/shared-types"
      via: "workspace:* dependency"
      pattern: "workspace:\\*"
    - from: "apps/web/next.config.ts"
      to: "http://localhost:8000"
      via: "rewrites destination"
      pattern: "NEXT_PUBLIC_API_URL.*localhost:8000"
    - from: "apps/web/next.config.ts"
      to: "@graphvc/shared-types"
      via: "transpilePackages array"
      pattern: "transpilePackages.*shared-types"
---

<objective>
Scaffold the Turborepo monorepo: add pnpm workspaces, turbo.json task pipeline, packages/shared-types with TypeScript types mirroring the FastAPI schemas, and a Next.js 15 skeleton at apps/web/ with API rewrites configured to proxy /api/* to the FastAPI service.

Purpose: Establish the monorepo foundation that all Phase 2 UI plans (02-02, 02-03, 02-04) depend on. Without this, no frontend code can import shared types or proxy to the backend.
Output: Working pnpm workspace, turbo dev starts both services, @graphvc/shared-types importable from apps/web.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-foundation/01-05-SUMMARY.md
@apps/api/app/generate/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Turborepo root config — pnpm workspace, turbo.json, root package.json</name>
  <files>
    pnpm-workspace.yaml
    turbo.json
    package.json
  </files>
  <action>
The repo root already has a pyproject.toml (InstaGraph fork) with no [project] table. Do NOT modify it.

Create `pnpm-workspace.yaml` at the repo root:
```yaml
packages:
  - "apps/*"
  - "packages/*"
```

Create `turbo.json` at the repo root using the `"tasks"` key (NOT "pipeline" — deprecated in Turborepo v2):
```json
{
  "$schema": "https://turborepo.dev/schema.json",
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "!.next/cache/**", "dist/**"]
    },
    "typecheck": {
      "dependsOn": ["^typecheck"]
    },
    "lint": {},
    "test": {
      "dependsOn": ["^build"]
    },
    "dev": {
      "persistent": true,
      "cache": false
    }
  }
}
```

Create or update `package.json` at the repo root (if a package.json already exists, check its contents first and update it preserving any existing fields; if it does not exist, create it fresh):
```json
{
  "name": "instagraph-vc",
  "private": true,
  "packageManager": "pnpm@9.0.0",
  "scripts": {
    "build": "turbo run build",
    "dev": "turbo run dev",
    "lint": "turbo run lint",
    "typecheck": "turbo run typecheck",
    "test": "turbo run test"
  },
  "devDependencies": {
    "turbo": "latest"
  }
}
```

Then install turbo at the root: `pnpm install` (from repo root). This bootstraps the workspace.
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && cat pnpm-workspace.yaml && cat turbo.json | python3 -c "import json,sys; d=json.load(sys.stdin); assert 'tasks' in d, 'missing tasks key'; print('turbo.json valid')"</automated>
    <manual>Confirm pnpm-workspace.yaml lists apps/* and packages/*; turbo.json uses "tasks" not "pipeline"</manual>
  </verify>
  <done>pnpm-workspace.yaml lists apps/* and packages/*; turbo.json has "tasks" key with build/dev/typecheck/lint/test; root package.json has turbo run scripts and packageManager field</done>
</task>

<task type="auto">
  <name>Task 2: packages/shared-types — TypeScript types mirroring FastAPI generate schemas</name>
  <files>
    packages/shared-types/package.json
    packages/shared-types/src/index.ts
  </files>
  <action>
Create the directory structure: `packages/shared-types/src/`

Create `packages/shared-types/package.json` using the Just-in-Time internal package strategy (no build step — Next.js Turbopack compiles TypeScript source directly):
```json
{
  "name": "@graphvc/shared-types",
  "version": "0.0.1",
  "private": true,
  "exports": {
    ".": "./src/index.ts"
  }
}
```

Create `packages/shared-types/src/index.ts` with types that exactly mirror apps/api/app/generate/schemas.py. The types MUST match the FastAPI response shape — the frontend will consume these directly from POST /api/generate:

```typescript
// Entity and relationship types — mirror apps/api/app/generate/schemas.py
export type EntityType = "Investor" | "Project" | "Round" | "Narrative" | "Person"

export type RelationshipType =
  | "LED"
  | "INVESTED_IN"
  | "CO_INVESTED"
  | "RAISED"
  | "FOUNDED"
  | "PARTNERS_AT"
  | "FOCUSES_ON"
  | "CLASSIFIED_AS"

export interface GraphNode {
  id: string
  label: string
  type: EntityType
  properties: Record<string, unknown>
}

export interface GraphEdge {
  source: string
  target: string
  relationship: RelationshipType
}

export interface VCGraph {
  nodes: GraphNode[]
  edges: GraphEdge[]
}

export interface GenerateMeta {
  session_id: string
  token_count: number
  source_type: "url" | "text"
  processing_ms: number
}

export interface GenerateResponse {
  graph: VCGraph
  meta: GenerateMeta
}

// Error response shape from FastAPI (error: str, message: str — Phase 1 API contract)
export interface APIError {
  error: string
  message: string
}
```

Note: The FastAPI GenerateResponse.graph field is typed as `dict[str, list]` in Python (returns {"nodes": [...], "edges": [...]}), which maps to `VCGraph` interface in TypeScript.
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && cat packages/shared-types/src/index.ts | grep -c "export" | xargs -I{} test {} -ge 8 && echo "shared-types exports OK"</automated>
    <manual>Confirm all 7 exports (EntityType, RelationshipType, GraphNode, GraphEdge, VCGraph, GenerateMeta, GenerateResponse) are present and match FastAPI schemas</manual>
  </verify>
  <done>packages/shared-types/src/index.ts exports EntityType, RelationshipType, GraphNode, GraphEdge, VCGraph, GenerateMeta, GenerateResponse, APIError with types matching apps/api/app/generate/schemas.py</done>
</task>

<task type="auto">
  <name>Task 3: Next.js 15 skeleton at apps/web/ with API rewrites and workspace dependency</name>
  <files>
    apps/web/package.json
    apps/web/next.config.ts
    apps/web/tsconfig.json
    apps/web/app/layout.tsx
    apps/web/app/page.tsx
    apps/web/.env.local.example
  </files>
  <action>
Create apps/web/ using create-next-app if the directory does not exist yet. From the repo root run:
```bash
pnpm dlx create-next-app@latest apps/web --typescript --tailwind --eslint --app --no-src-dir --no-import-alias --yes
```

If apps/web already exists (from a prior run), skip the scaffold step and proceed to configure files.

After scaffolding, update `apps/web/package.json`:
- Add `"@graphvc/shared-types": "workspace:*"` to dependencies (CRITICAL: must use workspace:* protocol, not a version string — otherwise pnpm looks on npm registry and fails)
- Add the following packages to dependencies: `"cytoscape": "^3.0.0"`, `"react-cytoscapejs": "^2.0.0"`, `"cytoscape-fcose": "^2.0.0"`, `"sonner": "latest"`, `"@radix-ui/react-tabs": "latest"`
- Add to devDependencies: `"@types/cytoscape": "latest"`, `"@types/react-cytoscapejs": "latest"`

Create/overwrite `apps/web/next.config.ts`:
```typescript
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  transpilePackages: ['@graphvc/shared-types'],
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: `${process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:8000'}/api/:path*`,
      },
    ]
  },
}

export default nextConfig
```

The `transpilePackages` entry is REQUIRED for the Just-in-Time shared-types package — without it Next.js bundler fails to resolve the TypeScript source of the internal package.

Create/overwrite `apps/web/app/layout.tsx`:
```tsx
import type { Metadata } from 'next'
import { Geist, Geist_Mono } from 'next/font/google'
import { Toaster } from 'sonner'
import './globals.css'

const geistSans = Geist({ subsets: ['latin'], variable: '--font-geist-sans' })
const geistMono = Geist_Mono({ subsets: ['latin'], variable: '--font-geist-mono' })

export const metadata: Metadata = {
  title: 'GraphVC — Crypto VC Relationship Maps',
  description: 'Instantly generate and explore visual maps of crypto VC relationships from any funding announcement.',
}

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" className="dark">
      <body className={`${geistSans.variable} ${geistMono.variable} antialiased bg-gray-950 text-gray-100 min-h-screen`}>
        {children}
        <Toaster richColors position="top-right" />
      </body>
    </html>
  )
}
```

Create/overwrite `apps/web/app/page.tsx` to redirect to /app:
```tsx
import { redirect } from 'next/navigation'

export default function Home() {
  redirect('/app')
}
```

Create `apps/web/app/app/` directory and a placeholder `apps/web/app/app/page.tsx` (Plan 02-04 will fill this in):
```tsx
export default function AppPage() {
  return (
    <main className="flex h-screen items-center justify-center">
      <p className="text-gray-500">Graph workspace — coming in Plan 02-04</p>
    </main>
  )
}
```

Create `apps/web/.env.local.example`:
```
# FastAPI backend URL — override in production
NEXT_PUBLIC_API_URL=http://localhost:8000
```

Run `pnpm install` from the repo root to link the workspace packages. Verify no resolution errors.
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && pnpm install 2>&1 | tail -5 && cat apps/web/next.config.ts | grep -q "transpilePackages" && cat apps/web/next.config.ts | grep -q "rewrites" && echo "next.config.ts OK" && cat apps/web/package.json | grep -q "workspace:\*" && echo "workspace:* OK"</automated>
    <manual>Confirm pnpm install completes without errors; @graphvc/shared-types is in apps/web/node_modules/@graphvc/ (symlinked); next.config.ts has both transpilePackages and rewrites</manual>
  </verify>
  <done>apps/web exists with Next.js 15 + Tailwind + App Router; package.json references @graphvc/shared-types with workspace:*; next.config.ts has transpilePackages and /api/* rewrite to localhost:8000; pnpm install succeeds from repo root</done>
</task>

</tasks>

<verification>
From repo root:
1. `pnpm install` — no errors, all packages resolve including @graphvc/shared-types
2. `cat pnpm-workspace.yaml` — shows apps/* and packages/*
3. `cat turbo.json` — shows "tasks" key (not "pipeline")
4. `cat apps/web/package.json | grep shared-types` — shows `"workspace:*"`
5. `cat apps/web/next.config.ts` — shows both `transpilePackages` and `rewrites`
6. `pnpm --filter apps/web dev` — Next.js starts on port 3000 (may fail if FastAPI not running, that is OK for this plan)
</verification>

<success_criteria>
- pnpm-workspace.yaml defines apps/* and packages/* workspaces
- turbo.json has build/dev/typecheck/lint/test tasks using "tasks" key
- @graphvc/shared-types exports all 8 TypeScript types matching FastAPI schemas exactly
- apps/web/next.config.ts rewrites /api/:path* to NEXT_PUBLIC_API_URL (defaults to localhost:8000) and transpiles shared-types
- pnpm install from repo root succeeds with zero errors
- apps/web/app/layout.tsx includes Toaster from sonner
</success_criteria>

<output>
After completion, create `.planning/phases/02-monorepo-vertical-slice/02-01-SUMMARY.md`
</output>
