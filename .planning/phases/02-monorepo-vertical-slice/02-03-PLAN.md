---
phase: 02-monorepo-vertical-slice
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/web/lib/api.ts
  - apps/web/components/input/InputCard.tsx
  - apps/web/components/input/LoadingSteps.tsx
autonomous: true
requirements: [FE-05]

must_haves:
  truths:
    - "Input card shows URL and Text tabs; URL tab shows a URL input field, Text tab shows a textarea with instructional placeholder"
    - "After graph generates, the input area collapses to a compact bar at the top"
    - "During loading: dark canvas area with centered spinner, Cancel button visible that aborts the in-flight request"
    - "Loading labels cycle sequentially: 'Fetching URL...' → 'Extracting entities...' → 'Building graph...' at ~1800ms intervals"
    - "generateGraph() function sends POST /api/generate and returns GenerateResponse; aborts via AbortSignal"
    - "On scrape failure (detail includes 'scrape'), toast shows 'Couldn't read that URL — try pasting the text instead'"
    - "On empty graph (0 nodes), toast shows 'No VC relationships found'"
    - "On generic API error, toast shows error message with retry capability"
  artifacts:
    - path: "apps/web/lib/api.ts"
      provides: "generateGraph() fetch wrapper with AbortSignal and typed errors"
      exports: ["generateGraph", "GraphAPIError"]
      min_lines: 30
    - path: "apps/web/components/input/InputCard.tsx"
      provides: "Hero-centered input card with URL/Text tabs, collapsible after graph generated"
      min_lines: 80
    - path: "apps/web/components/input/LoadingSteps.tsx"
      provides: "Sequential step labels cycling component + loading overlay with cancel button"
      min_lines: 40
  key_links:
    - from: "apps/web/lib/api.ts"
      to: "/api/generate"
      via: "fetch('/api/generate', { signal })"
      pattern: "fetch.*api/generate"
    - from: "apps/web/components/input/InputCard.tsx"
      to: "apps/web/lib/api.ts"
      via: "import generateGraph"
      pattern: "generateGraph"
    - from: "apps/web/components/input/LoadingSteps.tsx"
      to: "AbortController"
      via: "onCancel prop triggers controller.abort()"
      pattern: "onCancel"
---

<objective>
Build the API client layer, the hero input card with tab toggle and collapsible state, and the loading steps overlay with cancel support.

Purpose: This is the entry point of the user experience — the input → loading → graph flow. FE-05 requires specific toast messages and loading states. CONTEXT.md locks the interaction design precisely.
Output: lib/api.ts (typed fetch wrapper), InputCard.tsx (tab UI, collapse after generation), LoadingSteps.tsx (sequential labels + cancel).
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-monorepo-vertical-slice/02-CONTEXT.md
@.planning/phases/02-monorepo-vertical-slice/02-RESEARCH.md
@.planning/phases/02-monorepo-vertical-slice/02-01-SUMMARY.md
@packages/shared-types/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: lib/api.ts — typed generateGraph() fetch wrapper with AbortSignal</name>
  <files>
    apps/web/lib/api.ts
  </files>
  <action>
Create `apps/web/lib/api.ts`.

The `generateGraph()` function must:
- Send POST /api/generate (rewritten by next.config.ts to FastAPI — no CORS issues)
- Accept an AbortSignal so the cancel button can abort the in-flight request
- Throw a typed GraphAPIError on non-2xx responses (carries status code and API error shape)
- Return GenerateResponse on success

The AbortController cancel pattern (from RESEARCH.md):
- AbortError (name === 'AbortError') → user cancelled, re-throw without toast
- Other errors → wrap in GraphAPIError

Toast messages required by FE-05 (exact strings — non-negotiable):
- Scrape failure: "Couldn't read that URL — try pasting the text instead"
- Empty graph (0 nodes): "No VC relationships found"
- Generic error: show error.message

Note: Toast calls live in the page component (Plan 02-04), NOT in api.ts. api.ts only throws — it does not show toasts. This keeps the API layer testable.

```typescript
import type { GenerateResponse, APIError } from '@graphvc/shared-types'

export class GraphAPIError extends Error {
  constructor(
    public readonly status: number,
    public readonly detail: APIError,
  ) {
    super(detail.message ?? `API error ${status}`)
    this.name = 'GraphAPIError'
  }

  /** True if the error is a scrape failure — triggers the specific FE-05 toast */
  get isScrapeFailure(): boolean {
    return (
      this.status === 400 &&
      (this.detail.error?.includes('scrape') ||
        this.detail.message?.toLowerCase().includes('scrape') ||
        this.detail.message?.toLowerCase().includes("couldn't read"))
    )
  }
}

export async function generateGraph(
  input: string,
  signal: AbortSignal,
): Promise<GenerateResponse> {
  const response = await fetch('/api/generate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ input }),
    signal,
  })

  if (!response.ok) {
    let detail: APIError = { error: 'unknown_error', message: `HTTP ${response.status}` }
    try {
      detail = await response.json()
    } catch {
      // non-JSON error body — keep default
    }
    throw new GraphAPIError(response.status, detail)
  }

  const data: GenerateResponse = await response.json()
  return data
}
```
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && cat apps/web/lib/api.ts | grep -q "AbortSignal" && echo "AbortSignal OK" && cat apps/web/lib/api.ts | grep -q "GraphAPIError" && echo "GraphAPIError OK" && cat apps/web/lib/api.ts | grep -q "isScrapeFailure" && echo "isScrapeFailure OK"</automated>
    <manual>Confirm: generateGraph exported; GraphAPIError class with isScrapeFailure getter; signal wired into fetch; no toast calls in this file (toasts belong in page component)</manual>
  </verify>
  <done>apps/web/lib/api.ts exports generateGraph(input, signal): Promise&lt;GenerateResponse&gt; and GraphAPIError class with isScrapeFailure getter; fetch uses the signal for cancellation; non-2xx throws GraphAPIError with status and detail</done>
</task>

<task type="auto">
  <name>Task 2: LoadingSteps.tsx — sequential step labels cycling + dark canvas overlay with Cancel button</name>
  <files>
    apps/web/components/input/LoadingSteps.tsx
  </files>
  <action>
Create `apps/web/components/input/LoadingSteps.tsx`.

Locked CONTEXT.md decisions:
- Sequential step labels cycling: "Fetching URL..." → "Extracting entities..." → "Building graph..." (in that order, cycling)
- Each step displayed for ~1800ms before advancing to next
- Dark empty canvas shown with a centered spinner while loading (frames the space before graph appears)
- Cancel button visible during loading — calls onCancel which aborts the in-flight request

This component is the loading overlay shown in the main canvas area while generation is in progress.

```typescript
'use client'

import { useState, useEffect } from 'react'

const LOADING_STEPS = [
  'Fetching URL...',
  'Extracting entities...',
  'Building graph...',
] as const

interface LoadingStepsProps {
  /** Whether to show URL-specific first step (vs text input which skips "Fetching URL") */
  isUrl: boolean
  onCancel: () => void
}

export default function LoadingSteps({ isUrl, onCancel }: LoadingStepsProps) {
  const steps = isUrl ? LOADING_STEPS : LOADING_STEPS.slice(1) as unknown as typeof LOADING_STEPS
  const [stepIndex, setStepIndex] = useState(0)

  useEffect(() => {
    setStepIndex(0)
    const interval = setInterval(() => {
      setStepIndex((i) => (i + 1) % steps.length)
    }, 1800)
    return () => clearInterval(interval)
  }, [steps.length])

  return (
    <div className="flex flex-col items-center justify-center w-full h-full bg-gray-950 gap-6">
      {/* Spinner */}
      <div className="relative">
        <div className="w-10 h-10 border-2 border-gray-700 rounded-full" />
        <div className="absolute inset-0 w-10 h-10 border-2 border-transparent border-t-indigo-500 rounded-full animate-spin" />
      </div>

      {/* Current step label */}
      <p className="text-sm text-gray-400 font-medium min-h-[1.25rem] text-center">
        {steps[stepIndex]}
      </p>

      {/* Step dots */}
      <div className="flex gap-1.5">
        {steps.map((_, i) => (
          <div
            key={i}
            className={`w-1.5 h-1.5 rounded-full transition-colors duration-300 ${
              i === stepIndex ? 'bg-indigo-500' : 'bg-gray-700'
            }`}
          />
        ))}
      </div>

      {/* Cancel button */}
      <button
        onClick={onCancel}
        className="mt-2 text-xs text-gray-500 hover:text-gray-300 underline underline-offset-2 transition-colors"
      >
        Cancel
      </button>
    </div>
  )
}
```
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && cat apps/web/components/input/LoadingSteps.tsx | grep -q "Fetching URL" && echo "Fetching URL step OK" && cat apps/web/components/input/LoadingSteps.tsx | grep -q "Extracting entities" && echo "Extracting entities step OK" && cat apps/web/components/input/LoadingSteps.tsx | grep -q "onCancel" && echo "Cancel button OK"</automated>
    <manual>Confirm 3 step labels match CONTEXT.md exactly; 1800ms interval; Cancel button calls onCancel; spinner renders</manual>
  </verify>
  <done>LoadingSteps.tsx cycles through "Fetching URL..." → "Extracting entities..." → "Building graph..." at 1800ms intervals; Cancel button calls onCancel prop; spinner and step dots rendered; isUrl=false skips "Fetching URL..."</done>
</task>

<task type="auto">
  <name>Task 3: InputCard.tsx — hero-centered input with URL/Text tabs, collapse after generation</name>
  <files>
    apps/web/components/input/InputCard.tsx
  </files>
  <action>
Create `apps/web/components/input/InputCard.tsx`.

Locked CONTEXT.md decisions:
- Hero-style centered layout — large centered card at top of page (Perplexity/v0 aesthetic)
- Tab toggle between "URL" and "Text" modes — tabs swap the input field type (URL input vs textarea)
- After graph generated, the input area collapses to a compact bar at the top
- Text tab placeholder: "Paste a funding announcement, blog post, or article about a crypto VC deal..."
- Uses @radix-ui/react-tabs for accessible tab toggle

The InputCard is a controlled component — it calls onSubmit(input, isUrl) with the current input value and mode. The parent page manages loading state and calls collapse when graph arrives.

```typescript
'use client'

import * as Tabs from '@radix-ui/react-tabs'
import { useState, useRef } from 'react'

interface InputCardProps {
  collapsed: boolean
  disabled: boolean
  onSubmit: (input: string, isUrl: boolean) => void
  /** Called when user clicks the collapsed bar to re-expand */
  onExpand: () => void
}

export default function InputCard({ collapsed, disabled, onSubmit, onExpand }: InputCardProps) {
  const [mode, setMode] = useState<'url' | 'text'>('url')
  const [urlInput, setUrlInput] = useState('')
  const [textInput, setTextInput] = useState('')
  const inputRef = useRef<HTMLInputElement | null>(null)
  const textareaRef = useRef<HTMLTextAreaElement | null>(null)

  const currentInput = mode === 'url' ? urlInput : textInput
  const isUrl = mode === 'url'

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    if (!currentInput.trim() || disabled) return
    onSubmit(currentInput.trim(), isUrl)
  }

  // Collapsed state: compact bar at top with truncated input and a "New" button
  if (collapsed) {
    return (
      <div
        className="flex items-center gap-3 px-4 py-2.5 bg-gray-900 border-b border-gray-700 cursor-pointer hover:bg-gray-800 transition-colors"
        onClick={onExpand}
        title="Click to generate another graph"
      >
        <span className="text-xs text-gray-500 uppercase tracking-wide shrink-0">
          {isUrl ? 'URL' : 'Text'}
        </span>
        <span className="text-sm text-gray-400 truncate flex-1 min-w-0">{currentInput}</span>
        <button
          onClick={(e) => { e.stopPropagation(); onExpand() }}
          className="shrink-0 text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-2.5 py-1 rounded transition-colors font-medium"
        >
          New
        </button>
      </div>
    )
  }

  // Expanded state: hero card
  return (
    <div className="w-full max-w-2xl mx-auto px-4 py-8">
      <div className="bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl overflow-hidden">
        {/* Tab toggle */}
        <Tabs.Root
          value={mode}
          onValueChange={(v) => setMode(v as 'url' | 'text')}
          className="flex flex-col"
        >
          <Tabs.List className="flex border-b border-gray-700">
            <Tabs.Trigger
              value="url"
              className="flex-1 py-3 text-sm font-medium text-gray-400 data-[state=active]:text-white data-[state=active]:border-b-2 data-[state=active]:border-indigo-500 transition-colors hover:text-gray-200"
            >
              URL
            </Tabs.Trigger>
            <Tabs.Trigger
              value="text"
              className="flex-1 py-3 text-sm font-medium text-gray-400 data-[state=active]:text-white data-[state=active]:border-b-2 data-[state=active]:border-indigo-500 transition-colors hover:text-gray-200"
            >
              Text
            </Tabs.Trigger>
          </Tabs.List>

          <form onSubmit={handleSubmit} className="p-4 flex flex-col gap-3">
            <Tabs.Content value="url">
              <input
                ref={inputRef}
                type="url"
                value={urlInput}
                onChange={(e) => setUrlInput(e.target.value)}
                placeholder="https://techcrunch.com/2024/..."
                disabled={disabled}
                className="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2.5 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 transition-colors disabled:opacity-50"
              />
            </Tabs.Content>

            <Tabs.Content value="text">
              <textarea
                ref={textareaRef}
                value={textInput}
                onChange={(e) => setTextInput(e.target.value)}
                placeholder="Paste a funding announcement, blog post, or article about a crypto VC deal..."
                disabled={disabled}
                rows={5}
                className="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2.5 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 transition-colors resize-none disabled:opacity-50"
              />
            </Tabs.Content>

            <button
              type="submit"
              disabled={disabled || !currentInput.trim()}
              className="w-full bg-indigo-600 hover:bg-indigo-500 disabled:bg-gray-700 disabled:text-gray-500 text-white font-medium py-2.5 rounded-lg transition-colors text-sm"
            >
              Generate Graph
            </button>
          </form>
        </Tabs.Root>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && cat apps/web/components/input/InputCard.tsx | grep -q "@radix-ui/react-tabs" && echo "radix tabs OK" && cat apps/web/components/input/InputCard.tsx | grep -q "collapsed" && echo "collapsed state OK" && cat apps/web/components/input/InputCard.tsx | grep -q "crypto VC deal" && echo "placeholder text OK"</automated>
    <manual>Confirm: URL tab shows input type="url"; Text tab shows textarea with exact placeholder copy; collapsed=true shows compact bar; @radix-ui/react-tabs used; Generate Graph button disabled when input is empty</manual>
  </verify>
  <done>InputCard.tsx: URL/Text tab toggle via @radix-ui/react-tabs; URL tab uses input type="url"; Text tab uses textarea with "Paste a funding announcement, blog post, or article about a crypto VC deal..." placeholder; collapsed=true renders compact bar with input summary and "New" button; onSubmit called with (input, isUrl)</done>
</task>

</tasks>

<verification>
1. `cat apps/web/lib/api.ts | grep "GraphAPIError"` — class exported
2. `cat apps/web/lib/api.ts | grep "signal"` — AbortSignal wired into fetch
3. `cat apps/web/components/input/LoadingSteps.tsx | grep -E "Fetching|Extracting|Building"` — all 3 step strings present
4. `cat apps/web/components/input/InputCard.tsx | grep "@radix-ui"` — radix tabs imported
5. `cat apps/web/components/input/InputCard.tsx | grep "collapsed"` — collapsed state handled
</verification>

<success_criteria>
- lib/api.ts exports generateGraph(input, signal) and GraphAPIError with isScrapeFailure getter; no toast calls in api.ts
- LoadingSteps.tsx cycles 3 steps at 1800ms; Cancel button calls onCancel; spinner present
- InputCard.tsx: URL/Text tabs via @radix-ui/react-tabs; Text placeholder matches CONTEXT.md exactly; collapsed/expanded states; onSubmit(input, isUrl) callback
</success_criteria>

<output>
After completion, create `.planning/phases/02-monorepo-vertical-slice/02-03-SUMMARY.md`
</output>
