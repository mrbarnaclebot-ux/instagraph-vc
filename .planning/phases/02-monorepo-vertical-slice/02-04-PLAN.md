---
phase: 02-monorepo-vertical-slice
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - apps/web/app/app/page.tsx
autonomous: true
requirements: [FE-01, FE-02, FE-05]

must_haves:
  truths:
    - "User visits /app, sees the hero input card centered on a dark page"
    - "User submits a URL, sees the loading overlay with cycling step labels and Cancel button"
    - "When graph data arrives, the input collapses to a compact bar and the Cytoscape canvas fills the remaining space with animated nodes flying in"
    - "Clicking a node in the graph opens the detail panel and highlights the node's neighborhood"
    - "Clicking the canvas background closes the detail panel and clears highlights"
    - "Clicking a connected node in the detail panel navigates to that node (updates selection and highlights)"
    - "Scrape failure shows toast: 'Couldn't read that URL — try pasting the text instead'"
    - "Empty graph (0 nodes) shows toast: 'No VC relationships found'"
    - "User clicks Cancel during loading — request aborts, UI resets to input state"
    - "User clicks New in the collapsed bar — input re-expands"
  artifacts:
    - path: "apps/web/app/app/page.tsx"
      provides: "App workspace page wiring all components together with state machine"
      min_lines: 100
      exports: ["default"]
  key_links:
    - from: "apps/web/app/app/page.tsx"
      to: "apps/web/components/graph/GraphCanvas.tsx"
      via: "dynamic import with ssr:false"
      pattern: "dynamic.*GraphCanvas.*ssr.*false"
    - from: "apps/web/app/app/page.tsx"
      to: "apps/web/components/graph/DetailPanel.tsx"
      via: "conditional render based on selectedNodeId"
      pattern: "selectedNodeId"
    - from: "apps/web/app/app/page.tsx"
      to: "apps/web/lib/api.ts"
      via: "generateGraph() call with AbortController signal"
      pattern: "generateGraph.*signal"
    - from: "apps/web/app/app/page.tsx"
      to: "sonner"
      via: "toast.error() calls for FE-05 error states"
      pattern: "toast\\.error"
---

<objective>
Wire all Phase 2 components together in the /app page: input card, loading overlay, Cytoscape canvas, and detail panel — implementing the full state machine and FE-05 toast error handling.

Purpose: This is the vertical slice that proves the full input-to-graph flow works end-to-end in the browser, which is Phase 2's success criterion.
Output: apps/web/app/app/page.tsx as the complete, working graph workspace.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-monorepo-vertical-slice/02-CONTEXT.md
@.planning/phases/02-monorepo-vertical-slice/02-RESEARCH.md
@.planning/phases/02-monorepo-vertical-slice/02-02-SUMMARY.md
@.planning/phases/02-monorepo-vertical-slice/02-03-SUMMARY.md
@apps/web/components/graph/GraphCanvas.tsx
@apps/web/components/graph/DetailPanel.tsx
@apps/web/components/input/InputCard.tsx
@apps/web/components/input/LoadingSteps.tsx
@apps/web/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: apps/web/app/app/page.tsx — full state machine wiring all components</name>
  <files>
    apps/web/app/app/page.tsx
  </files>
  <action>
Create/overwrite `apps/web/app/app/page.tsx`. This replaces the placeholder created in Plan 02-01.

CRITICAL: GraphCanvas must be imported via `dynamic(..., { ssr: false })` — do NOT import it directly. react-cytoscapejs accesses window at module load time and will throw `window is not defined` during Next.js server rendering.

State machine states:
- `idle` — input card shown, no graph data
- `loading` — request in-flight, loading overlay shown (InputCard collapsed, LoadingSteps shown)
- `success` — graph data received, canvas shown (InputCard collapsed to bar, GraphCanvas + optional DetailPanel)
- `error` — request failed, input shown again

The AbortController ref (from RESEARCH.md Pattern 6):
- Created when submit begins
- Stored in a ref (not state — changing it must not re-render)
- `controllerRef.current.abort()` called by Cancel button

FE-05 toast logic (exact error strings from requirements — non-negotiable):
- Scrape failure: `toast.error("Couldn't read that URL — try pasting the text instead")`
- Empty graph (data.graph.nodes.length === 0): `toast.error("No VC relationships found")`
- Generic error: `toast.error(err.message ?? "Something went wrong")`
- AbortError (name === 'AbortError'): no toast — user cancelled intentionally

```typescript
'use client'

import dynamic from 'next/dynamic'
import { useState, useRef, useCallback } from 'react'
import { toast } from 'sonner'
import InputCard from '@/components/input/InputCard'
import LoadingSteps from '@/components/input/LoadingSteps'
import DetailPanel from '@/components/graph/DetailPanel'
import { generateGraph, GraphAPIError } from '@/lib/api'
import type { VCGraph } from '@graphvc/shared-types'

// CRITICAL: ssr:false required — react-cytoscapejs accesses window at module load time
const GraphCanvas = dynamic(
  () => import('@/components/graph/GraphCanvas'),
  {
    ssr: false,
    loading: () => (
      <div className="w-full h-full flex items-center justify-center bg-gray-950">
        <div className="w-6 h-6 border-2 border-transparent border-t-indigo-500 rounded-full animate-spin" />
      </div>
    ),
  }
)

type Status = 'idle' | 'loading' | 'success'

export default function AppPage() {
  const [status, setStatus] = useState<Status>('idle')
  const [graph, setGraph] = useState<VCGraph | null>(null)
  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null)
  const [inputCollapsed, setInputCollapsed] = useState(false)
  const [lastInput, setLastInput] = useState<{ value: string; isUrl: boolean } | null>(null)

  const controllerRef = useRef<AbortController | null>(null)

  const handleSubmit = useCallback(async (input: string, isUrl: boolean) => {
    // Abort any in-flight request
    controllerRef.current?.abort()
    controllerRef.current = new AbortController()

    setLastInput({ value: input, isUrl })
    setStatus('loading')
    setInputCollapsed(true)
    setSelectedNodeId(null)

    try {
      const data = await generateGraph(input, controllerRef.current.signal)

      // FE-05: empty graph check
      if (data.graph.nodes.length === 0) {
        toast.error('No VC relationships found')
        setStatus('idle')
        setInputCollapsed(false)
        return
      }

      setGraph(data.graph)
      setStatus('success')
    } catch (err) {
      // User cancelled — reset quietly, no toast
      if (err instanceof DOMException && err.name === 'AbortError') {
        setStatus('idle')
        setInputCollapsed(false)
        return
      }

      if (err instanceof GraphAPIError) {
        // FE-05: scrape failure specific toast
        if (err.isScrapeFailure) {
          toast.error("Couldn't read that URL — try pasting the text instead")
        } else {
          toast.error(err.message ?? 'Something went wrong')
        }
      } else {
        toast.error('Something went wrong. Please try again.')
      }

      setStatus('idle')
      setInputCollapsed(false)
    }
  }, [])

  const handleCancel = useCallback(() => {
    controllerRef.current?.abort()
  }, [])

  const handleExpand = useCallback(() => {
    setInputCollapsed(false)
    setGraph(null)
    setStatus('idle')
    setSelectedNodeId(null)
  }, [])

  const handleNodeClick = useCallback((nodeId: string | null) => {
    setSelectedNodeId(nodeId)
  }, [])

  // Navigate to a connected node from the detail panel (CONTEXT.md: panel is a navigation hub)
  const handleNavigate = useCallback((nodeId: string) => {
    setSelectedNodeId(nodeId)
  }, [])

  return (
    <div className="flex flex-col h-screen bg-gray-950 overflow-hidden">
      {/* Input area: hero card (idle) or collapsed bar (loading/success) */}
      <InputCard
        collapsed={inputCollapsed}
        disabled={status === 'loading'}
        onSubmit={handleSubmit}
        onExpand={handleExpand}
      />

      {/* Main area: loading overlay, canvas, or empty state */}
      <div className="flex-1 relative overflow-hidden flex">
        {status === 'idle' && !graph && (
          <div className="flex-1 flex items-center justify-center">
            <p className="text-gray-600 text-sm">Enter a URL or paste text above to generate a graph</p>
          </div>
        )}

        {status === 'loading' && lastInput && (
          <div className="flex-1">
            <LoadingSteps
              isUrl={lastInput.isUrl}
              onCancel={handleCancel}
            />
          </div>
        )}

        {status === 'success' && graph && (
          <>
            <div className="flex-1 relative overflow-hidden">
              <GraphCanvas
                graph={graph}
                selectedNodeId={selectedNodeId}
                onNodeClick={handleNodeClick}
              />
            </div>
            {selectedNodeId && (
              <DetailPanel
                graph={graph}
                selectedNodeId={selectedNodeId}
                onNavigate={handleNavigate}
                onClose={() => setSelectedNodeId(null)}
              />
            )}
          </>
        )}
      </div>
    </div>
  )
}
```

After writing the file, run a TypeScript check from apps/web to catch any import or type errors:
```bash
cd apps/web && pnpm tsc --noEmit 2>&1 | head -30
```

Fix any TypeScript errors found (common issues: import paths, missing type annotations).

Also verify Next.js can build without errors:
```bash
cd apps/web && pnpm build 2>&1 | tail -20
```

If build fails due to TypeScript errors in unrelated generated files (e.g., .next/types/app/layout.d.ts), these can be ignored. If build fails due to errors in the files written in this phase, fix them.
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && cat apps/web/app/app/page.tsx | grep -q "dynamic" && echo "dynamic import OK" && cat apps/web/app/app/page.tsx | grep -q "ssr: false" && echo "ssr:false OK" && cat apps/web/app/app/page.tsx | grep -q "AbortController" && echo "AbortController OK" && cat apps/web/app/app/page.tsx | grep -q "No VC relationships found" && echo "FE-05 empty graph toast OK" && cat apps/web/app/app/page.tsx | grep -q "Couldn't read that URL" && echo "FE-05 scrape failure toast OK"</automated>
    <manual>Confirm: dynamic() with ssr:false wrapping GraphCanvas; both FE-05 toast strings present; AbortController wired to handleCancel; DetailPanel conditional on selectedNodeId; handleNavigate passed to DetailPanel as onNavigate</manual>
  </verify>
  <done>apps/web/app/app/page.tsx: 'use client'; GraphCanvas wrapped in dynamic({ssr:false}); state machine (idle/loading/success); AbortController in ref; FE-05 toasts ("No VC relationships found", "Couldn't read that URL — try pasting the text instead"); InputCard collapse/expand; LoadingSteps with cancel; DetailPanel with navigation hub; TypeScript compiles without errors in Phase 2 files</done>
</task>

</tasks>

<verification>
End-to-end smoke test (requires FastAPI running on localhost:8000 and valid OPENAI_API_KEY in apps/api/.env):
1. `pnpm dev` from repo root — Next.js starts on :3000, FastAPI on :8000
2. Visit http://localhost:3000 — should redirect to /app
3. Paste a funding announcement URL in the URL tab and click Generate Graph
4. Loading overlay appears with cycling steps and Cancel button
5. Graph renders with colored/shaped nodes — Investor=indigo ellipse, Project=emerald rect, etc.
6. Input collapses to compact bar at top
7. Click any node — neighborhood dims, detail panel opens on right (or bottom sheet on mobile)
8. Click a connected node in the panel — graph updates selection
9. Click canvas background — panel closes, dimming clears

TypeScript check:
```bash
cd apps/web && pnpm tsc --noEmit 2>&1 | grep -E "error TS" | grep -v ".next/" | head -10
```
Zero errors expected in Phase 2 source files.
</verification>

<success_criteria>
- /app route renders without 404 or build error
- GraphCanvas wrapped in dynamic({ ssr: false }) — no window is not defined
- Both FE-05 toast strings are exact matches to requirements
- Cancel button aborts fetch via AbortController
- DetailPanel only renders when selectedNodeId is non-null
- Input collapses to bar on graph success; "New" button re-expands
- TypeScript: no TS errors in apps/web/app/app/page.tsx
</success_criteria>

<output>
After completion, create `.planning/phases/02-monorepo-vertical-slice/02-04-SUMMARY.md`
</output>
