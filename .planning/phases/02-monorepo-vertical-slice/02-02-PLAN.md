---
phase: 02-monorepo-vertical-slice
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/web/components/graph/cytoscapeStyles.ts
  - apps/web/components/graph/GraphCanvas.tsx
  - apps/web/components/graph/DetailPanel.tsx
autonomous: true
requirements: [FE-01, FE-02]

must_haves:
  truths:
    - "Investor nodes render as indigo ellipses, Project nodes as emerald rectangles, Round nodes as amber diamonds, Narrative nodes as violet hexagons, Person nodes as pink ellipses"
    - "Clicking a node highlights its neighborhood (dims unconnected elements to opacity 0.2) and opens the detail panel simultaneously"
    - "Clicking the canvas background closes the detail panel and removes dimming"
    - "Detail panel shows node label, entity type, and a key-value table of all properties"
    - "Detail panel lists connected nodes with relationship type — each is clickable to navigate to that node"
    - "Edge labels are always visible (not hover-only) with relationship type text"
    - "On narrow screens the detail panel renders as a bottom sheet; on wide screens as a right overlay"
    - "Each property row has a copy icon visible on hover"
    - "GraphCanvas is wrapped in dynamic() with ssr:false — no window is not defined at build time"
  artifacts:
    - path: "apps/web/components/graph/cytoscapeStyles.ts"
      provides: "Cytoscape stylesheet with VC entity colors/shapes and dimmed state"
      min_lines: 50
      exports: ["cytoscapeStylesheet"]
    - path: "apps/web/components/graph/GraphCanvas.tsx"
      provides: "React Cytoscape canvas with fcose layout, node click events, neighborhood highlight"
      min_lines: 80
    - path: "apps/web/components/graph/DetailPanel.tsx"
      provides: "Right-side/bottom-sheet panel with key-value properties, connected nodes navigation, copy icons"
      min_lines: 80
  key_links:
    - from: "apps/web/components/graph/GraphCanvas.tsx"
      to: "@graphvc/shared-types"
      via: "import VCGraph type"
      pattern: "from '@graphvc/shared-types'"
    - from: "apps/web/components/graph/GraphCanvas.tsx"
      to: "cytoscape-fcose"
      via: "Cytoscape.use(fcose) at module level"
      pattern: "Cytoscape\\.use\\(fcose\\)"
    - from: "apps/web/components/graph/GraphCanvas.tsx"
      to: "DetailPanel.tsx"
      via: "onNodeClick callback prop"
      pattern: "onNodeClick"
    - from: "apps/web/components/graph/GraphCanvas.tsx"
      to: "react-cytoscapejs"
      via: "CytoscapeComponent with cy ref callback"
      pattern: "cy=\\{handleCyInit\\}"
---

<objective>
Build the Cytoscape.js graph canvas with VC entity styling and the node detail panel — the two core interactive components of the graph workspace.

Purpose: FE-01 (styled canvas) and FE-02 (detail panel) are the product's core value — users see a beautiful, interactive graph that lets them explore VC relationships. These components are the reason GraphVC exists.
Output: GraphCanvas.tsx (fcose layout, VC styling, neighborhood highlight), DetailPanel.tsx (key-value table, connected nodes nav, responsive bottom sheet), cytoscapeStyles.ts (stylesheet constants).
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-monorepo-vertical-slice/02-CONTEXT.md
@.planning/phases/02-monorepo-vertical-slice/02-RESEARCH.md
@.planning/phases/02-monorepo-vertical-slice/02-01-SUMMARY.md
@packages/shared-types/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: cytoscapeStyles.ts — VC entity stylesheet with dimmed state</name>
  <files>
    apps/web/components/graph/cytoscapeStyles.ts
  </files>
  <action>
Create `apps/web/components/graph/cytoscapeStyles.ts`.

CRITICAL constraint from RESEARCH.md Pitfall 2: FE-01 mentions haystack edges for performance but CONTEXT.md locks edge labels as ALWAYS visible. Haystack edges in Cytoscape.js do NOT render labels. Resolution: use `bezier` curve style (supports labels with text-rotation: autorotate) and rely on `hideEdgesOnViewport: true` at the canvas level for performance. `pixelRatio: 1` is still applied. Do NOT use haystack.

Locked colors/shapes from FE-01 (non-negotiable):
- Investor: indigo (#6366f1), ellipse
- Project: emerald (#10b981), rectangle
- Round: amber (#f59e0b), diamond
- Narrative: violet (#8b5cf6), hexagon
- Person: pink (#ec4899), ellipse

```typescript
import type Cytoscape from 'cytoscape'

export const cytoscapeStylesheet: Cytoscape.Stylesheet[] = [
  // Base node style
  {
    selector: 'node',
    style: {
      'label': 'data(label)',
      'text-valign': 'center',
      'text-halign': 'center',
      'font-size': 11,
      'color': '#ffffff',
      'text-outline-width': 1.5,
      'width': 'label',
      'height': 'label',
      'padding': '8px',
    },
  },
  // Entity-type node styles (FE-01 requirement — locked colors/shapes)
  {
    selector: 'node[type = "Investor"]',
    style: {
      'background-color': '#6366f1',
      'shape': 'ellipse',
      'text-outline-color': '#6366f1',
    },
  },
  {
    selector: 'node[type = "Project"]',
    style: {
      'background-color': '#10b981',
      'shape': 'rectangle',
      'text-outline-color': '#10b981',
    },
  },
  {
    selector: 'node[type = "Round"]',
    style: {
      'background-color': '#f59e0b',
      'shape': 'diamond',
      'text-outline-color': '#f59e0b',
    },
  },
  {
    selector: 'node[type = "Narrative"]',
    style: {
      'background-color': '#8b5cf6',
      'shape': 'hexagon',
      'text-outline-color': '#8b5cf6',
    },
  },
  {
    selector: 'node[type = "Person"]',
    style: {
      'background-color': '#ec4899',
      'shape': 'ellipse',
      'text-outline-color': '#ec4899',
    },
  },
  // Dimmed state for neighborhood highlight (opacity 0.2 for non-neighbors)
  {
    selector: '.dimmed',
    style: { 'opacity': 0.2 },
  },
  // Highlighted (selected) node — brighter border
  {
    selector: '.highlighted',
    style: {
      'border-width': 3,
      'border-color': '#ffffff',
      'border-opacity': 0.9,
    },
  },
  // Edge default — bezier with visible labels (NOT haystack — haystack ignores labels)
  {
    selector: 'edge',
    style: {
      'curve-style': 'bezier',
      'label': 'data(label)',
      'font-size': 9,
      'text-rotation': 'autorotate',
      'text-background-color': '#111827',
      'text-background-opacity': 0.7,
      'text-background-padding': '2px',
      'line-color': '#4b5563',
      'target-arrow-shape': 'triangle',
      'target-arrow-color': '#4b5563',
      'width': 1.5,
      'color': '#9ca3af',
    },
  },
  // Dimmed edge
  {
    selector: 'edge.dimmed',
    style: { 'opacity': 0.1 },
  },
]
```
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && cat apps/web/components/graph/cytoscapeStyles.ts | grep -q "bezier" && echo "bezier edge OK" && cat apps/web/components/graph/cytoscapeStyles.ts | grep -q "6366f1" && echo "Investor indigo OK" && cat apps/web/components/graph/cytoscapeStyles.ts | grep -q "10b981" && echo "Project emerald OK"</automated>
    <manual>Confirm all 5 entity types have correct colors/shapes; edge uses bezier not haystack; dimmed selector present</manual>
  </verify>
  <done>cytoscapeStyles.ts exports cytoscapeStylesheet array with 5 entity-type selectors (locked colors/shapes), dimmed/highlighted state selectors, and bezier edge style with always-visible labels</done>
</task>

<task type="auto">
  <name>Task 2: GraphCanvas.tsx — Cytoscape canvas with fcose layout, drag, zoom, fit button, neighborhood highlight</name>
  <files>
    apps/web/components/graph/GraphCanvas.tsx
  </files>
  <action>
Create `apps/web/components/graph/GraphCanvas.tsx`.

CRITICAL: This file imports react-cytoscapejs which accesses window at module load time. This file must NOT be imported directly in a Server Component or page.tsx without being wrapped in `dynamic(..., { ssr: false })`. The wrapping happens in the page (Plan 02-04). This component itself is a 'use client' component.

CRITICAL: Call `Cytoscape.use(fcose)` at MODULE TOP LEVEL, outside the component function. Calling it inside a component re-registers on every render.

Locked CONTEXT.md decisions to implement:
- Free node dragging enabled (default in Cytoscape — do not disable grabbing)
- Scroll-to-zoom + drag-to-pan (default in Cytoscape — do not disable)
- A visible "fit" button that calls `cy.fit()` — position at bottom-right corner of canvas
- Clicking a node: BOTH highlights neighborhood AND calls onNodeClick to open detail panel
- Edge labels always visible (bezier from cytoscapeStyles.ts)
- FE-01 performance: pixelRatio=1, hideEdgesOnViewport=true

```typescript
'use client'

import CytoscapeComponent from 'react-cytoscapejs'
import Cytoscape from 'cytoscape'
import fcose from 'cytoscape-fcose'
import { useRef, useCallback, useEffect } from 'react'
import { cytoscapeStylesheet } from './cytoscapeStyles'
import type { VCGraph, GraphNode } from '@graphvc/shared-types'

// Register fcose layout once at module level — NOT inside component (would re-register on every render)
Cytoscape.use(fcose as Cytoscape.Ext)

interface GraphCanvasProps {
  graph: VCGraph
  selectedNodeId: string | null
  onNodeClick: (nodeId: string | null) => void
}

export default function GraphCanvas({ graph, selectedNodeId, onNodeClick }: GraphCanvasProps) {
  const cyRef = useRef<Cytoscape.Core | null>(null)

  // When selectedNodeId changes externally (e.g., from detail panel navigation), sync highlight
  useEffect(() => {
    const cy = cyRef.current
    if (!cy) return
    cy.elements().removeClass('dimmed highlighted')
    if (selectedNodeId) {
      const node = cy.getElementById(selectedNodeId)
      if (node.length > 0) {
        cy.elements().addClass('dimmed')
        node.neighborhood().add(node).removeClass('dimmed')
        node.addClass('highlighted')
      }
    }
  }, [selectedNodeId])

  const handleCyInit = useCallback((cy: Cytoscape.Core) => {
    cyRef.current = cy

    // Node tap: highlight neighborhood + open detail panel
    cy.on('tap', 'node', (evt) => {
      const node = evt.target as Cytoscape.NodeSingular
      cy.elements().removeClass('dimmed highlighted')
      cy.elements().addClass('dimmed')
      node.neighborhood().add(node).removeClass('dimmed')
      node.addClass('highlighted')
      onNodeClick(node.id())
    })

    // Background tap: remove dimming + close panel
    cy.on('tap', (evt) => {
      if (evt.target === cy) {
        cy.elements().removeClass('dimmed highlighted')
        onNodeClick(null)
      }
    })
  }, [onNodeClick])

  const elements = [
    ...graph.nodes.map((n) => ({
      data: { id: n.id, label: n.label, type: n.type, ...n.properties },
    })),
    ...graph.edges.map((e) => ({
      data: { source: e.source, target: e.target, label: e.relationship },
    })),
  ]

  const handleFit = () => {
    cyRef.current?.fit(undefined, 40)
  }

  return (
    <div className="relative w-full h-full bg-gray-950">
      <CytoscapeComponent
        elements={elements}
        stylesheet={cytoscapeStylesheet}
        layout={{
          name: 'fcose',
          animate: true,
          animationDuration: 600,
          animationEasing: 'ease-out',
          fit: true,
          padding: 40,
          nodeDimensionsIncludeLabels: true,
        } as Cytoscape.LayoutOptions}
        cy={handleCyInit}
        style={{ width: '100%', height: '100%' }}
        pixelRatio={1}
        hideEdgesOnViewport={true}
      />
      {/* Fit button — positioned at bottom-right of canvas (Claude's discretion per CONTEXT.md) */}
      <button
        onClick={handleFit}
        title="Fit graph to viewport"
        className="absolute bottom-4 right-4 z-10 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-gray-300 rounded-md px-3 py-1.5 text-xs font-medium transition-colors"
      >
        Fit
      </button>
    </div>
  )
}
```
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && cat apps/web/components/graph/GraphCanvas.tsx | grep -q "Cytoscape.use(fcose" && echo "fcose registered at module level OK" && cat apps/web/components/graph/GraphCanvas.tsx | grep -q "hideEdgesOnViewport" && echo "hideEdgesOnViewport OK" && cat apps/web/components/graph/GraphCanvas.tsx | grep -q "pixelRatio" && echo "pixelRatio OK"</automated>
    <manual>Confirm Cytoscape.use(fcose) is outside the component; node tap handler does both neighborhood highlight AND onNodeClick; background tap clears selection; fit button present</manual>
  </verify>
  <done>GraphCanvas.tsx is a 'use client' component exporting default GraphCanvas; Cytoscape.use(fcose) at module level; cy ref captures instance via cy prop callback; node tap does neighborhood highlight + calls onNodeClick; background tap clears all; fit button visible; pixelRatio=1 and hideEdgesOnViewport=true set</done>
</task>

<task type="auto">
  <name>Task 3: DetailPanel.tsx — key-value property table, connected nodes nav, responsive bottom sheet, copy icons</name>
  <files>
    apps/web/components/graph/DetailPanel.tsx
  </files>
  <action>
Create `apps/web/components/graph/DetailPanel.tsx`.

Locked CONTEXT.md decisions to implement:
- Key-value table layout — property name (left), value (right)
- Connected nodes listed with relationship type, clickable to navigate to that node
- On mobile/narrow screens: bottom sheet (slides up from bottom, fixed position)
- On wide screens: right-side overlay panel
- Copy icon per row on hover — small clipboard icon next to each value

The panel receives the selected node and full graph data so it can compute connected nodes from edges.

```typescript
'use client'

import { useState } from 'react'
import type { VCGraph, GraphNode, GraphEdge } from '@graphvc/shared-types'

interface DetailPanelProps {
  graph: VCGraph
  selectedNodeId: string | null
  onNavigate: (nodeId: string) => void
  onClose: () => void
}

interface ConnectedNode {
  node: GraphNode
  relationship: string
  direction: 'outgoing' | 'incoming'
}

function CopyIcon({ value }: { value: unknown }) {
  const [copied, setCopied] = useState(false)

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(String(value))
      setCopied(true)
      setTimeout(() => setCopied(false), 1500)
    } catch {
      // clipboard API may be blocked in some contexts
    }
  }

  return (
    <button
      onClick={handleCopy}
      title="Copy value"
      className="ml-1.5 opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-gray-200 shrink-0"
    >
      {copied ? (
        <span className="text-xs text-green-400">✓</span>
      ) : (
        <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
          <path d="M4 2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H4z"/>
          <path d="M6 0h7a3 3 0 0 1 3 3v7h-1V3a2 2 0 0 0-2-2H6V0z"/>
        </svg>
      )}
    </button>
  )
}

export default function DetailPanel({ graph, selectedNodeId, onNavigate, onClose }: DetailPanelProps) {
  const node = graph.nodes.find((n) => n.id === selectedNodeId) ?? null

  if (!node) return null

  // Find connected nodes from edges
  const connected: ConnectedNode[] = graph.edges
    .filter((e) => e.source === node.id || e.target === node.id)
    .map((e) => {
      const isOutgoing = e.source === node.id
      const connectedId = isOutgoing ? e.target : e.source
      const connectedNode = graph.nodes.find((n) => n.id === connectedId)
      if (!connectedNode) return null
      return {
        node: connectedNode,
        relationship: e.relationship,
        direction: isOutgoing ? 'outgoing' : 'incoming',
      } as ConnectedNode
    })
    .filter((c): c is ConnectedNode => c !== null)

  const properties = Object.entries(node.properties).filter(([, v]) => v !== null && v !== undefined && v !== '')

  const entityTypeColors: Record<string, string> = {
    Investor: 'text-indigo-400',
    Project: 'text-emerald-400',
    Round: 'text-amber-400',
    Narrative: 'text-violet-400',
    Person: 'text-pink-400',
  }

  const panelContent = (
    <div className="flex flex-col h-full">
      {/* Header */}
      <div className="flex items-start justify-between p-4 border-b border-gray-700">
        <div>
          <p className={`text-xs font-medium uppercase tracking-wider mb-1 ${entityTypeColors[node.type] ?? 'text-gray-400'}`}>
            {node.type}
          </p>
          <h2 className="text-base font-semibold text-white leading-tight">{node.label}</h2>
        </div>
        <button
          onClick={onClose}
          title="Close panel"
          className="text-gray-400 hover:text-white transition-colors ml-3 shrink-0 mt-0.5"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.75.75 0 1 1 1.06 1.06L9.06 8l3.22 3.22a.75.75 0 1 1-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 0 1-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06z"/>
          </svg>
        </button>
      </div>

      {/* Properties key-value table */}
      {properties.length > 0 && (
        <div className="p-4 border-b border-gray-700">
          <p className="text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">Properties</p>
          <table className="w-full text-sm">
            <tbody>
              {properties.map(([key, value]) => (
                <tr key={key} className="group">
                  <td className="py-1 pr-3 text-gray-400 font-medium align-top whitespace-nowrap w-1/2">
                    {key.replace(/_/g, ' ')}
                  </td>
                  <td className="py-1 text-gray-200 align-top">
                    <div className="flex items-start">
                      <span className="break-all">{String(value)}</span>
                      <CopyIcon value={value} />
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Connected nodes — navigation hub */}
      {connected.length > 0 && (
        <div className="p-4 overflow-y-auto flex-1">
          <p className="text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">Connections</p>
          <ul className="space-y-1.5">
            {connected.map((c, i) => (
              <li key={`${c.node.id}-${i}`}>
                <button
                  onClick={() => onNavigate(c.node.id)}
                  className="w-full text-left flex items-center gap-2 text-sm text-gray-300 hover:text-white hover:bg-gray-800 rounded px-2 py-1.5 transition-colors group"
                >
                  <span className={`shrink-0 text-xs font-mono ${entityTypeColors[c.node.type] ?? 'text-gray-400'}`}>
                    {c.direction === 'outgoing' ? '→' : '←'}
                  </span>
                  <span className="text-xs text-gray-500 font-mono shrink-0">{c.relationship}</span>
                  <span className="truncate">{c.node.label}</span>
                </button>
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  )

  return (
    <>
      {/* Desktop: right overlay panel */}
      <aside className="hidden md:flex flex-col w-72 h-full border-l border-gray-700 bg-gray-900 overflow-hidden shrink-0">
        {panelContent}
      </aside>

      {/* Mobile: bottom sheet */}
      <div className="md:hidden fixed inset-x-0 bottom-0 z-50 bg-gray-900 border-t border-gray-700 rounded-t-2xl shadow-2xl max-h-[60vh] overflow-y-auto">
        {/* Drag handle */}
        <div className="flex justify-center pt-3 pb-1">
          <div className="w-8 h-1 bg-gray-600 rounded-full" />
        </div>
        {panelContent}
      </div>
    </>
  )
}
```
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && cat apps/web/components/graph/DetailPanel.tsx | grep -q "md:hidden" && echo "bottom sheet OK" && cat apps/web/components/graph/DetailPanel.tsx | grep -q "onNavigate" && echo "navigation hub OK" && cat apps/web/components/graph/DetailPanel.tsx | grep -q "CopyIcon" && echo "copy icons OK"</automated>
    <manual>Confirm: key-value table present; connected nodes list with onNavigate handler; CopyIcon with clipboard API; md:hidden bottom sheet and md:flex right overlay both present</manual>
  </verify>
  <done>DetailPanel.tsx renders right overlay on desktop (md:flex) and bottom sheet on mobile (md:hidden fixed bottom-0); key-value table of node.properties; connected nodes list with relationship labels and direction arrows; each connected node clickable (calls onNavigate); each property row has CopyIcon visible on hover</done>
</task>

</tasks>

<verification>
1. `cat apps/web/components/graph/cytoscapeStyles.ts | grep "bezier"` — bezier not haystack
2. `cat apps/web/components/graph/cytoscapeStyles.ts | grep -E "6366f1|10b981|f59e0b|8b5cf6|ec4899"` — all 5 entity colors present
3. `cat apps/web/components/graph/GraphCanvas.tsx | grep "Cytoscape.use"` — at module level not in component
4. `cat apps/web/components/graph/GraphCanvas.tsx | grep "hideEdgesOnViewport"` — present
5. `cat apps/web/components/graph/DetailPanel.tsx | grep "md:hidden"` — bottom sheet present
6. `cd apps/web && pnpm tsc --noEmit 2>&1 | head -20` — no TypeScript errors in these files (may have errors in other files if apps/web is incomplete)
</verification>

<success_criteria>
- cytoscapeStylesheet exported from cytoscapeStyles.ts with 5 locked entity styles and dimmed selector; uses bezier curve not haystack
- GraphCanvas.tsx: 'use client'; Cytoscape.use(fcose) at module level; node tap = neighborhood highlight + onNodeClick; background tap = clear; fit button; pixelRatio=1; hideEdgesOnViewport=true
- DetailPanel.tsx: right overlay on md+; bottom sheet on mobile; key-value properties table; connected nodes navigation hub; copy icons per row
- All three files import from @graphvc/shared-types for type safety
</success_criteria>

<output>
After completion, create `.planning/phases/02-monorepo-vertical-slice/02-02-SUMMARY.md`
</output>
