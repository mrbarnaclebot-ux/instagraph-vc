---
phase: 03-auth-persistence
plan: "06"
type: execute
wave: 4
depends_on:
  - 03-05
files_modified: []
autonomous: false
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04
  - AI-05
  - FE-03
must_haves:
  truths:
    - "User can sign up and sign in with Google OAuth via Clerk"
    - "Visiting /app/* while signed out redirects to /sign-in"
    - "Authenticated user generates a graph and it appears in /app/history"
    - "History card shows title, node/edge counts, relative timestamp"
    - "User can click a history card and see that graph on the Cytoscape canvas"
    - "User can rename and delete a graph they own"
    - "Anonymous user sees trial modal on second generation attempt"
    - "Clerk webhook delivery shows successful in Clerk Dashboard"
  artifacts:
    - path: "apps/web/proxy.ts"
      provides: "Auth guard active"
      contains: "clerkMiddleware"
    - path: "apps/web/app/sign-in/[[...sign-in]]/page.tsx"
      provides: "Working sign-in page with Google OAuth"
      contains: "SignIn"
    - path: "apps/web/app/app/history/page.tsx"
      provides: "Graph history UI"
      contains: "HistoryCard"
  key_links:
    - from: "/sign-in"
      to: "/app"
      via: "Clerk redirect after successful Google OAuth"
      pattern: "NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL"
    - from: "/app/history"
      to: "/app?session="
      via: "HistoryCard click navigates to graph"
      pattern: "router.push.*session="
---

<objective>
Human verification of the complete Phase 3 auth and persistence flow. Verify the full user journey from sign-up through graph generation, history, and the anonymous trial limit.

Purpose: Confirm that all Phase 3 requirements are working end-to-end in a real browser before marking the phase complete.
Output: Verified working auth flow, graph persistence, history page, and anonymous trial modal.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-auth-persistence/03-CONTEXT.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Phase 3 end-to-end verification</name>
  <action>Human verifies the complete Phase 3 auth and persistence flow in a real browser. No automated action — all prior plans have been executed. This is a verification-only checkpoint.</action>
  <verify>Human confirms all 6 test scenarios below pass.</verify>
  <done>All tests pass and human types "approved".</done>
  <what-built>
    Complete Phase 3 auth and persistence implementation:
    - Clerk authentication with Google OAuth (sign-in/sign-up pages)
    - Auth guard in proxy.ts protecting /app/* routes
    - Bearer token attached to API calls
    - Neo4j nodes with created_by field (AI-05)
    - Supabase graphs table saves on generation
    - Supabase request_log on every API call
    - Graph history page at /app/history (card grid, search, inline rename, delete)
    - Anonymous trial limit with sign-up modal (landing page)
  </what-built>
  <how-to-verify>
    Run the dev stack first:
    ```bash
    pnpm dev
    ```

    **Test 1: Auth guard (AUTH-01)**
    1. Open a private/incognito browser window
    2. Visit http://localhost:3000/app
    3. Expected: Redirected to http://localhost:3000/sign-in
    4. Clerk SignIn component renders with Google OAuth button

    **Test 2: Sign-up and sign-in (AUTH-01)**
    1. Visit http://localhost:3000/sign-up and sign up with Google OAuth
    2. Expected: Redirected to /app after sign-up
    3. Open a new incognito window, visit /sign-in, sign in with same Google account
    4. Expected: Redirected to /app

    **Test 3: Authenticated graph generation + history (AUTH-03, AI-05, FE-03)**
    1. While signed in, generate a graph at /app
    2. Visit http://localhost:3000/app/history
    3. Expected: Graph card appears with auto-title, node count, edge count, relative timestamp
    4. Click the history card
    5. Expected: Navigated to /app?session=UUID with graph loaded on canvas

    **Test 4: History search, rename, delete (FE-03)**
    1. On /app/history, type in the search box — cards filter instantly
    2. Click a card title, type a new name, press Enter — title updates immediately
    3. Hover a card, click trash icon — card removed from list

    **Test 5: Anonymous trial limit (AUTH-02)**
    1. Sign out, visit http://localhost:3000 (landing page)
    2. Generate one graph from the hero input
    3. Try to generate a second graph
    4. Expected: Trial modal — "Sign Up" (goes to /sign-up) and "Maybe Later" (dismisses, input blocked)

    **Test 6: Clerk webhook + Supabase sync (AUTH-03)**
    1. Clerk Dashboard → Webhooks → check delivery log
    2. Expected: Successful user.created delivery
    3. Supabase Dashboard → Table Editor → users table
    4. Expected: Row with your Clerk user_id and email
  </how-to-verify>
  <resume-signal>Type "approved" when all tests pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
All Phase 3 success criteria verified by human tester:
- AUTH-01: Google OAuth sign-in/sign-up, /app/* redirect
- AUTH-02: Anonymous trial modal on second landing page generation
- AUTH-03: users table synced via webhook, graphs table updated per generation
- AUTH-04: request_log table has rows for each API call
- AI-05: Neo4j nodes have created_by field
- FE-03: History page card grid, search, inline rename, delete, navigate to graph
</verification>

<success_criteria>
- Human confirms all 6 tests pass
- No console errors from blocked Clerk domains (CSP issue)
- Google OAuth redirects work end-to-end
- History page correctly shows graphs generated during testing
- Anonymous trial modal appears on second attempt
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-persistence/03-06-SUMMARY.md` following the summary template.
</output>
