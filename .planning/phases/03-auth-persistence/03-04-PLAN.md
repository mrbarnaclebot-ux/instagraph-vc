---
phase: 03-auth-persistence
plan: "04"
type: execute
wave: 2
depends_on:
  - 03-02
files_modified:
  - apps/api/app/generate/router.py
  - apps/api/app/generate/service.py
  - apps/api/app/graph/repository.py
autonomous: true
requirements:
  - AI-05
  - AUTH-03
  - AUTH-04
must_haves:
  truths:
    - "Neo4j graph nodes have created_by field set to user_id or 'anonymous'"
    - "Every POST /api/generate logs a row to Supabase request_log (fire-and-forget)"
    - "Authenticated graph generations save a row to Supabase graphs table"
    - "Auto-title is generated from source URL domain or first 60 chars of text"
    - "Supabase logging failure never blocks the API response"
  artifacts:
    - path: "apps/api/app/graph/repository.py"
      provides: "persist_graph with user_id/created_at fields"
      contains: "created_by"
    - path: "apps/api/app/generate/service.py"
      provides: "run_generate_pipeline with user_id + Supabase graph save"
      contains: "supabase"
    - path: "apps/api/app/generate/router.py"
      provides: "Route handler wiring user_id + supabase to pipeline + request logging"
      contains: "get_supabase_client"
  key_links:
    - from: "apps/api/app/generate/router.py"
      to: "apps/api/app/generate/service.py"
      via: "run_generate_pipeline(user_id=, supabase=)"
      pattern: "run_generate_pipeline.*user_id"
    - from: "apps/api/app/generate/service.py"
      to: "apps/api/app/graph/repository.py"
      via: "persist_graph(user_id=user_id)"
      pattern: "persist_graph.*user_id"
    - from: "apps/api/app/generate/router.py"
      to: "supabase.table('request_log').insert"
      via: "after-handler fire-and-forget"
      pattern: "request_log.*insert"
---

<objective>
Add per-user ownership to Neo4j graph nodes (AI-05), save graph metadata to Supabase graphs table (AUTH-03), and log every API request to Supabase request_log (AUTH-04).

Purpose: The three persistence requirements that build on the Supabase infrastructure from Plan 02. These changes make the app multi-user — each graph is owned by its creator.
Output: Neo4j nodes have created_by+created_at, Supabase graphs row saved per authenticated generation, request_log row saved per API call.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-auth-persistence/03-CONTEXT.md
@.planning/phases/03-auth-persistence/03-RESEARCH.md
@.planning/phases/03-auth-persistence/03-02-SUMMARY.md

<interfaces>
<!-- Key existing code the executor needs. -->

From apps/api/app/graph/repository.py (current — to be modified):
```python
def persist_graph(
    driver: Driver,
    session_id: str,
    nodes: list[dict[str, Any]],
    edges: list[dict[str, Any]],
) -> None:
    # ... UNWIND $nodes CREATE (n:Entity { id, label, type, properties, session_id }) ...
    # MISSING: created_by, created_at fields
```

From apps/api/app/generate/service.py (current — to be modified):
```python
def run_generate_pipeline(
    raw_input: str,
    driver,
) -> dict:
    # ... returns {"graph": ..., "meta": ...}
    # MISSING: user_id param, supabase param, graph metadata save, auto-title
```

From apps/api/app/generate/router.py (current — to be modified):
```python
@router.post("/generate", response_model=GenerateResponse)
async def generate(
    body: GenerateRequest,
    current_user: dict = Depends(get_current_user),
    driver: Driver = Depends(get_neo4j_driver),
) -> GenerateResponse:
    result = run_generate_pipeline(raw_input=body.input, driver=driver)
    return result
    # MISSING: supabase dependency, user_id passing, request logging
```

From apps/api/app/dependencies.py (after Plan 02):
```python
def get_supabase_client(request: Request) -> Client | None:
    return getattr(request.app.state, 'supabase', None)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add created_by field to Neo4j persist_graph (AI-05)</name>
  <files>apps/api/app/graph/repository.py</files>
  <action>
    Update apps/api/app/graph/repository.py — add user_id parameter to persist_graph():

    ```python
    def persist_graph(
        driver: Driver,
        session_id: str,
        nodes: list[dict[str, Any]],
        edges: list[dict[str, Any]],
        user_id: str = "anonymous",  # AI-05: ownership field
    ) -> None:
        """
        Persists graph nodes and relationships to Neo4j (SEC-02, AI-01, AI-05).

        Security: ALL Cypher queries use $param syntax — zero string interpolation.
        Scope: All nodes/edges get session_id property for query isolation.
        Ownership: created_by = user_id (Clerk user_id or "anonymous" for trial graphs).
        Pattern: Uses UNWIND for batch writes — single query per node/edge batch.
        """
        serialized_nodes = [
            {**n, "properties": json.dumps(n.get("properties") or {})}
            for n in nodes
        ]

        with driver.session() as session:
            # Persist nodes with created_by (AI-05) and created_at
            session.run(
                """
                UNWIND $nodes AS node
                CREATE (n:Entity {
                    id:         node.id,
                    label:      node.label,
                    type:       node.type,
                    properties: node.properties,
                    session_id: $session_id,
                    created_by: $user_id,
                    created_at: datetime()
                })
                """,
                nodes=serialized_nodes,
                session_id=session_id,
                user_id=user_id,  # parameterized — never interpolated
            )

            # Edges unchanged — relationship type is stored as property (SEC-02)
            session.run(
                """
                UNWIND $edges AS edge
                MATCH (s:Entity {id: edge.source, session_id: $session_id})
                MATCH (t:Entity {id: edge.target, session_id: $session_id})
                CREATE (s)-[r:RELATES_TO {
                    type:       edge.relationship,
                    session_id: $session_id
                }]->(t)
                """,
                edges=edges,
                session_id=session_id,
            )
    ```

    The `get_graph_by_session` function does NOT need to change — it selects by session_id only and doesn't need to expose created_by to the frontend.

    CRITICAL: user_id is passed as a $user_id parameter — never string-interpolated. This maintains SEC-02 (no Cypher injection).
  </action>
  <verify>
    ```bash
    grep "created_by" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/api/app/graph/repository.py" && grep "user_id" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/api/app/graph/repository.py"
    ```
    repository.py has created_by in the Cypher query and user_id parameter.
  </verify>
  <done>persist_graph() accepts user_id parameter with "anonymous" default. Cypher CREATE includes created_by: $user_id and created_at: datetime(). user_id is parameterized (not interpolated).</done>
</task>

<task type="auto">
  <name>Task 2: Wire user_id + Supabase persistence into router and service (AUTH-03, AUTH-04)</name>
  <files>apps/api/app/generate/service.py, apps/api/app/generate/router.py</files>
  <action>
    Update apps/api/app/generate/service.py — add user_id and supabase parameters, auto-title, graph metadata save:

    ```python
    import time
    import uuid
    from urllib.parse import urlparse
    from datetime import datetime
    from openai import OpenAI

    from app.config import settings
    from app.generate.schemas import VCKnowledgeGraph
    from app.generate.prompts import SYSTEM_PROMPT
    from app.scraper.scraper import scrape_url
    from app.scraper.ssrf import validate_input_length
    from app.graph.repository import persist_graph

    _openai_client: OpenAI | None = None


    def _get_openai_client() -> OpenAI:
        global _openai_client
        if _openai_client is None:
            _openai_client = OpenAI(api_key=settings.openai_api_key)
        return _openai_client


    def _auto_title(raw_input: str) -> str:
        """
        Generate a display title for a graph (CONTEXT.md: Graph naming locked decision).
        - URL inputs: "domain.com · Feb 27"
        - Text inputs: first 60 chars, truncated with ellipsis if longer
        """
        if raw_input.strip().startswith("https://"):
            domain = urlparse(raw_input.strip()).netloc.removeprefix("www.")
            date_str = datetime.now().strftime("%b %-d")  # e.g. "Feb 27"
            return f"{domain} · {date_str}"
        else:
            text = raw_input.strip()
            return (text[:60] + "...") if len(text) > 60 else text


    def run_generate_pipeline(
        raw_input: str,
        driver,
        user_id: str = "anonymous",    # AI-05: graph ownership
        supabase=None,                  # AUTH-03/04: pass app.state.supabase or None
    ) -> dict:
        """
        Full generate pipeline (AI-01, AI-02, AI-03, AI-04, AI-05).
        Now accepts user_id for graph ownership and supabase for metadata persistence.
        """
        start_ms = int(time.time() * 1000)
        session_id = str(uuid.uuid4())

        if raw_input.strip().startswith("https://"):
            source_type = "url"
            content = scrape_url(raw_input.strip())
        else:
            source_type = "text"
            validate_input_length(raw_input)
            content = raw_input[:32_000]

        # ... GPT-4o call unchanged ...
        client = _get_openai_client()
        try:
            response = client.beta.chat.completions.parse(
                model="gpt-4o",
                messages=[
                    {"role": "system", "content": SYSTEM_PROMPT},
                    {"role": "user", "content": content},
                ],
                response_format=VCKnowledgeGraph,
            )
        except Exception as e:
            from fastapi import HTTPException
            from openai import RateLimitError, AuthenticationError, APIStatusError
            if isinstance(e, RateLimitError):
                raise HTTPException(status_code=429, detail={"error": "rate_limited", "message": "Too many requests — please try again in a moment"})
            if isinstance(e, AuthenticationError):
                raise HTTPException(status_code=503, detail={"error": "service_unavailable", "message": "AI service configuration error — please try again later"})
            if isinstance(e, APIStatusError) and e.status_code == 400:
                raise HTTPException(status_code=400, detail={"error": "invalid_request", "message": "Input could not be processed — try shortening or rephrasing it"})
            raise HTTPException(status_code=503, detail={"error": "service_unavailable", "message": "AI service unavailable — please try again"})

        parsed: VCKnowledgeGraph = response.choices[0].message.parsed
        token_count: int = response.usage.total_tokens

        nodes = [node.model_dump(exclude_none=True) for node in parsed.nodes]
        edges = [edge.model_dump() for edge in parsed.edges]

        # Persist to Neo4j with ownership (AI-05)
        try:
            persist_graph(driver, session_id=session_id, nodes=nodes, edges=edges, user_id=user_id)
        except Exception:
            from fastapi import HTTPException
            raise HTTPException(status_code=503, detail={"error": "service_unavailable", "message": "Graph database unavailable — please try again"})

        # AUTH-03: Save graph metadata to Supabase (authenticated users only)
        if supabase is not None and user_id != "anonymous":
            title = _auto_title(raw_input)
            try:
                supabase.table("graphs").insert({
                    "user_id": user_id,
                    "title": title,
                    "source_url": raw_input.strip() if raw_input.strip().startswith("https://") else None,
                    "node_count": len(nodes),
                    "edge_count": len(edges),
                    "neo4j_session_id": session_id,
                }).execute()
            except Exception:
                pass  # Fire-and-forget — graph save failure must not fail the request

        processing_ms = int(time.time() * 1000) - start_ms

        return {
            "graph": {"nodes": nodes, "edges": edges},
            "meta": {
                "session_id": session_id,
                "token_count": token_count,
                "source_type": source_type,
                "processing_ms": processing_ms,
            },
        }
    ```

    Update apps/api/app/generate/router.py — add supabase dependency, user_id extraction, request logging:

    ```python
    import time
    from fastapi import APIRouter, Depends, Request
    from neo4j import Driver

    from app.dependencies import get_current_user, get_neo4j_driver, get_supabase_client
    from app.generate.schemas import GenerateRequest, GenerateResponse
    from app.generate.service import run_generate_pipeline

    router = APIRouter(prefix="/api", tags=["generate"])


    @router.post("/generate", response_model=GenerateResponse)
    async def generate(
        request: Request,
        body: GenerateRequest,
        current_user: dict = Depends(get_current_user),
        driver: Driver = Depends(get_neo4j_driver),
        supabase=Depends(get_supabase_client),
    ) -> GenerateResponse:
        """
        Generate a VC knowledge graph from text or URL input.
        AUTH-04: Logs every request to Supabase request_log (fire-and-forget).
        AI-05: Passes user_id for graph ownership in Neo4j.
        AUTH-03: run_generate_pipeline saves graph metadata to Supabase graphs table.
        """
        start = time.time()
        user_id = current_user.get("sub", "anonymous")

        result = run_generate_pipeline(
            raw_input=body.input,
            driver=driver,
            user_id=user_id,
            supabase=supabase,
        )

        processing_ms = int((time.time() - start) * 1000)

        # AUTH-04: Log request to Supabase (fire-and-forget — failure must not affect response)
        if supabase is not None:
            try:
                supabase.table("request_log").insert({
                    "user_id": user_id,
                    "endpoint": "/api/generate",
                    "source_url": body.input.strip() if body.input.strip().startswith("https://") else None,
                    "ip": request.client.host if request.client else None,
                    "status_code": 200,
                    "tokens_used": result["meta"]["token_count"],
                    "processing_ms": processing_ms,
                }).execute()
            except Exception:
                pass  # Fire-and-forget

        return result
    ```

    Note: processing_ms in the request log may differ slightly from the meta value (router measures total handler time including Supabase graph insert, service measures only pipeline). This is acceptable — it's for billing/debugging, not strict timing.
  </action>
  <verify>
    ```bash
    grep "user_id" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/api/app/generate/service.py" | head -5 && grep "request_log" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/api/app/generate/router.py"
    ```
    service.py has user_id in run_generate_pipeline. router.py has request_log insert.
  </verify>
  <done>run_generate_pipeline accepts user_id and supabase params. Graphs table row inserted for authenticated users. request_log row inserted after every call. All Supabase operations are fire-and-forget (wrapped in try/except with bare pass). router.py imports get_supabase_client from dependencies.</done>
</task>

</tasks>

<verification>
```bash
cd "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/api" && python -c "
from app.generate.service import run_generate_pipeline, _auto_title
# Test auto-title
assert 'techcrunch.com' in _auto_title('https://techcrunch.com/funding/round-a')
text_title = _auto_title('Paradigm led a Series B round in Uniswap raising 100m dollars')
assert len(text_title) <= 63  # 60 chars + ellipsis
print('auto_title ok')
"
```
Auto-title logic works correctly.

```bash
grep "created_by" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/api/app/graph/repository.py"
```
Neo4j query has created_by field.
</verification>

<success_criteria>
- persist_graph() has user_id parameter (default "anonymous"), Neo4j nodes get created_by: $user_id and created_at: datetime()
- run_generate_pipeline() has user_id and supabase parameters; saves graphs row for authenticated users
- _auto_title() generates "domain · Month Day" for URLs, truncated text for paste inputs
- POST /api/generate logs to request_log with user_id, endpoint, source_url, ip, status_code, tokens_used
- All Supabase operations are fire-and-forget (never raise)
- Python imports without error
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-persistence/03-04-SUMMARY.md` following the summary template.
</output>
