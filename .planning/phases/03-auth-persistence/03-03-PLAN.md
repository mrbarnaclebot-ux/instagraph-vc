---
phase: 03-auth-persistence
plan: "03"
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - apps/web/app/sign-in/[[...sign-in]]/page.tsx
  - apps/web/app/sign-up/[[...sign-up]]/page.tsx
  - apps/web/lib/api.ts
  - apps/web/app/app/page.tsx
autonomous: true
requirements:
  - AUTH-01
must_haves:
  truths:
    - "User can sign in with Google OAuth at /sign-in"
    - "User can sign up at /sign-up — Clerk <SignUp /> rendered with Google-only provider"
    - "After sign-in user lands at /app"
    - "Authenticated API calls include Authorization: Bearer <token> header"
    - "Unauthenticated generateGraph calls fail gracefully (401 from FastAPI handled)"
  artifacts:
    - path: "apps/web/app/sign-in/[[...sign-in]]/page.tsx"
      provides: "Custom sign-in page with Clerk <SignIn /> component"
      contains: "SignIn"
    - path: "apps/web/app/sign-up/[[...sign-up]]/page.tsx"
      provides: "Custom sign-up page with Clerk <SignUp /> component"
      contains: "SignUp"
    - path: "apps/web/lib/api.ts"
      provides: "generateGraph with optional Bearer token parameter"
      contains: "getToken"
    - path: "apps/web/app/app/page.tsx"
      provides: "AppPage using useAuth().getToken() for API calls"
      contains: "useAuth"
  key_links:
    - from: "apps/web/app/app/page.tsx"
      to: "apps/web/lib/api.ts"
      via: "generateGraph(input, signal, getToken)"
      pattern: "generateGraph.*getToken"
    - from: "apps/web/lib/api.ts"
      to: "/api/generate"
      via: "Authorization: Bearer header"
      pattern: "Authorization.*Bearer"
---

<objective>
Replace the existing sign-in/sign-up page stubs with real Clerk <SignIn />/<SignUp /> components at the correct catch-all routes. Update lib/api.ts and app/page.tsx to attach Bearer tokens to API calls.

Purpose: Users can now authenticate with Google OAuth, and authenticated API calls work correctly with the FastAPI JWT validator.
Output: Working sign-in and sign-up pages, Bearer token attached to all generateGraph calls.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-auth-persistence/03-CONTEXT.md
@.planning/phases/03-auth-persistence/03-RESEARCH.md
@.planning/phases/03-auth-persistence/03-01-SUMMARY.md

<interfaces>
<!-- Key existing code the executor needs. -->

From apps/web/app/sign-in/page.tsx (current stub — to DELETE, replace with catch-all):
```typescript
// Existing flat stub at sign-in/page.tsx — must be MOVED/REPLACED
// The new file must be at: sign-in/[[...sign-in]]/page.tsx
// The old sign-in/page.tsx must be deleted (or replaced by the new nested route)
// IMPORTANT: app/sign-in/[[...sign-in]]/page.tsx COEXISTS with the old page.tsx
// Next.js will use the more specific catch-all — but DELETE the old stub to avoid confusion
```

From apps/web/lib/api.ts (current — to be modified):
```typescript
export async function generateGraph(
  input: string,
  signal: AbortSignal,
): Promise<GenerateResponse> {
  const response = await fetch('/api/generate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ input }),
    signal,
  })
  // ... error handling ...
}
```

From apps/web/app/app/page.tsx (current — to be modified):
```typescript
'use client'
// ... imports ...
export default function AppPage() {
  // ...
  const handleSubmit = useCallback(async (input: string, isUrl: boolean) => {
    // ...
    const data = await generateGraph(input, controllerRef.current.signal)
    // ...
  }, [])
  // ...
}
```

From apps/api/app/auth/clerk.py (existing backend — FOR REFERENCE ONLY, not modified):
// Backend validates Authorization: Bearer header via PyJWT + JWKS
// FastAPI get_current_user dependency rejects missing/invalid tokens with 401
// dev_skip_auth=True in .env bypasses JWT validation in dev (allows testing without Clerk setup)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace sign-in/sign-up stubs with Clerk catch-all pages</name>
  <files>apps/web/app/sign-in/[[...sign-in]]/page.tsx, apps/web/app/sign-up/[[...sign-up]]/page.tsx</files>
  <action>
    The existing stubs at `app/sign-in/page.tsx` and `app/sign-up/page.tsx` must be replaced by catch-all routes. The catch-all slug `[[...sign-in]]` is REQUIRED for Clerk's Google OAuth redirect flow — without it, `/sign-in/sso-callback` returns 404.

    Steps:
    1. Delete apps/web/app/sign-in/page.tsx (or overwrite with a redirect)
    2. Create directory: apps/web/app/sign-in/[[...sign-in]]/
    3. Create apps/web/app/sign-in/[[...sign-in]]/page.tsx
    4. Delete apps/web/app/sign-up/page.tsx
    5. Create directory: apps/web/app/sign-up/[[...sign-up]]/
    6. Create apps/web/app/sign-up/[[...sign-up]]/page.tsx

    apps/web/app/sign-in/[[...sign-in]]/page.tsx:
    ```typescript
    import { SignIn } from '@clerk/nextjs'
    import Link from 'next/link'

    export default function SignInPage() {
      return (
        <div className="min-h-screen bg-gray-950 text-gray-100 flex flex-col">
          {/* Nav — keep branding consistent */}
          <nav className="border-b border-gray-800/60 bg-gray-950/90 backdrop-blur-sm">
            <div className="mx-auto max-w-7xl px-6 h-14 flex items-center justify-between">
              <Link href="/" className="text-white font-bold text-base tracking-tight">
                GraphVC
              </Link>
              <Link
                href="/sign-up"
                className="text-sm text-gray-400 hover:text-white transition-colors"
              >
                No account?{' '}
                <span className="text-indigo-400 hover:text-indigo-300">Sign up</span>
              </Link>
            </div>
          </nav>

          {/* Centered Clerk SignIn component */}
          <div className="flex-1 flex items-center justify-center px-6 py-16 relative overflow-hidden">
            {/* Background glow */}
            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
              <div className="w-96 h-96 bg-indigo-600/8 rounded-full blur-3xl" />
            </div>

            <div className="relative z-10">
              <SignIn
                appearance={{
                  elements: {
                    rootBox: 'w-full',
                    card: 'bg-gray-900 border border-gray-800 rounded-2xl shadow-2xl',
                    headerTitle: 'text-white',
                    headerSubtitle: 'text-gray-400',
                    socialButtonsBlockButton: 'bg-gray-800 border border-gray-700 text-white hover:bg-gray-700',
                    formFieldInput: 'bg-gray-800 border-gray-700 text-white',
                    footerActionLink: 'text-indigo-400 hover:text-indigo-300',
                  },
                }}
              />
            </div>
          </div>
        </div>
      )
    }
    ```

    apps/web/app/sign-up/[[...sign-up]]/page.tsx:
    ```typescript
    import { SignUp } from '@clerk/nextjs'
    import Link from 'next/link'

    export default function SignUpPage() {
      return (
        <div className="min-h-screen bg-gray-950 text-gray-100 flex flex-col">
          <nav className="border-b border-gray-800/60 bg-gray-950/90 backdrop-blur-sm">
            <div className="mx-auto max-w-7xl px-6 h-14 flex items-center justify-between">
              <Link href="/" className="text-white font-bold text-base tracking-tight">
                GraphVC
              </Link>
              <Link
                href="/sign-in"
                className="text-sm text-gray-400 hover:text-white transition-colors"
              >
                Already have an account?{' '}
                <span className="text-indigo-400 hover:text-indigo-300">Sign in</span>
              </Link>
            </div>
          </nav>

          <div className="flex-1 flex items-center justify-center px-6 py-16 relative overflow-hidden">
            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
              <div className="w-96 h-96 bg-indigo-600/8 rounded-full blur-3xl" />
            </div>

            <div className="relative z-10">
              <SignUp
                appearance={{
                  elements: {
                    rootBox: 'w-full',
                    card: 'bg-gray-900 border border-gray-800 rounded-2xl shadow-2xl',
                    headerTitle: 'text-white',
                    headerSubtitle: 'text-gray-400',
                    socialButtonsBlockButton: 'bg-gray-800 border border-gray-700 text-white hover:bg-gray-700',
                    formFieldInput: 'bg-gray-800 border-gray-700 text-white',
                    footerActionLink: 'text-indigo-400 hover:text-indigo-300',
                  },
                }}
              />
            </div>
          </div>
        </div>
      )
    }
    ```

    Per CONTEXT.md locked decisions:
    - Google OAuth only (no email/password UI — Clerk shows only providers configured in the dashboard)
    - After sign-in redirect to /app (handled via NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL env var, not in code)
    - Custom branded pages (not Clerk-hosted redirect)

    IMPORTANT: The old flat page.tsx files MUST be deleted. If both flat page.tsx and [[...sign-in]]/page.tsx exist, Next.js will conflict. Delete the old stubs.
  </action>
  <verify>
    ```bash
    ls "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/sign-in/[[...sign-in]]/" && grep "SignIn" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/sign-in/[[...sign-in]]/page.tsx"
    ```
    Catch-all directory exists and page contains SignIn component.
  </verify>
  <done>apps/web/app/sign-in/[[...sign-in]]/page.tsx exists with <SignIn /> component using dark theme appearance overrides. apps/web/app/sign-up/[[...sign-up]]/page.tsx exists with <SignUp /> component. Old flat page.tsx stubs deleted. TypeScript compiles without error.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Bearer token to API calls (lib/api.ts + app/page.tsx)</name>
  <files>apps/web/lib/api.ts, apps/web/app/app/page.tsx</files>
  <action>
    The FastAPI backend reads Authorization: Bearer headers — it does NOT receive Clerk session cookies. The Next.js rewrite proxy forwards requests server-side, so cookies are not accessible to FastAPI. The client must explicitly get the JWT and attach it.

    Update apps/web/lib/api.ts — add optional getToken parameter to generateGraph:
    ```typescript
    import type { GenerateResponse, APIError } from '@graphvc/shared-types'

    export class GraphAPIError extends Error {
      // ... unchanged ...
    }

    export async function generateGraph(
      input: string,
      signal: AbortSignal,
      getToken?: (() => Promise<string | null>) | null,  // optional — anonymous callers pass null
    ): Promise<GenerateResponse> {
      const token = getToken ? await getToken() : null

      const response = await fetch('/api/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { Authorization: `Bearer ${token}` } : {}),
        },
        body: JSON.stringify({ input }),
        signal,
      })

      if (!response.ok) {
        let detail: APIError = { error: 'unknown_error', message: `HTTP ${response.status}` }
        try {
          detail = await response.json()
        } catch {
          // non-JSON error body — keep default
        }
        throw new GraphAPIError(response.status, detail)
      }

      const data: GenerateResponse = await response.json()
      return data
    }
    ```

    Update apps/web/app/app/page.tsx — import useAuth, pass getToken to generateGraph:
    ```typescript
    'use client'

    import { useAuth } from '@clerk/nextjs'
    import dynamic from 'next/dynamic'
    import { useState, useRef, useCallback } from 'react'
    // ... rest of imports unchanged ...

    export default function AppPage() {
      const { getToken } = useAuth()  // ADD THIS LINE

      const [status, setStatus] = useState<Status>('idle')
      // ... rest of state unchanged ...

      const handleSubmit = useCallback(async (input: string, isUrl: boolean) => {
        controllerRef.current?.abort()
        controllerRef.current = new AbortController()

        setLastInput({ value: input, isUrl })
        setStatus('loading')
        setInputCollapsed(true)
        setSelectedNodeId(null)

        try {
          // CHANGE: pass getToken as third argument
          const data = await generateGraph(input, controllerRef.current.signal, getToken)
          // ... rest unchanged ...
        } catch (err) {
          // ... unchanged ...
        }
      }, [getToken])  // ADD getToken to dependency array

      // ... rest of component unchanged ...
    }
    ```

    Note on dev_skip_auth: The backend config has `dev_skip_auth: bool = False`. If dev_skip_auth=True in apps/api/.env, the backend skips JWT validation — useful for local dev without Clerk credentials. The Bearer header attachment is still correct regardless.
  </action>
  <verify>
    ```bash
    cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && grep "getToken" apps/web/lib/api.ts && grep "useAuth" apps/web/app/app/page.tsx
    ```
    api.ts has getToken parameter, page.tsx imports useAuth.
  </verify>
  <done>lib/api.ts generateGraph accepts optional getToken parameter and attaches Authorization: Bearer header when token is present. app/app/page.tsx imports useAuth, calls getToken, passes it to generateGraph. TypeScript compiles without error.</done>
</task>

</tasks>

<verification>
```bash
cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && pnpm --filter @graphvc/web typecheck 2>&1 | tail -5
```
TypeScript passes with Clerk SignIn/SignUp, useAuth, and updated generateGraph signature.

```bash
ls "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/sign-in/[[...sign-in]]/page.tsx" && ls "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/sign-up/[[...sign-up]]/page.tsx"
```
Both catch-all page files exist.

```bash
test ! -f "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/sign-in/page.tsx" && echo "old stub deleted" || echo "WARNING: old stub still exists"
```
Old flat stubs deleted.
</verification>

<success_criteria>
- apps/web/app/sign-in/[[...sign-in]]/page.tsx with <SignIn /> component (Google OAuth, dark theme)
- apps/web/app/sign-up/[[...sign-up]]/page.tsx with <SignUp /> component
- Old flat sign-in/page.tsx and sign-up/page.tsx deleted
- lib/api.ts generateGraph has optional getToken parameter, attaches Bearer header when present
- app/app/page.tsx uses useAuth().getToken() and passes it to generateGraph
- pnpm typecheck passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-persistence/03-03-SUMMARY.md` following the summary template.
</output>
