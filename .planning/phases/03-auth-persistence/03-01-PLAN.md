---
phase: 03-auth-persistence
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/proxy.ts
  - apps/web/app/layout.tsx
  - apps/web/next.config.ts
autonomous: true
requirements:
  - AUTH-01
must_haves:
  truths:
    - "All /app/* routes redirect unauthenticated users to /sign-in"
    - "Clerk context is available throughout the Next.js app"
    - "CSP headers allow Clerk domains (no console errors from blocked Clerk requests)"
    - "Webpack/Turbopack builds without error after @clerk/nextjs install"
  artifacts:
    - path: "apps/web/proxy.ts"
      provides: "Clerk auth guard for Next.js 16"
      contains: "clerkMiddleware"
    - path: "apps/web/app/layout.tsx"
      provides: "ClerkProvider wrapping entire app"
      contains: "ClerkProvider"
    - path: "apps/web/next.config.ts"
      provides: "Updated CSP allowing Clerk domains"
      contains: "clerk.com"
  key_links:
    - from: "apps/web/proxy.ts"
      to: "/app/* routes"
      via: "clerkMiddleware + createRouteMatcher"
      pattern: "auth\\.protect"
    - from: "apps/web/app/layout.tsx"
      to: "ClerkProvider"
      via: "wrapping PostHogProvider"
      pattern: "ClerkProvider"
user_setup:
  - service: clerk
    why: "Clerk authentication — sign-in/sign-up with Google OAuth"
    env_vars:
      - name: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard -> API Keys -> Publishable key"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard -> API Keys -> Secret key"
      - name: NEXT_PUBLIC_CLERK_SIGN_IN_URL
        source: "Set to: /sign-in"
      - name: NEXT_PUBLIC_CLERK_SIGN_UP_URL
        source: "Set to: /sign-up"
      - name: NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL
        source: "Set to: /app"
      - name: NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL
        source: "Set to: /app"
      - name: NEXT_PUBLIC_CLERK_FRONTEND_API
        source: "Clerk Dashboard -> API Keys -> Frontend API (e.g. clerk.your-domain.com or <clerk-instance>.clerk.accounts.dev)"
    dashboard_config:
      - task: "Enable Google OAuth provider"
        location: "Clerk Dashboard -> User & Authentication -> Social Connections -> Google -> Enable"
      - task: "Set allowed redirect URLs"
        location: "Clerk Dashboard -> Paths -> Set Sign-in URL to /sign-in and Sign-up URL to /sign-up"
---

<objective>
Install @clerk/nextjs, create the Next.js 16 proxy.ts auth guard, wrap the root layout in ClerkProvider, and update the CSP to allow Clerk domains.

Purpose: Auth infrastructure foundation — everything in Phase 3 depends on Clerk being installed and the route guard being active.
Output: Working Clerk install, proxy.ts protecting /app/*, ClerkProvider in layout, CSP updated.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-auth-persistence/03-CONTEXT.md
@.planning/phases/03-auth-persistence/03-RESEARCH.md

<interfaces>
<!-- Key existing patterns the executor needs. -->

From apps/web/app/layout.tsx (current — to be modified):
```typescript
// Currently wraps children with PostHogProvider only
// Must wrap outer with ClerkProvider BEFORE PostHogProvider
export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" className="dark">
      <body ...>
        <PostHogProvider>
          {children}
          <Toaster richColors position="top-right" />
        </PostHogProvider>
      </body>
    </html>
  )
}
```

From apps/web/next.config.ts (current CSP — to be updated):
```typescript
// connect-src currently: 'self' https://us.i.posthog.com https://us-assets.i.posthog.com
// script-src currently: 'self' 'unsafe-inline' (+ 'unsafe-eval' in dev)
// img-src currently: 'self' blob: data:
// Missing: Clerk domains in connect-src, script-src, img-src, frame-src
// NEXT_PUBLIC_CLERK_FRONTEND_API env var holds the Clerk frontend API hostname
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @clerk/nextjs and create proxy.ts auth guard</name>
  <files>apps/web/package.json, apps/web/proxy.ts</files>
  <action>
    Install @clerk/nextjs@6.38.0 in the web workspace:
    ```
    cd apps/web && pnpm add @clerk/nextjs@6.38.0
    ```

    Create apps/web/proxy.ts (NOT middleware.ts — project uses Next.js 16.1.6 which uses proxy.ts):
    ```typescript
    import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server'

    // Public routes — everything else (including /app/*) is protected
    const isPublicRoute = createRouteMatcher([
      '/',
      '/sign-in(.*)',
      '/sign-up(.*)',
      '/privacy(.*)',
      '/terms(.*)',
      '/api/webhooks/(.*)',  // Clerk webhook must be public (no Clerk session)
    ])

    export default clerkMiddleware(async (auth, req) => {
      if (!isPublicRoute(req)) {
        await auth.protect()
      }
    })

    export const config = {
      matcher: [
        '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
        '/(api|trpc)(.*)',
      ],
    }
    ```

    Per CONTEXT.md: after sign-in redirect goes to /app. Clerk handles this via NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL env var. The proxy.ts calls auth.protect() on all non-public routes — unauthenticated requests to /app/* will redirect to /sign-in with ?redirect_url preserved.

    CRITICAL: Do NOT create middleware.ts. Next.js 16 uses proxy.ts. middleware.ts is silently ignored in Next.js 16 and Clerk auth guard will not work.
  </action>
  <verify>
    ```bash
    cd "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web" && ls proxy.ts && grep -l "clerkMiddleware" proxy.ts
    ```
    proxy.ts exists and contains clerkMiddleware.
  </verify>
  <done>proxy.ts exists with clerkMiddleware export default, isPublicRoute matcher covers /, /sign-in, /sign-up, /privacy, /terms, /api/webhooks/. @clerk/nextjs appears in apps/web/package.json.</done>
</task>

<task type="auto">
  <name>Task 2: Wrap layout in ClerkProvider and update CSP for Clerk domains</name>
  <files>apps/web/app/layout.tsx, apps/web/next.config.ts</files>
  <action>
    Update apps/web/app/layout.tsx to wrap the entire app with ClerkProvider:
    ```typescript
    import type { Metadata } from 'next'
    import { Geist, Geist_Mono } from 'next/font/google'
    import { ClerkProvider } from '@clerk/nextjs'
    import { Toaster } from 'sonner'
    import { PostHogProvider } from './providers'
    import './globals.css'

    // ... font declarations unchanged ...

    export default function RootLayout({ children }: { children: React.ReactNode }) {
      return (
        <ClerkProvider>
          <html lang="en" className="dark">
            <body className={...}>
              <PostHogProvider>
                {children}
                <Toaster richColors position="top-right" />
              </PostHogProvider>
            </body>
          </html>
        </ClerkProvider>
      )
    }
    ```
    CRITICAL: ClerkProvider goes OUTSIDE <html> — it wraps the html element, not inside body. ClerkProvider does NOT require 'use client' — it works in Server Components.

    Update apps/web/next.config.ts CSP to allow Clerk domains. The NEXT_PUBLIC_CLERK_FRONTEND_API env var holds the hostname (e.g. "clerk.your-domain.com" or "amazing-slug-42.clerk.accounts.dev"):
    ```typescript
    // Add to securityHeaders CSP:
    // script-src: add https://${process.env.NEXT_PUBLIC_CLERK_FRONTEND_API} https://challenges.cloudflare.com
    // connect-src: add https://${process.env.NEXT_PUBLIC_CLERK_FRONTEND_API}
    // img-src: add https://img.clerk.com
    // frame-src: add (new directive) https://challenges.cloudflare.com
    ```

    Full updated CSP value array:
    ```typescript
    const clerkFrontendApi = process.env.NEXT_PUBLIC_CLERK_FRONTEND_API ?? ''
    const securityHeaders = [
      { key: 'X-Frame-Options', value: 'SAMEORIGIN' },
      { key: 'X-Content-Type-Options', value: 'nosniff' },
      { key: 'X-XSS-Protection', value: '1; mode=block' },
      {
        key: 'Content-Security-Policy',
        value: [
          "default-src 'self'",
          `script-src 'self' 'unsafe-inline'${isDev ? " 'unsafe-eval'" : ''}${clerkFrontendApi ? ` https://${clerkFrontendApi}` : ''} https://challenges.cloudflare.com`,
          "style-src 'self' 'unsafe-inline'",
          `connect-src 'self' https://us.i.posthog.com https://us-assets.i.posthog.com${clerkFrontendApi ? ` https://${clerkFrontendApi}` : ''}`,
          "img-src 'self' blob: data: https://img.clerk.com",
          "font-src 'self'",
          "object-src 'none'",
          "base-uri 'self'",
          "form-action 'self'",
          "frame-ancestors 'self'",
          "frame-src https://challenges.cloudflare.com",
        ].join('; '),
      },
    ]
    ```
    Note: Remove the old `const isDev = ...` line if it already exists and just reference process.env.NODE_ENV directly, or keep it — doesn't matter. Preserve all existing rewrites and withSentryConfig wrapping.
  </action>
  <verify>
    ```bash
    cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && grep -l "ClerkProvider" apps/web/app/layout.tsx && grep "img.clerk.com" apps/web/next.config.ts
    ```
    layout.tsx contains ClerkProvider import and usage. next.config.ts contains img.clerk.com in CSP.
  </verify>
  <done>layout.tsx imports ClerkProvider from @clerk/nextjs and wraps the html element. next.config.ts CSP includes Clerk frontend API in script-src and connect-src, img.clerk.com in img-src, challenges.cloudflare.com in frame-src.</done>
</task>

</tasks>

<verification>
```bash
cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && pnpm --filter @graphvc/web typecheck 2>&1 | tail -5
```
TypeScript compilation passes with ClerkProvider and proxy.ts in place.

```bash
ls "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/proxy.ts" && grep "clerkMiddleware" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/proxy.ts"
```
proxy.ts exists with auth guard.

```bash
grep "ClerkProvider" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/layout.tsx"
```
ClerkProvider wraps root layout.
</verification>

<success_criteria>
- @clerk/nextjs@6.38.0 in apps/web/package.json
- proxy.ts exists (not middleware.ts) with clerkMiddleware protecting all non-public routes
- /app/*, /api/graphs/* protected; /, /sign-in/*, /sign-up/*, /api/webhooks/* public
- ClerkProvider wraps html element in root layout (outside PostHogProvider)
- CSP updated with Clerk domains (no Refused to connect/load errors from Clerk)
- pnpm typecheck passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-persistence/03-01-SUMMARY.md` following the summary template.
</output>
