---
phase: 03-auth-persistence
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/app/config.py
  - apps/api/app/main.py
  - apps/api/app/dependencies.py
  - apps/web/app/api/webhooks/clerk/route.ts
  - apps/web/lib/supabase.ts
autonomous: true
requirements:
  - AUTH-03
  - AUTH-04
must_haves:
  truths:
    - "Supabase client initializes once in FastAPI lifespan (singleton, never per-request)"
    - "FastAPI has supabase_url and supabase_key settings in config"
    - "get_supabase_client dependency returns the singleton from app.state"
    - "Next.js Route Handler at /api/webhooks/clerk handles user.created events"
    - "Supabase users table gets upserted on user.created webhook"
  artifacts:
    - path: "apps/api/app/config.py"
      provides: "supabase_url and supabase_key settings"
      contains: "supabase_url"
    - path: "apps/api/app/main.py"
      provides: "Supabase singleton in lifespan"
      contains: "app.state.supabase"
    - path: "apps/api/app/dependencies.py"
      provides: "get_supabase_client dependency"
      contains: "get_supabase_client"
    - path: "apps/web/app/api/webhooks/clerk/route.ts"
      provides: "Clerk webhook handler — upserts users table"
      contains: "verifyWebhook"
    - path: "apps/web/lib/supabase.ts"
      provides: "Supabase client factory for Next.js Route Handlers"
      contains: "createClient"
  key_links:
    - from: "apps/api/app/main.py"
      to: "app.state.supabase"
      via: "lifespan create_client()"
      pattern: "app\\.state\\.supabase"
    - from: "apps/web/app/api/webhooks/clerk/route.ts"
      to: "supabase.from('users').upsert"
      via: "verifyWebhook + user.created event"
      pattern: "from\\('users'\\)\\.upsert"
user_setup:
  - service: supabase
    why: "Tabular metadata storage — users, graphs, request_log tables"
    env_vars:
      - name: SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key (or sb_secret_... for new projects)"
      - name: CLERK_WEBHOOK_SIGNING_SECRET
        source: "Clerk Dashboard -> Webhooks -> Add Endpoint (point to https://your-domain/api/webhooks/clerk) -> Signing Secret (whsec_...)"
    dashboard_config:
      - task: "Run Supabase SQL schema"
        location: "Supabase Dashboard -> SQL Editor — run the CREATE TABLE statements from this plan's action"
      - task: "Create Clerk webhook endpoint"
        location: "Clerk Dashboard -> Webhooks -> Add Endpoint -> URL: https://your-domain/api/webhooks/clerk -> Select: user.created event"
---

<objective>
Set up the Supabase persistence layer on both the FastAPI backend (Supabase singleton in lifespan, get_supabase_client dependency) and Next.js frontend (webhook handler for user sync). Does NOT yet wire the request logging or graph saving — those come in Plan 04. This plan establishes the infrastructure.

Purpose: Supabase schema + client singletons must exist before Plan 03 (auth wiring) and Plan 04 (request logging + graph save) can consume them.
Output: Supabase tables created (SQL in action), FastAPI supabase client singleton, Next.js Supabase client utility, Clerk webhook Route Handler upserts users table.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-auth-persistence/03-CONTEXT.md
@.planning/phases/03-auth-persistence/03-RESEARCH.md

<interfaces>
<!-- Key existing patterns the executor needs. -->

From apps/api/app/config.py (current — to be modified):
```python
class Settings(BaseSettings):
    openai_api_key: str
    neo4j_uri: str = "bolt://localhost:7687"
    neo4j_username: str = "neo4j"
    neo4j_password: str
    clerk_secret_key: str = ""
    clerk_authorized_party: str = ""
    clerk_frontend_api: str = ""
    dev_skip_auth: bool = False
    sentry_dsn: str = ""
    environment: str = "development"
    model_config = {"env_file": ".env"}
```

From apps/api/app/main.py (current lifespan — to be extended):
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    app.state.neo4j_driver = GraphDatabase.driver(
        settings.neo4j_uri,
        auth=(settings.neo4j_username, settings.neo4j_password),
    )
    app.state.neo4j_driver.verify_connectivity()
    with app.state.neo4j_driver.session() as session:
        session.run("CREATE INDEX entity_session_id IF NOT EXISTS FOR (n:Entity) ON (n.session_id)")
    yield
    app.state.neo4j_driver.close()
```

From apps/api/app/dependencies.py (current — to be extended):
```python
from fastapi import Request
from neo4j import Driver
from app.auth.clerk import get_current_user  # noqa: F401

def get_neo4j_driver(request: Request) -> Driver:
    return request.app.state.neo4j_driver
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Supabase backend — config, lifespan singleton, and dependency</name>
  <files>apps/api/app/config.py, apps/api/app/main.py, apps/api/app/dependencies.py</files>
  <action>
    Install supabase-py in the API workspace:
    ```
    cd apps/api && uv add supabase
    ```
    Note: `uv --no-workspace` flag is required per [01-01] decision. Run from the `apps/api` directory, not repo root.

    Update apps/api/app/config.py — add Supabase settings after the existing fields:
    ```python
    # After clerk_frontend_api and dev_skip_auth:
    supabase_url: str = ""
    supabase_key: str = ""  # sb_secret_... or service_role key (server-side only, never anon)
    ```

    Update apps/api/app/main.py — add Supabase client init in lifespan, after Neo4j setup:
    ```python
    from supabase import create_client, Client

    @asynccontextmanager
    async def lifespan(app: FastAPI):
        # Neo4j (existing — unchanged)
        app.state.neo4j_driver = GraphDatabase.driver(...)
        app.state.neo4j_driver.verify_connectivity()
        with app.state.neo4j_driver.session() as session:
            session.run("CREATE INDEX entity_session_id IF NOT EXISTS FOR (n:Entity) ON (n.session_id)")

        # Supabase singleton (AUTH-03, AUTH-04) — only init if configured
        if settings.supabase_url and settings.supabase_key:
            app.state.supabase = create_client(settings.supabase_url, settings.supabase_key)
        else:
            app.state.supabase = None  # Graceful degradation when not configured

        yield
        app.state.neo4j_driver.close()
    ```

    Update apps/api/app/dependencies.py — add get_supabase_client:
    ```python
    from supabase import Client

    def get_supabase_client(request: Request) -> Client | None:
        """Returns the singleton Supabase client from app.state (AUTH-03, AUTH-04).
        Returns None if Supabase is not configured (dev without credentials).
        Never create a new client inside a route handler."""
        return getattr(request.app.state, 'supabase', None)
    ```

    CRITICAL: Follow the same singleton pattern as Neo4j driver (SEC-04 decision). Creating a new Supabase client per-request exhausts connection pools under load. supabase-py creates_client() is synchronous — fits FastAPI sync routes fine.
  </action>
  <verify>
    ```bash
    cd "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/api" && python -c "from app.config import settings; from app.dependencies import get_supabase_client; print('ok')"
    ```
    Python import succeeds (settings and dependency import without error).
  </verify>
  <done>supabase in apps/api/pyproject.toml. config.py has supabase_url and supabase_key. main.py creates Supabase singleton in lifespan. dependencies.py exports get_supabase_client returning Client | None.</done>
</task>

<task type="auto">
  <name>Task 2: Next.js Supabase client + Clerk webhook Route Handler</name>
  <files>apps/web/lib/supabase.ts, apps/web/app/api/webhooks/clerk/route.ts</files>
  <action>
    Install @supabase/supabase-js in the web workspace:
    ```
    cd apps/web && pnpm add @supabase/supabase-js
    ```

    Create apps/web/lib/supabase.ts — server-side Supabase client factory:
    ```typescript
    import { createClient } from '@supabase/supabase-js'

    // Server-side only — uses service role key. Never import in client components.
    // Used by Route Handlers (app/api/**) which run server-side.
    export function createSupabaseAdmin() {
      const url = process.env.SUPABASE_URL
      const key = process.env.SUPABASE_SERVICE_ROLE_KEY

      if (!url || !key) {
        throw new Error('SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY must be set')
      }

      return createClient(url, key, {
        auth: {
          persistSession: false,  // Route Handlers are stateless
          autoRefreshToken: false,
        },
      })
    }
    ```
    Note: This is a factory function (not a singleton) — Next.js Route Handlers can share a module-level singleton. Call once at module top level in each Route Handler file.

    Create apps/web/app/api/webhooks/clerk/route.ts — Clerk user.created webhook handler:
    ```typescript
    import { verifyWebhook } from '@clerk/nextjs/webhooks'
    import { NextRequest, NextResponse } from 'next/server'
    import { createSupabaseAdmin } from '@/lib/supabase'

    // Module-level Supabase client — reused across webhook invocations
    // (Route Handlers are serverless but module caching provides reuse where possible)
    const supabase = createSupabaseAdmin()

    export async function POST(req: NextRequest) {
      try {
        const evt = await verifyWebhook(req)

        if (evt.type === 'user.created') {
          const { id, email_addresses, created_at } = evt.data
          const email = email_addresses[0]?.email_address ?? ''

          const { error } = await supabase.from('users').upsert({
            id,                // Clerk user_id is the primary key
            email,
            plan: 'free',
            created_at: new Date(created_at).toISOString(),
          })

          if (error) {
            console.error('[clerk-webhook] Supabase upsert error:', error)
            // Return 200 to prevent Clerk from retrying non-fatal errors
          }
        }

        return new NextResponse('OK', { status: 200 })
      } catch (err) {
        console.error('[clerk-webhook] Verification failed:', err)
        return new NextResponse('Webhook verification failed', { status: 400 })
      }
    }
    ```

    CRITICAL: This route must be in proxy.ts public routes (covered by Plan 01's `/api/webhooks/(.*)` matcher). The `verifyWebhook()` from `@clerk/nextjs/webhooks` provides its own authentication — do NOT add Clerk session auth here.

    Supabase SQL to run in Supabase Dashboard -> SQL Editor (include in action for executor to surface to user):
    ```sql
    -- Users table — synced from Clerk via user.created webhook
    CREATE TABLE IF NOT EXISTS users (
      id          TEXT PRIMARY KEY,      -- Clerk user_id (e.g. "user_abc123")
      email       TEXT NOT NULL,
      plan        TEXT NOT NULL DEFAULT 'free',
      created_at  TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    -- Graphs table — one row per graph generation for authenticated users
    CREATE TABLE IF NOT EXISTS graphs (
      id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      user_id           TEXT NOT NULL REFERENCES users(id),
      title             TEXT NOT NULL,
      source_url        TEXT,
      node_count        INT NOT NULL DEFAULT 0,
      edge_count        INT NOT NULL DEFAULT 0,
      neo4j_session_id  TEXT NOT NULL,
      created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
    CREATE INDEX IF NOT EXISTS graphs_user_id_created_at ON graphs(user_id, created_at DESC);

    -- Request log — every API call
    CREATE TABLE IF NOT EXISTS request_log (
      id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      user_id       TEXT,
      endpoint      TEXT NOT NULL,
      source_url    TEXT,
      ip            TEXT,
      status_code   INT NOT NULL,
      tokens_used   INT,
      processing_ms INT,
      created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
    CREATE INDEX IF NOT EXISTS request_log_user_id ON request_log(user_id);
    CREATE INDEX IF NOT EXISTS request_log_created_at ON request_log(created_at DESC);
    ```
    Surface this SQL to the user in a `<checkpoint:human-action>` note — they must run it in Supabase Dashboard before testing.
  </action>
  <verify>
    ```bash
    cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && grep -l "verifyWebhook" apps/web/app/api/webhooks/clerk/route.ts && grep -l "createSupabaseAdmin" apps/web/lib/supabase.ts
    ```
    Webhook handler and Supabase client utility both exist.
  </verify>
  <done>@supabase/supabase-js in apps/web/package.json. lib/supabase.ts exports createSupabaseAdmin(). app/api/webhooks/clerk/route.ts handles POST with verifyWebhook + users upsert. TypeScript compiles without error.</done>
</task>

</tasks>

<verification>
```bash
cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && pnpm --filter @graphvc/web typecheck 2>&1 | tail -5
```
TypeScript passes with new webhook route and supabase client.

```bash
cd "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/api" && python -c "from supabase import create_client; print('supabase-py ok')"
```
supabase-py imports without error.
</verification>

<success_criteria>
- supabase-py installed in apps/api; @supabase/supabase-js installed in apps/web
- apps/api/app/config.py has supabase_url and supabase_key fields
- apps/api/app/main.py creates Supabase singleton in lifespan (with graceful no-op when not configured)
- apps/api/app/dependencies.py exports get_supabase_client returning Client | None
- apps/web/lib/supabase.ts exports createSupabaseAdmin factory
- apps/web/app/api/webhooks/clerk/route.ts handles POST, verifies with verifyWebhook, upserts users table
- TypeScript compiles without error
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-persistence/03-02-SUMMARY.md` following the summary template.
</output>
