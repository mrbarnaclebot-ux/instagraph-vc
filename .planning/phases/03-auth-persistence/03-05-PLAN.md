---
phase: 03-auth-persistence
plan: "05"
type: execute
wave: 3
depends_on:
  - 03-03
  - 03-04
files_modified:
  - apps/web/app/api/graphs/route.ts
  - apps/web/app/api/graphs/[id]/route.ts
  - apps/web/app/api/graphs/[id]/rename/route.ts
  - apps/web/app/app/history/page.tsx
  - apps/web/components/history/HistoryCard.tsx
  - apps/web/lib/trial.ts
  - apps/web/components/auth/TrialModal.tsx
  - apps/web/app/app/page.tsx
  - apps/web/app/page.tsx
autonomous: true
requirements:
  - FE-03
  - AUTH-02
must_haves:
  truths:
    - "Authenticated user sees their graph history at /app/history as a card grid"
    - "History cards show title, source URL/input preview, node count, edge count, relative timestamp, and delete button"
    - "User can filter history cards instantly by typing in the search box (client-side)"
    - "Clicking a history card navigates to /app?session=<neo4j_session_id>"
    - "User can rename a graph inline on the history card (click title, edit, Enter/blur to save)"
    - "User can delete their own graph (card removed immediately, server confirmed)"
    - "Anonymous user who has already generated one graph sees a sign-up modal on second attempt"
    - "Trial modal has 'Sign Up' (to /sign-up) and 'Maybe Later' (dismisses) buttons"
    - "localStorage key graphvc_trial_used tracks the one-free-trial state"
  artifacts:
    - path: "apps/web/app/api/graphs/route.ts"
      provides: "GET /api/graphs — list user's graphs"
      contains: "auth()"
    - path: "apps/web/app/api/graphs/[id]/route.ts"
      provides: "DELETE /api/graphs/[id] — delete owned graph"
      contains: "userId"
    - path: "apps/web/app/api/graphs/[id]/rename/route.ts"
      provides: "PATCH /api/graphs/[id]/rename — rename graph title"
      contains: "title"
    - path: "apps/web/app/app/history/page.tsx"
      provides: "Graph history page — card grid, search, empty state"
      contains: "HistoryCard"
    - path: "apps/web/components/history/HistoryCard.tsx"
      provides: "History card component with inline rename, delete, nav"
      contains: "inline"
    - path: "apps/web/lib/trial.ts"
      provides: "localStorage trial flag utilities"
      contains: "graphvc_trial_used"
    - path: "apps/web/components/auth/TrialModal.tsx"
      provides: "Sign-up prompt modal for anonymous second attempt"
      contains: "Sign Up"
  key_links:
    - from: "apps/web/app/app/history/page.tsx"
      to: "/api/graphs"
      via: "fetch on mount"
      pattern: "fetch.*api/graphs"
    - from: "apps/web/components/history/HistoryCard.tsx"
      to: "/app?session="
      via: "router.push on card click"
      pattern: "session="
    - from: "apps/web/app/app/page.tsx"
      to: "apps/web/lib/trial.ts"
      via: "isTrialUsed() check before submit"
      pattern: "isTrialUsed"
    - from: "apps/web/app/page.tsx"
      to: "apps/web/lib/trial.ts"
      via: "isTrialUsed() check in HeroSection"
      pattern: "isTrialUsed"
---

<objective>
Build the graph history page (/app/history) with its API Route Handlers, anonymous trial limit logic with sign-up modal, and inline rename. This is the final feature plane of Phase 3 — after this, the app is a real multi-user product.

Purpose: Users can browse, search, rename, and delete their saved graphs. Anonymous users are gently prompted to sign up after their one free trial.
Output: /app/history page with card grid and search; /api/graphs Route Handlers; lib/trial.ts; TrialModal component; trial check wired to /app and landing page HeroSection.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-auth-persistence/03-CONTEXT.md
@.planning/phases/03-auth-persistence/03-RESEARCH.md
@.planning/phases/03-auth-persistence/03-03-SUMMARY.md
@.planning/phases/03-auth-persistence/03-04-SUMMARY.md

<interfaces>
<!-- Key existing patterns the executor needs. -->

From apps/web/app/app/page.tsx (after Plan 03 modifications):
```typescript
// Already has: useAuth(), generateGraph(input, signal, getToken)
// Needs: isTrialUsed() check before submit, markTrialUsed() after success
// Needs: showTrialModal state, TrialModal component render
// useSignIn hook NOT needed — user must be signed in to reach /app (auth guard from proxy.ts)
// But AUTH-02 says trial applies to /app too — however, per Research open question 2,
// with auth guard live, /app requires auth. The trial only applies to / landing page.
// DECISION (per 03-RESEARCH.md open question 2): Trial check on /app is moot —
// unauthenticated users are redirected to /sign-in before reaching /app.
// Only wire trial check to landing page HeroSection (/).
```

From apps/web/components/landing/HeroSection.tsx (current — to be modified for trial):
```typescript
// Current HeroSection likely has an input + submit button for anonymous trial
// Need to add: useSignIn (Clerk), isTrialUsed() check, markTrialUsed() after success
// If trial used and not signed in: show TrialModal instead of generating
```

Supabase graphs table shape (from Plan 02 SQL):
```typescript
interface GraphRow {
  id: string          // UUID
  user_id: string     // Clerk user_id
  title: string
  source_url: string | null
  node_count: number
  edge_count: number
  neo4j_session_id: string
  created_at: string  // ISO timestamp
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Graph history API Route Handlers (GET, DELETE, PATCH rename)</name>
  <files>apps/web/app/api/graphs/route.ts, apps/web/app/api/graphs/[id]/route.ts, apps/web/app/api/graphs/[id]/rename/route.ts</files>
  <action>
    Create apps/web/app/api/graphs/route.ts — GET /api/graphs:
    ```typescript
    import { auth } from '@clerk/nextjs/server'
    import { NextResponse } from 'next/server'
    import { createSupabaseAdmin } from '@/lib/supabase'

    const supabase = createSupabaseAdmin()

    export async function GET() {
      const { userId } = await auth()
      if (!userId) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
      }

      const { data, error } = await supabase
        .from('graphs')
        .select('id, title, source_url, node_count, edge_count, neo4j_session_id, created_at')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })

      if (error) {
        return NextResponse.json({ error: error.message }, { status: 500 })
      }

      return NextResponse.json(data ?? [])
    }
    ```

    Create apps/web/app/api/graphs/[id]/route.ts — DELETE /api/graphs/[id]:
    ```typescript
    import { auth } from '@clerk/nextjs/server'
    import { NextResponse } from 'next/server'
    import { createSupabaseAdmin } from '@/lib/supabase'

    const supabase = createSupabaseAdmin()

    export async function DELETE(
      _req: Request,
      { params }: { params: Promise<{ id: string }> }
    ) {
      const { userId } = await auth()
      if (!userId) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
      }

      const { id } = await params

      // Ownership check: .eq('user_id', userId) prevents deleting other users' graphs
      const { error } = await supabase
        .from('graphs')
        .delete()
        .eq('id', id)
        .eq('user_id', userId)

      if (error) {
        return NextResponse.json({ error: error.message }, { status: 500 })
      }

      return NextResponse.json({ success: true })
    }
    ```

    Create apps/web/app/api/graphs/[id]/rename/route.ts — PATCH /api/graphs/[id]/rename:
    ```typescript
    import { auth } from '@clerk/nextjs/server'
    import { NextRequest, NextResponse } from 'next/server'
    import { createSupabaseAdmin } from '@/lib/supabase'

    const supabase = createSupabaseAdmin()

    export async function PATCH(
      req: NextRequest,
      { params }: { params: Promise<{ id: string }> }
    ) {
      const { userId } = await auth()
      if (!userId) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
      }

      const { id } = await params
      const { title } = await req.json() as { title?: string }

      if (!title || title.trim().length === 0) {
        return NextResponse.json({ error: 'Title cannot be empty' }, { status: 400 })
      }

      const { error } = await supabase
        .from('graphs')
        .update({ title: title.trim() })
        .eq('id', id)
        .eq('user_id', userId)  // Ownership check

      if (error) {
        return NextResponse.json({ error: error.message }, { status: 500 })
      }

      return NextResponse.json({ success: true })
    }
    ```

    Note on params: In Next.js 15+ App Router, dynamic route params are async (Promise). Always use `await params` before destructuring.
  </action>
  <verify>
    ```bash
    ls "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/api/graphs/route.ts" && ls "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/api/graphs/[id]/route.ts" && ls "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/api/graphs/[id]/rename/route.ts"
    ```
    All three Route Handler files exist.
  </verify>
  <done>GET /api/graphs returns user's graphs ordered by created_at desc. DELETE /api/graphs/[id] deletes own graph only (ownership check). PATCH /api/graphs/[id]/rename updates title with ownership check. All return 401 for unauthenticated requests. TypeScript compiles without error.</done>
</task>

<task type="auto">
  <name>Task 2: History page UI, HistoryCard component, trial modal, and trial wiring</name>
  <files>apps/web/app/app/history/page.tsx, apps/web/components/history/HistoryCard.tsx, apps/web/lib/trial.ts, apps/web/components/auth/TrialModal.tsx, apps/web/app/page.tsx</files>
  <action>
    Create apps/web/lib/trial.ts — localStorage trial utilities (SSR-safe):
    ```typescript
    export const TRIAL_KEY = 'graphvc_trial_used'

    export function isTrialUsed(): boolean {
      if (typeof window === 'undefined') return false  // SSR guard
      return localStorage.getItem(TRIAL_KEY) === 'true'
    }

    export function markTrialUsed(): void {
      if (typeof window === 'undefined') return
      localStorage.setItem(TRIAL_KEY, 'true')
    }
    ```

    Create apps/web/components/auth/TrialModal.tsx — sign-up prompt modal:
    ```typescript
    'use client'

    import Link from 'next/link'

    interface TrialModalProps {
      onDismiss: () => void
    }

    export default function TrialModal({ onDismiss }: TrialModalProps) {
      return (
        // Full-screen overlay
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-gray-950/80 backdrop-blur-sm px-4">
          <div className="bg-gray-900 border border-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 space-y-5">
            {/* Header */}
            <div className="space-y-2">
              <div className="w-10 h-10 rounded-xl bg-indigo-600/20 border border-indigo-500/30 flex items-center justify-center">
                <svg width="18" height="18" viewBox="0 0 20 20" fill="none" className="text-indigo-400">
                  <path d="M10 2a8 8 0 100 16A8 8 0 0010 2zm0 4v4m0 4h.01" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                </svg>
              </div>
              <h2 className="text-lg font-bold text-white">Free graph used</h2>
              <p className="text-sm text-gray-400 leading-relaxed">
                You&apos;ve used your free graph. Sign up to generate more — it only takes a few seconds.
              </p>
            </div>

            {/* Actions */}
            <div className="space-y-3">
              <Link
                href="/sign-up"
                className="flex items-center justify-center w-full px-4 py-3 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-500 transition-colors"
              >
                Sign Up — it&apos;s free
              </Link>
              <button
                onClick={onDismiss}
                className="w-full px-4 py-2.5 rounded-xl text-gray-400 text-sm hover:text-white hover:bg-gray-800/50 transition-colors"
              >
                Maybe Later
              </button>
            </div>
          </div>
        </div>
      )
    }
    ```

    Per CONTEXT.md: "Maybe Later dismisses the modal. The user can still view and interact with their already-generated graph, but the input stays disabled and blocked — no more free submissions."

    Create apps/web/components/history/HistoryCard.tsx — card component with inline rename:
    ```typescript
    'use client'

    import { useState, useRef } from 'react'
    import { useRouter } from 'next/navigation'
    import { toast } from 'sonner'

    interface GraphRow {
      id: string
      title: string
      source_url: string | null
      node_count: number
      edge_count: number
      neo4j_session_id: string
      created_at: string
    }

    interface HistoryCardProps {
      graph: GraphRow
      onDelete: (id: string) => void
      onRename: (id: string, title: string) => void
    }

    function relativeTime(dateStr: string): string {
      const diff = Date.now() - new Date(dateStr).getTime()
      const mins = Math.floor(diff / 60000)
      if (mins < 1) return 'just now'
      if (mins < 60) return `${mins} minute${mins === 1 ? '' : 's'} ago`
      const hours = Math.floor(mins / 60)
      if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`
      const days = Math.floor(hours / 24)
      return `${days} day${days === 1 ? '' : 's'} ago`
    }

    export default function HistoryCard({ graph, onDelete, onRename }: HistoryCardProps) {
      const router = useRouter()
      const [isEditing, setIsEditing] = useState(false)
      const [editTitle, setEditTitle] = useState(graph.title)
      const [isDeleting, setIsDeleting] = useState(false)
      const inputRef = useRef<HTMLInputElement>(null)

      // Per CONTEXT.md: clicking history card navigates to /app?session=<neo4j_session_id>
      const handleCardClick = () => {
        if (!isEditing) {
          router.push(`/app?session=${graph.neo4j_session_id}`)
        }
      }

      const handleTitleClick = (e: React.MouseEvent) => {
        e.stopPropagation()  // Don't navigate while editing title
        setIsEditing(true)
        setEditTitle(graph.title)
        setTimeout(() => inputRef.current?.select(), 10)
      }

      const handleRenameSubmit = async () => {
        const trimmed = editTitle.trim()
        if (!trimmed || trimmed === graph.title) {
          setIsEditing(false)
          setEditTitle(graph.title)
          return
        }

        try {
          const res = await fetch(`/api/graphs/${graph.id}/rename`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: trimmed }),
          })
          if (!res.ok) throw new Error('Failed to rename')
          onRename(graph.id, trimmed)
          setIsEditing(false)
        } catch {
          toast.error('Failed to rename graph')
          setEditTitle(graph.title)
          setIsEditing(false)
        }
      }

      const handleDelete = async (e: React.MouseEvent) => {
        e.stopPropagation()
        setIsDeleting(true)
        try {
          const res = await fetch(`/api/graphs/${graph.id}`, { method: 'DELETE' })
          if (!res.ok) throw new Error('Failed to delete')
          onDelete(graph.id)
        } catch {
          toast.error('Failed to delete graph')
          setIsDeleting(false)
        }
      }

      // Truncate source_url or show text preview label
      const preview = graph.source_url
        ? graph.source_url.replace(/^https?:\/\/(www\.)?/, '').slice(0, 50)
        : 'Text input'

      return (
        <div
          onClick={handleCardClick}
          className="group bg-gray-900 border border-gray-800 rounded-xl p-4 cursor-pointer hover:border-gray-700 hover:bg-gray-800/50 transition-all space-y-3"
        >
          {/* Title — click to edit inline */}
          <div onClick={handleTitleClick}>
            {isEditing ? (
              <input
                ref={inputRef}
                value={editTitle}
                onChange={(e) => setEditTitle(e.target.value)}
                onBlur={handleRenameSubmit}
                onKeyDown={(e) => {
                  if (e.key === 'Enter') handleRenameSubmit()
                  if (e.key === 'Escape') { setIsEditing(false); setEditTitle(graph.title) }
                }}
                onClick={(e) => e.stopPropagation()}
                className="w-full bg-gray-800 border border-indigo-500/50 rounded-lg px-2 py-1 text-sm font-semibold text-white outline-none focus:border-indigo-500"
                autoFocus
              />
            ) : (
              <h3 className="text-sm font-semibold text-white leading-tight line-clamp-2 hover:text-indigo-300 transition-colors">
                {graph.title}
              </h3>
            )}
          </div>

          {/* Source preview */}
          <p className="text-xs text-gray-500 truncate">{preview}</p>

          {/* Stats + timestamp + delete */}
          <div className="flex items-center justify-between gap-2">
            <div className="flex items-center gap-2">
              <span className="text-xs text-gray-400 bg-gray-800/60 px-2 py-0.5 rounded-full">
                {graph.node_count} nodes · {graph.edge_count} edges
              </span>
              <span className="text-xs text-gray-600">{relativeTime(graph.created_at)}</span>
            </div>

            {/* Delete button */}
            <button
              onClick={handleDelete}
              disabled={isDeleting}
              className="opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded-lg text-gray-600 hover:text-red-400 hover:bg-red-500/10"
              aria-label="Delete graph"
            >
              {isDeleting ? (
                <div className="w-3.5 h-3.5 border border-gray-500 border-t-transparent rounded-full animate-spin" />
              ) : (
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                  <path d="M2 4h12M6 4V2h4v2M5 4v9a1 1 0 001 1h4a1 1 0 001-1V4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                </svg>
              )}
            </button>
          </div>
        </div>
      )
    }
    ```

    Create apps/web/app/app/history/page.tsx — history page:
    ```typescript
    'use client'

    import { useEffect, useState } from 'react'
    import Link from 'next/link'
    import HistoryCard from '@/components/history/HistoryCard'

    interface GraphRow {
      id: string
      title: string
      source_url: string | null
      node_count: number
      edge_count: number
      neo4j_session_id: string
      created_at: string
    }

    export default function HistoryPage() {
      const [graphs, setGraphs] = useState<GraphRow[]>([])
      const [loading, setLoading] = useState(true)
      const [search, setSearch] = useState('')

      useEffect(() => {
        fetch('/api/graphs')
          .then((r) => r.json())
          .then((data) => { setGraphs(Array.isArray(data) ? data : []); setLoading(false) })
          .catch(() => setLoading(false))
      }, [])

      const filtered = graphs.filter((g) =>
        g.title.toLowerCase().includes(search.toLowerCase())
      )

      const handleDelete = (id: string) => setGraphs((prev) => prev.filter((g) => g.id !== id))
      const handleRename = (id: string, title: string) =>
        setGraphs((prev) => prev.map((g) => (g.id === id ? { ...g, title } : g)))

      return (
        <div className="min-h-screen bg-gray-950 text-gray-100">
          {/* Nav */}
          <nav className="border-b border-gray-800/60 bg-gray-950/90 backdrop-blur-sm sticky top-0 z-10">
            <div className="mx-auto max-w-5xl px-6 h-14 flex items-center justify-between">
              <Link href="/app" className="text-white font-bold text-base tracking-tight">
                GraphVC
              </Link>
              <Link href="/app" className="text-sm text-gray-400 hover:text-white transition-colors">
                ← Back to generator
              </Link>
            </div>
          </nav>

          <main className="mx-auto max-w-5xl px-6 py-10 space-y-6">
            {/* Header + search */}
            <div className="flex items-center justify-between gap-4">
              <h1 className="text-xl font-bold text-white">Graph History</h1>
              <input
                type="text"
                placeholder="Search graphs..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-600 outline-none focus:border-indigo-500/50 w-48"
              />
            </div>

            {/* Loading skeleton */}
            {loading && (
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {[...Array(6)].map((_, i) => (
                  <div key={i} className="bg-gray-900 border border-gray-800 rounded-xl p-4 space-y-3 animate-pulse">
                    <div className="h-4 bg-gray-800 rounded w-3/4" />
                    <div className="h-3 bg-gray-800 rounded w-1/2" />
                    <div className="h-3 bg-gray-800 rounded w-1/3" />
                  </div>
                ))}
              </div>
            )}

            {/* Empty state */}
            {!loading && filtered.length === 0 && (
              <div className="text-center py-16 space-y-3">
                <div className="w-12 h-12 mx-auto rounded-xl bg-gray-900 border border-gray-800 flex items-center justify-center">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" className="text-gray-600">
                    <path d="M10 3a7 7 0 100 14A7 7 0 0010 3zM7 10h6M10 7v6" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                  </svg>
                </div>
                <p className="text-gray-500 text-sm">
                  {search ? 'No graphs match your search' : 'No graphs yet — generate your first one'}
                </p>
                {!search && (
                  <Link href="/app" className="inline-block text-sm text-indigo-400 hover:text-indigo-300 transition-colors">
                    Generate a graph →
                  </Link>
                )}
              </div>
            )}

            {/* Card grid — 1 col mobile, 2 col tablet, 3 col desktop */}
            {!loading && filtered.length > 0 && (
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {filtered.map((graph) => (
                  <HistoryCard
                    key={graph.id}
                    graph={graph}
                    onDelete={handleDelete}
                    onRename={handleRename}
                  />
                ))}
              </div>
            )}
          </main>
        </div>
      )
    }
    ```

    Update apps/web/app/page.tsx — wire trial check to HeroSection. The landing page (/) is a Server Component — cannot add useState directly. The HeroSection component is client-side and handles the input. Modify HeroSection to check trial:

    Since HeroSection is already a client component (it handles input + graph generation), add trial check there. Import isTrialUsed, markTrialUsed, and TrialModal. Read the current HeroSection at apps/web/components/landing/HeroSection.tsx and add:
    1. `const [showTrialModal, setShowTrialModal] = useState(false)`
    2. Before calling generateGraph (or whatever the submit handler does), check: `if (isTrialUsed()) { setShowTrialModal(true); return }`
    3. After successful generation: `markTrialUsed()`
    4. Render TrialModal: `{showTrialModal && <TrialModal onDismiss={() => setShowTrialModal(false)} />}`

    Also: after "Maybe Later", the input on the landing page should appear disabled (per CONTEXT.md). Add: when showTrialModal has been dismissed (track with a `trialBlocked` state), keep input disabled.

    Note: apps/web/app/page.tsx itself does NOT need modification — the trial logic lives in the HeroSection client component. Read HeroSection.tsx before modifying to understand its current submit flow.
  </action>
  <verify>
    ```bash
    ls "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/api/graphs/route.ts" && ls "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/app/history/page.tsx" && ls "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/lib/trial.ts" && ls "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/components/auth/TrialModal.tsx"
    ```
    All key files exist.

    ```bash
    cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && pnpm --filter @graphvc/web typecheck 2>&1 | tail -5
    ```
    TypeScript compiles without error.
  </verify>
  <done>GET /api/graphs Route Handler returns user graphs. DELETE and PATCH rename handlers work with ownership checks. /app/history page has card grid (1/2/3 col responsive), search filter, loading skeleton, empty state, delete and inline rename. lib/trial.ts has isTrialUsed/markTrialUsed with SSR guards. TrialModal has "Sign Up" and "Maybe Later" buttons. HeroSection wires trial check: second anonymous submission shows modal. TypeScript compiles without error.</done>
</task>

</tasks>

<verification>
```bash
cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && pnpm --filter @graphvc/web typecheck 2>&1 | tail -5
```
TypeScript passes for all new files.

```bash
grep "graphvc_trial_used" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/lib/trial.ts" && grep "TrialModal" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/components/auth/TrialModal.tsx"
```
Trial utilities and modal component exist.

```bash
grep "neo4j_session_id" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/components/history/HistoryCard.tsx"
```
HistoryCard uses neo4j_session_id for /app?session= navigation.
</verification>

<success_criteria>
- /api/graphs GET (list), DELETE, PATCH rename Route Handlers all check ownership via auth()
- /app/history page: card grid (1/2/3 col), client-side search, loading skeleton, empty state
- HistoryCard: title click → inline rename (Enter/blur saves, Escape cancels), delete button (hover visible), click navigates to /app?session=neo4j_session_id, relative timestamps
- lib/trial.ts: isTrialUsed/markTrialUsed with SSR typeof window guard
- TrialModal: full-screen overlay, "Sign Up" → /sign-up, "Maybe Later" dismisses
- HeroSection: second anonymous submit shows TrialModal instead of generating; markTrialUsed() called after first success
- TypeScript compiles without error
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-persistence/03-05-SUMMARY.md` following the summary template.
</output>
