---
phase: 05-landing-page-observability
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/providers.tsx
  - apps/web/app/layout.tsx
  - apps/web/lib/analytics.ts
  - apps/web/app/app/page.tsx
autonomous: true
requirements:
  - OBS-02

must_haves:
  truths:
    - "A graph_generated event with node_count, edge_count, and source_type properties appears in PostHog after each successful graph generation"
    - "PostHog is initialized exactly once per client session and does not crash during SSR"
  artifacts:
    - path: "apps/web/app/providers.tsx"
      provides: "PostHogProvider client component — initializes posthog.init() on mount"
      contains: "posthog.init"
    - path: "apps/web/app/layout.tsx"
      provides: "Root layout wrapping children with PostHogProvider"
      contains: "PostHogProvider"
    - path: "apps/web/lib/analytics.ts"
      provides: "Typed PostHog capture helpers (captureGraphGenerated, captureGraphExported, captureGraphHistoryViewed)"
      contains: "captureGraphGenerated"
    - path: "apps/web/app/app/page.tsx"
      provides: "captureGraphGenerated call in handleSubmit success branch"
      contains: "captureGraphGenerated"
  key_links:
    - from: "apps/web/app/providers.tsx"
      to: "PostHog browser SDK"
      via: "posthog.init(NEXT_PUBLIC_POSTHOG_KEY, { api_host: 'https://us.i.posthog.com' })"
      pattern: "posthog\\.init"
    - from: "apps/web/app/layout.tsx"
      to: "apps/web/app/providers.tsx"
      via: "PostHogProvider wrapping {children}"
      pattern: "PostHogProvider"
    - from: "apps/web/app/app/page.tsx"
      to: "apps/web/lib/analytics.ts"
      via: "captureGraphGenerated(nodes.length, edges.length, sourceType)"
      pattern: "captureGraphGenerated"
---

<objective>
Wire PostHog analytics to the Next.js frontend with typed capture helpers and the graph_generated event.

Purpose: Provides the product visibility needed before launch — graph generation events fire to PostHog on every successful generate, enabling funnel analysis and usage monitoring.

Output: PostHogProvider in layout, typed analytics.ts helpers, captureGraphGenerated event firing in app page handleSubmit success branch.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/05-landing-page-observability/05-CONTEXT.md
@.planning/phases/05-landing-page-observability/05-RESEARCH.md
@apps/web/app/layout.tsx
@apps/web/app/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: PostHog provider and layout integration</name>
  <files>
    apps/web/app/providers.tsx
    apps/web/app/layout.tsx
  </files>
  <action>
**Step 1 — Install posthog-js:**
From `apps/web/`, run: `pnpm add posthog-js`

**Step 2 — Create `apps/web/app/providers.tsx`** (client component — MUST have 'use client'):
```typescript
'use client'

import posthog from 'posthog-js'
import { PostHogProvider as PHProvider } from 'posthog-js/react'
import { useEffect } from 'react'

export function PostHogProvider({ children }: { children: React.ReactNode }) {
  useEffect(() => {
    posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
      api_host: 'https://us.i.posthog.com',
      defaults: '2026-01-30',
      capture_pageview: false,  // App Router navigation not detected by legacy pageview tracker
    })
  }, [])

  return <PHProvider client={posthog}>{children}</PHProvider>
}
```

**CRITICAL:** `'use client'` directive is REQUIRED — `posthog-js` is a browser-only SDK. It accesses `window`, `document`, and `localStorage`. Calling posthog.init() without 'use client' causes SSR crash: "window is not defined".

**CRITICAL:** `capture_pageview: false` — App Router does not trigger legacy pageview detection. Disabling prevents double-counting and stale data.

**Step 3 — Update `apps/web/app/layout.tsx`** — wrap children with PostHogProvider:
- Add `import { PostHogProvider } from './providers'`
- Wrap `{children}` and `<Toaster ... />` inside `<PostHogProvider>...</PostHogProvider>`
- Keep all existing imports and code unchanged (Geist fonts, metadata, className, Toaster)

The resulting body should be:
```tsx
<body className={`${geistSans.variable} ${geistMono.variable} antialiased bg-gray-950 text-gray-100 min-h-screen`}>
  <PostHogProvider>
    {children}
    <Toaster richColors position="top-right" />
  </PostHogProvider>
</body>
```
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && pnpm --filter web exec tsc --noEmit 2>&1 | head -20</automated>
    <manual>Check providers.tsx has 'use client' directive as first line and exports PostHogProvider. Check layout.tsx imports PostHogProvider and wraps children.</manual>
  </verify>
  <done>TypeScript compiles clean. providers.tsx exports PostHogProvider with 'use client' + posthog.init() in useEffect. layout.tsx wraps children in PostHogProvider.</done>
</task>

<task type="auto">
  <name>Task 2: Analytics helpers and graph_generated event</name>
  <files>
    apps/web/lib/analytics.ts
    apps/web/app/app/page.tsx
  </files>
  <action>
**Step 1 — Create `apps/web/lib/analytics.ts`** (typed PostHog capture helpers):
```typescript
import posthog from 'posthog-js'

/**
 * OBS-02: Fires after successful graph generation.
 * Called in app/app/page.tsx handleSubmit success branch.
 */
export function captureGraphGenerated(
  nodeCount: number,
  edgeCount: number,
  sourceType: 'url' | 'text'
): void {
  posthog.capture('graph_generated', {
    node_count: nodeCount,
    edge_count: edgeCount,
    source_type: sourceType,
  })
}

/**
 * OBS-02: Fires when user exports a graph.
 * Called from export buttons (Phase 4 — EXP-01, EXP-02).
 */
export function captureGraphExported(format: 'json' | 'png'): void {
  posthog.capture('graph_exported', { format })
}

/**
 * OBS-02: Fires when user views their graph history.
 * Called from history page (Phase 3 — FE-03).
 */
export function captureGraphHistoryViewed(): void {
  posthog.capture('graph_history_viewed')
}
```

**CRITICAL:** This file imports `posthog-js` directly. It must ONLY be imported in `'use client'` components. Do NOT import it in Server Components — it will crash with "window is not defined".

**Step 2 — Update `apps/web/app/app/page.tsx`** — add captureGraphGenerated call in the handleSubmit success branch:

Read the current page.tsx first. Find the location where `setGraph(data.graph)` and `setStatus('success')` are called after a successful API response.

Add immediately after those state-setting calls:
```typescript
import { captureGraphGenerated } from '@/lib/analytics'

// In the success branch of handleSubmit, after setGraph(data.graph) and setStatus('success'):
captureGraphGenerated(
  data.graph.nodes.length,
  data.graph.edges.length,
  input.trim().startsWith('https://') || input.trim().startsWith('http://') ? 'url' : 'text'
)
```

The source_type detection mirrors the backend's source_type gate from STATE.md: `raw_input.strip().startswith('https://')` determines url vs text path.

Keep all other page.tsx logic (state machine, AbortController, toast handling) completely unchanged.
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && pnpm --filter web exec tsc --noEmit 2>&1 | head -20</automated>
    <manual>Check lib/analytics.ts exports captureGraphGenerated, captureGraphExported, captureGraphHistoryViewed. Check app/app/page.tsx imports captureGraphGenerated and calls it in the success branch after setGraph(data.graph).</manual>
  </verify>
  <done>TypeScript compiles clean. analytics.ts exports all three typed helpers. app/app/page.tsx calls captureGraphGenerated in the handleSubmit success branch with node_count, edge_count, and source_type arguments.</done>
</task>

</tasks>

<verification>
Run from repo root:
1. `pnpm --filter web exec tsc --noEmit` — TypeScript clean
2. Verify providers.tsx has 'use client' as first line
3. Verify layout.tsx has PostHogProvider wrapping children
4. Verify lib/analytics.ts exports captureGraphGenerated, captureGraphExported, captureGraphHistoryViewed
5. Verify app/app/page.tsx calls captureGraphGenerated in success branch
</verification>

<success_criteria>
- OBS-02: `posthog-js` installed in apps/web
- PostHogProvider client component created in app/providers.tsx with 'use client' directive
- Root layout wraps children in PostHogProvider
- lib/analytics.ts exports typed captureGraphGenerated(nodeCount, edgeCount, sourceType), captureGraphExported(format), captureGraphHistoryViewed()
- app/app/page.tsx fires captureGraphGenerated after every successful graph generation
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/05-landing-page-observability/05-02-SUMMARY.md`
</output>
