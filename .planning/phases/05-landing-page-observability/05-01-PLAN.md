---
phase: 05-landing-page-observability
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/next.config.ts
  - apps/web/instrumentation-client.ts
  - apps/web/instrumentation.ts
  - apps/web/sentry.server.config.ts
  - apps/web/app/global-error.tsx
  - apps/api/app/config.py
  - apps/api/app/main.py
  - apps/api/pyproject.toml
autonomous: true
requirements:
  - SEC-05
  - OBS-01

must_haves:
  truths:
    - "Every page response includes X-Frame-Options: SAMEORIGIN, X-Content-Type-Options: nosniff, X-XSS-Protection: 1; mode=block, and a Content Security Policy header"
    - "An uncaught exception in the Next.js frontend appears in the Sentry dashboard with user context"
    - "A 5xx error in the FastAPI backend appears in the Sentry dashboard with user context"
  artifacts:
    - path: "apps/web/next.config.ts"
      provides: "Security headers via headers() + Sentry withSentryConfig wrapper + existing rewrites"
      contains: "X-Frame-Options"
    - path: "apps/web/instrumentation-client.ts"
      provides: "Sentry browser SDK init for Next.js App Router"
      contains: "Sentry.init"
    - path: "apps/web/instrumentation.ts"
      provides: "Sentry server-side init hook"
      contains: "registerOTel"
    - path: "apps/web/sentry.server.config.ts"
      provides: "Sentry server config"
      contains: "Sentry.init"
    - path: "apps/web/app/global-error.tsx"
      provides: "Sentry error boundary for unhandled React errors"
      contains: "Sentry.captureException"
    - path: "apps/api/app/config.py"
      provides: "sentry_dsn and environment settings fields"
      contains: "sentry_dsn"
    - path: "apps/api/app/main.py"
      provides: "sentry_sdk.init() called before app = FastAPI()"
      contains: "sentry_sdk.init"
  key_links:
    - from: "apps/web/next.config.ts"
      to: "security headers on every response"
      via: "headers() function with source: '/(.*)', applied via withSentryConfig export"
      pattern: "X-Frame-Options"
    - from: "apps/api/app/main.py"
      to: "Sentry error capture"
      via: "sentry_sdk.init() at module level before app = FastAPI()"
      pattern: "sentry_sdk\\.init"
    - from: "apps/web/instrumentation-client.ts"
      to: "Sentry browser error capture"
      via: "Sentry.init with NEXT_PUBLIC_SENTRY_DSN"
      pattern: "Sentry\\.init"
---

<objective>
Wire security headers and Sentry error tracking for both frontend and backend.

Purpose: Hardens every page response with SEC-05 security headers, and instruments both the Next.js frontend and FastAPI backend with Sentry so uncaught exceptions surface in the dashboard before public traffic arrives.

Output: next.config.ts with security headers + withSentryConfig, Sentry instrumentation files for Next.js App Router, Sentry SDK init in FastAPI before app instantiation.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-landing-page-observability/05-CONTEXT.md
@.planning/phases/05-landing-page-observability/05-RESEARCH.md
@apps/web/next.config.ts
@apps/web/app/layout.tsx
@apps/api/app/main.py
@apps/api/app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Security headers + Sentry Next.js wiring</name>
  <files>
    apps/web/next.config.ts
    apps/web/instrumentation-client.ts
    apps/web/instrumentation.ts
    apps/web/sentry.server.config.ts
    apps/web/app/global-error.tsx
  </files>
  <action>
**Step 1 — Install Sentry:**
From `apps/web/`, run: `pnpm add @sentry/nextjs`

**Step 2 — Create `apps/web/instrumentation-client.ts`** (Sentry browser init for App Router):
```typescript
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  sendDefaultPii: true,
})
```

**Step 3 — Create `apps/web/instrumentation.ts`** (server-side Sentry init, required by Next.js App Router):
```typescript
export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await import('./sentry.server.config')
  }
}
```

**Step 4 — Create `apps/web/sentry.server.config.ts`**:
```typescript
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  tracesSampleRate: 0.1,
  sendDefaultPii: true,
})
```

**Step 5 — Create `apps/web/app/global-error.tsx`** (catches unhandled React render errors in App Router):
```typescript
'use client'
import * as Sentry from '@sentry/nextjs'
import { useEffect } from 'react'

export default function GlobalError({ error, reset }: { error: Error & { digest?: string }; reset: () => void }) {
  useEffect(() => {
    Sentry.captureException(error)
  }, [error])

  return (
    <html lang="en" className="dark">
      <body className="bg-gray-950 text-gray-100 min-h-screen flex items-center justify-center">
        <div className="text-center">
          <h2 className="text-xl font-semibold mb-4">Something went wrong</h2>
          <button
            onClick={reset}
            className="px-4 py-2 bg-indigo-600 rounded-md text-sm hover:bg-indigo-700"
          >
            Try again
          </button>
        </div>
      </body>
    </html>
  )
}
```

**Step 6 — Update `apps/web/next.config.ts`**:
Replace existing content entirely. Preserve existing `transpilePackages` and `rewrites()` config. Add:
- `securityHeaders` array with all four required headers (X-Frame-Options, X-Content-Type-Options, X-XSS-Protection, Content-Security-Policy)
- `headers()` function returning `source: '/(.*)'` with `securityHeaders`
- Wrap export with `withSentryConfig(nextConfig, { ... })`

CSP directives (per research — Sentry uses tunnelRoute so `connect-src` only needs PostHog hosts + self):
```typescript
import type { NextConfig } from 'next'
import { withSentryConfig } from '@sentry/nextjs'

const isDev = process.env.NODE_ENV === 'development'

const securityHeaders = [
  { key: 'X-Frame-Options', value: 'SAMEORIGIN' },
  { key: 'X-Content-Type-Options', value: 'nosniff' },
  { key: 'X-XSS-Protection', value: '1; mode=block' },
  {
    key: 'Content-Security-Policy',
    value: [
      "default-src 'self'",
      `script-src 'self' 'unsafe-inline'${isDev ? " 'unsafe-eval'" : ''}`,
      "style-src 'self' 'unsafe-inline'",
      "connect-src 'self' https://us.i.posthog.com https://us-assets.i.posthog.com",
      "img-src 'self' blob: data:",
      "font-src 'self'",
      "object-src 'none'",
      "base-uri 'self'",
      "form-action 'self'",
      "frame-ancestors 'self'",
    ].join('; '),
  },
]

const nextConfig: NextConfig = {
  transpilePackages: ['@graphvc/shared-types'],
  async headers() {
    return [{ source: '/(.*)', headers: securityHeaders }]
  },
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: `${process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:8000'}/api/:path*`,
      },
    ]
  },
}

export default withSentryConfig(nextConfig, {
  org: process.env.SENTRY_ORG,
  project: process.env.SENTRY_PROJECT,
  authToken: process.env.SENTRY_AUTH_TOKEN,
  tunnelRoute: '/monitoring',
  silent: !process.env.CI,
  disableLogger: true,
})
```

**CRITICAL:** `tunnelRoute: '/monitoring'` routes Sentry events through Next.js itself — prevents CSP blocking without adding sentry.io to connect-src. Do NOT add sentry.io domains to connect-src when tunnelRoute is configured.

**CRITICAL:** Do NOT create `proxy.ts` or `middleware.ts` for security headers. Headers via `next.config.ts headers()` is the correct approach per research — no per-request file needed.
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && pnpm --filter web exec tsc --noEmit 2>&1 | head -20</automated>
    <manual>Check that next.config.ts exports withSentryConfig wrapper and securityHeaders array contains all four required header keys.</manual>
  </verify>
  <done>TypeScript compiles clean in apps/web. next.config.ts exports withSentryConfig(nextConfig, ...) and securityHeaders array contains X-Frame-Options, X-Content-Type-Options, X-XSS-Protection, and Content-Security-Policy keys.</done>
</task>

<task type="auto">
  <name>Task 2: Sentry FastAPI backend init</name>
  <files>
    apps/api/app/config.py
    apps/api/app/main.py
    apps/api/pyproject.toml
  </files>
  <action>
**Step 1 — Install sentry-sdk:**
From `apps/api/`, run: `uv pip install 'sentry-sdk[fastapi]'`
Then add to `apps/api/pyproject.toml` dependencies: `sentry-sdk[fastapi]>=2.0`

**Step 2 — Update `apps/api/app/config.py`** — add `sentry_dsn` and `environment` fields:
```python
from pydantic_settings import BaseSettings


class Settings(BaseSettings):
    openai_api_key: str
    neo4j_uri: str = "bolt://localhost:7687"
    neo4j_username: str = "neo4j"
    neo4j_password: str
    clerk_secret_key: str = ""
    clerk_authorized_party: str = ""
    clerk_frontend_api: str = ""
    # Dev-only: skip Clerk JWT validation. Never set in production.
    dev_skip_auth: bool = False
    # Observability (Phase 5)
    sentry_dsn: str = ""
    environment: str = "development"

    model_config = {"env_file": ".env"}


settings = Settings()
```

`sentry_dsn` defaults to `""` — if empty, Sentry init is skipped (prevents errors in dev without a DSN set).

**Step 3 — Update `apps/api/app/main.py`** — add sentry_sdk.init() at module level BEFORE `app = FastAPI(...)`:
```python
import sentry_sdk
from sentry_sdk.integrations.starlette import StarletteIntegration
from sentry_sdk.integrations.fastapi import FastApiIntegration
from contextlib import asynccontextmanager
from fastapi import FastAPI
from neo4j import GraphDatabase
from app.config import settings
from app.generate.router import router as generate_router

# Sentry must be initialized before app = FastAPI() — patches request handling at import time
# Only init if DSN is configured (allows dev without Sentry credentials)
if settings.sentry_dsn:
    sentry_sdk.init(
        dsn=settings.sentry_dsn,
        traces_sample_rate=0.1,
        send_default_pii=True,
        environment=settings.environment,
        integrations=[
            StarletteIntegration(),
            FastApiIntegration(),
        ],
    )
```

Keep all existing lifespan and route code unchanged below this block.

**CRITICAL:** BOTH `StarletteIntegration()` AND `FastApiIntegration()` must be listed — FastAPI sits on top of Starlette and both layers need coverage. Omitting StarletteIntegration causes middleware-level errors to be missed.

**CRITICAL:** sentry_sdk.init() must be called BEFORE `app = FastAPI(lifespan=lifespan)` — Sentry patches request handling at import time; calling after app creation means the initial request handling is unpatched.
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/api" && uv run python -c "from app.main import app; print('Sentry init OK')"</automated>
    <manual>Confirm apps/api/app/main.py has sentry_sdk.init() call before the app = FastAPI(...) line. Confirm config.py has sentry_dsn field with empty default.</manual>
  </verify>
  <done>Python import succeeds. main.py has sentry_sdk.init() block before app = FastAPI(). config.py has sentry_dsn: str = "" field. Existing tests still pass: `uv run pytest apps/api/tests/ -x -q` returns no failures.</done>
</task>

</tasks>

<verification>
Run from repo root:
1. `pnpm --filter web exec tsc --noEmit` — TypeScript clean
2. `cd apps/api && uv run pytest tests/ -x -q` — backend tests pass
3. Manually inspect next.config.ts: contains `withSentryConfig` wrapping export, `headers()` function with all four security header keys
4. Manually inspect apps/api/app/main.py: sentry_sdk.init() appears before `app = FastAPI`
</verification>

<success_criteria>
- SEC-05: `next.config.ts headers()` returns X-Frame-Options, X-Content-Type-Options, X-XSS-Protection, and Content-Security-Policy on source `/(.*)`
- OBS-01 (frontend): `@sentry/nextjs` installed, `instrumentation-client.ts` + `instrumentation.ts` + `sentry.server.config.ts` + `global-error.tsx` created, `withSentryConfig` wraps next.config.ts export
- OBS-01 (backend): `sentry-sdk[fastapi]` installed, `sentry_sdk.init()` with both StarletteIntegration and FastApiIntegration runs at module load before `app = FastAPI()`
- All existing backend tests continue to pass
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/05-landing-page-observability/05-01-SUMMARY.md`
</output>
