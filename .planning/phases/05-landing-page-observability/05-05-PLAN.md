---
phase: 05-landing-page-observability
plan: "05"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/providers.tsx
autonomous: true
requirements: [OBS-02]
gap_closure: true

must_haves:
  truths:
    - "No console.error fires on page load when NEXT_PUBLIC_POSTHOG_KEY is absent or empty"
    - "PostHog initializes normally when NEXT_PUBLIC_POSTHOG_KEY is present"
  artifacts:
    - path: "apps/web/app/providers.tsx"
      provides: "PostHogProvider with conditional guard around posthog.init()"
      contains: "if (process.env.NEXT_PUBLIC_POSTHOG_KEY)"
  key_links:
    - from: "apps/web/app/providers.tsx"
      to: "posthog.init()"
      via: "conditional env var check"
      pattern: "if\\s*\\(process\\.env\\.NEXT_PUBLIC_POSTHOG_KEY\\)"
---

<objective>
Fix the PostHog initialization guard so that posthog.init() is only called when
NEXT_PUBLIC_POSTHOG_KEY is defined and non-empty. This silences the console.error
"PostHog was initialized without a token" that fires on every page load in
development and any environment without the env var set.

Purpose: UAT Gap 1 (minor) — removes noisy console.error that masks real errors
Output: apps/web/app/providers.tsx with conditional posthog.init() guard
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/app/providers.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conditional guard to posthog.init()</name>
  <files>apps/web/app/providers.tsx</files>
  <action>
    In apps/web/app/providers.tsx, wrap the posthog.init() call with a runtime
    guard so it only executes when the env var is present and non-empty.

    Replace the existing useEffect body:

    ```ts
    useEffect(() => {
      posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
        api_host: 'https://us.i.posthog.com',
        defaults: '2026-01-30',
        capture_pageview: false,
      })
    }, [])
    ```

    With:

    ```ts
    useEffect(() => {
      if (process.env.NEXT_PUBLIC_POSTHOG_KEY) {
        posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY, {
          api_host: 'https://us.i.posthog.com',
          defaults: '2026-01-30',
          capture_pageview: false,
        })
      }
    }, [])
    ```

    - Remove the TypeScript non-null assertion operator (!) — the conditional
      guard makes it redundant and the string is narrowed to a non-undefined
      value inside the if block.
    - Do NOT change any other part of the file (PHProvider, import statements,
      or the component return).
    - The guard uses truthiness check (not !== undefined) — this also filters
      out empty string '', which posthog would reject the same way.
  </action>
  <verify>
    <automated>cd "/Users/uzi/Documents/Git Projects/instagraph-vc" && grep -n "if (process.env.NEXT_PUBLIC_POSTHOG_KEY)" apps/web/app/providers.tsx</automated>
    <manual>Start the dev server without NEXT_PUBLIC_POSTHOG_KEY set: `pnpm dev` from repo root, visit http://localhost:3000 in browser, open DevTools Console — confirm no "PostHog was initialized without a token" error appears.</manual>
  </verify>
  <done>
    providers.tsx contains `if (process.env.NEXT_PUBLIC_POSTHOG_KEY)` guard.
    The TypeScript ! operator is gone.
    No console.error fires when the key is absent.
    PostHog still initializes when the key is present (logic unchanged inside the guard).
  </done>
</task>

</tasks>

<verification>
grep -n "if (process.env.NEXT_PUBLIC_POSTHOG_KEY)" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/providers.tsx"
# Must return a match on the conditional line

grep -n "POSTHOG_KEY!" "/Users/uzi/Documents/Git Projects/instagraph-vc/apps/web/app/providers.tsx"
# Must return NO results (! operator removed)
</verification>

<success_criteria>
- providers.tsx wraps posthog.init() in `if (process.env.NEXT_PUBLIC_POSTHOG_KEY)`
- The non-null assertion (!) is removed from the env var reference
- No other lines in providers.tsx are modified
- UAT Gap 1 (PostHog console.error) is closed
</success_criteria>

<output>
After completion, create `.planning/phases/05-landing-page-observability/05-05-SUMMARY.md`
</output>
